name: ðŸ§ª Pre-prod (PR Lifecycle)

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Recaptcha Key from local .env
        id: vars
        run: |
          # On cherche la ligne dans ton .env de staging et on extrait la valeur aprÃ¨s le '='
          # Le -f2- permet de gÃ©rer les cas oÃ¹ la clÃ© contiendrait elle-mÃªme un signe '='
          STR_KEY=$(grep '^NEXT_PUBLIC_RECAPTCHA_SITE_KEY=' /home/erickdesmet/STAGING_SAAS/FitMyCV/app/.env | cut -d '=' -f2-)
          echo "RECAPTCHA_KEY=$STR_KEY" >> $GITHUB_ENV

      - name: Clone DB (Prod -> Release)
        run: |
          pg_dump fitmycv_prod > /tmp/prod_sync.sql
          psql -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'fitmycv_release' AND pid <> pg_backend_pid();" postgres || true
          dropdb --if-exists fitmycv_release
          createdb fitmycv_release
          psql fitmycv_release < /tmp/prod_sync.sql

      - name: Docker Build
        run: |
          # On passe la clÃ© extraite comme argument de build
          docker build \
            --build-arg NEXT_PUBLIC_RECAPTCHA_SITE_KEY="${{ env.RECAPTCHA_KEY }}" \
            -t fitmycv:preview .

      - name: Deploy via Docker Compose (Staging)
        run: |
          cd /home/erickdesmet/STAGING_SAAS/FitMyCV/app
          docker compose -f docker-compose.staging.yml up -d --force-recreate
          # Attente de l'initialisation pour Ã©viter que les migrations Ã©chouent si le container boot
          sleep 10

      - name: Post-deploy (Migrations)
        run: |
          docker exec fitmycv-preview npm run db:migrate-deploy
          docker exec fitmycv-preview npm run db:migrate-data

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: self-hosted
    steps:
      - name: Stop Staging Server
        run: |
          echo "Fermeture de la PR dÃ©tectÃ©e. ArrÃªt du serveur de test..."
          cd /home/erickdesmet/STAGING_SAAS/FitMyCV/app
          docker compose -f docker-compose.staging.yml down
