name: ðŸ§ª Pre-prod (PR Lifecycle)

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Public Config from local .env
        id: vars
        run: |
          # On extrait les 3 clÃ©s critiques pour le build frontend
          RECAPTCHA=$(grep '^NEXT_PUBLIC_RECAPTCHA_SITE_KEY=' /home/erickdesmet/STAGING_SAAS/FitMyCV/app/.env | cut -d '=' -f2-)
          STRIPE_PK=$(grep '^NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=' /home/erickdesmet/STAGING_SAAS/FitMyCV/app/.env | cut -d '=' -f2-)
          
          # On force l'URL de staging pour que Stripe et l'Auth ne pointent pas vers la prod
          echo "RECAPTCHA_KEY=$RECAPTCHA" >> $GITHUB_ENV
          echo "STRIPE_PK=$STRIPE_PK" >> $GITHUB_ENV
          echo "APP_URL=https://dev.fitmycv.io" >> $GITHUB_ENV

      - name: Clone DB (Prod -> Release)
        run: |
          # Clone standard
          pg_dump fitmycv_prod > /tmp/prod_sync.sql
          psql -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'fitmycv_release' AND pid <> pg_backend_pid();" postgres || true
          dropdb --if-exists fitmycv_release
          createdb fitmycv_release
          psql fitmycv_release < /tmp/prod_sync.sql
          
          # Nettoyage des clients de prod (impÃ©ratif)
          psql fitmycv_release -c "UPDATE \"User\" SET \"stripeCustomerId\" = NULL;"

      - name: Auto-Sync Stripe Products (via existing script)
        run: |
          cd /home/erickdesmet/STAGING_SAAS/FitMyCV/app
          
          # 1. On rÃ©cupÃ¨re la DATABASE_URL de base pour avoir le user/pass, 
          # mais on remplace le nom de la base par fitmycv_release Ã  la volÃ©e
          RAW_DB_URL=$(grep '^DATABASE_URL=' .env | cut -d '=' -f2- | tr -d '"')
          # On remplace la fin de l'URL par /fitmycv_release
          export DATABASE_URL="${RAW_DB_URL%/*}/fitmycv_release"
          
          # 2. On rÃ©cupÃ¨re la clÃ© Stripe
          export STRIPE_SECRET_KEY=$(grep '^STRIPE_SECRET_KEY=' .env | cut -d '=' -f2- | tr -d '"')
          
          # 3. On lance le script
          node scripts/sync-stripe.js

      - name: Docker Build
        run: |
          # On injecte les variables publiques pour que Next.js les "cuise" dans le JS
          docker build \
            --build-arg NEXT_PUBLIC_RECAPTCHA_SITE_KEY="${{ env.RECAPTCHA_KEY }}" \
            --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="${{ env.STRIPE_PK }}" \
            --build-arg NEXT_PUBLIC_SITE_URL="${{ env.APP_URL }}" \
            --build-arg NEXT_PUBLIC_APP_URL="${{ env.APP_URL }}" \
            -t fitmycv:preview .

      - name: Deploy via Docker Compose (Staging)
        run: |
          cd /home/erickdesmet/STAGING_SAAS/FitMyCV/app
          docker compose -f docker-compose.staging.yml up -d --force-recreate
          sleep 10

      - name: Post-deploy (Migrations)
        run: |
          docker exec fitmycv-preview npm run db:migrate-deploy
          docker exec fitmycv-preview npm run db:migrate-data
