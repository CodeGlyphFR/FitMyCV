<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion CV | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <!-- Sidebar injectée par layout.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="main">
      <!-- Header injecté par layout.js -->
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Gestion CV</span>
        </div>

        <h1>Gestion CV</h1>
        <p class="lead">
          Le systeme de gestion CV permet de creer, modifier, stocker et versionner les CV au format JSON.
          Les donnees sont stockees dans PostgreSQL via Prisma (modele <code>CvFile</code>), avec un historique
          de versions dans <code>CvVersion</code>. La validation utilise AJV contre un JSON Schema centralisé
          (<code>data/schema.json</code>).
        </p>

        <h2>Architecture du Systeme CV</h2>

        <div class="diagram">
          <div class="diagram-title">Flux de gestion des CV</div>
          <div class="mermaid">
flowchart TD
    Manual["Creation manuelle<br/><code>POST /api/cvs/create</code>"]
    Import["Import PDF<br/><code>GPT-4o Vision</code>"]
    Generate["Generation IA<br/><code>Pipeline generate-cv</code>"]
    Extension["Extension navigateur<br/><code>Markdown pre-extrait</code>"]

    Validate["Validation AJV<br/><code>data/schema.json</code>"]
    Storage[("CvFile<br/>PostgreSQL")]
    Version[("CvVersion<br/>Historique")]

    Edit["Edition manuelle"]
    Optimize["Optimisation IA"]
    Translate["Traduction"]
    Review["Review changes"]
    Export["Export"]

    PDF["PDF<br/>(Puppeteer)"]
    Preview["Preview HTML"]

    Manual --> Validate
    Import --> Validate
    Generate --> Validate
    Extension --> Generate
    Validate --> Storage
    Storage --> Version
    Storage --> Edit
    Storage --> Optimize
    Storage --> Translate
    Optimize --> Review
    Storage --> Export
    Export --> PDF
    Export --> Preview
          </div>
        </div>

        <h2>Structure JSON d'un CV</h2>

        <p>
          Chaque CV est stocke au format JSON avec <strong>8 sections</strong> standardisees. Les metadonnees
          (langue, source, scores) sont stockees dans les colonnes <code>CvFile</code>, pas dans le JSON.
        </p>

        <pre><code class="language-json">{
  "language": "fr",
  "header": {
    "full_name": "Jean Dupont",
    "current_title": "Developpeur Full Stack Senior",
    "contact": {
      "email": "jean.dupont@email.com",
      "phone": "+33 6 12 34 56 78",
      "links": [
        { "label": "LinkedIn", "url": "https://linkedin.com/in/jeandupont" },
        { "label": "Portfolio", "url": "https://jeandupont.dev" }
      ],
      "location": {
        "city": "Paris",
        "region": "Ile-de-France",
        "country_code": "FR"
      }
    }
  },
  "summary": {
    "description": "Developpeur Full Stack avec 5 ans d'experience..."
  },
  "skills": {
    "hard_skills": [
      { "name": "Backend development", "proficiency": 4 },
      { "name": "API Design", "proficiency": 5 }
    ],
    "tools": [
      { "name": "React", "proficiency": 5 },
      { "name": "Node.js", "proficiency": 4 }
    ],
    "methodologies": ["Agile", "CI/CD", "TDD"],
    "soft_skills": ["Leadership", "Communication"]
  },
  "experience": [
    {
      "title": "Lead Developer",
      "company": "TechCorp",
      "department_or_client": "Equipe Produit",
      "start_date": "2021-03",
      "end_date": "",
      "location": { "city": "Paris", "country_code": "FR" },
      "description": "Direction technique...",
      "responsibilities": [
        "Conception architecture microservices",
        "Encadrement equipe de 5 developpeurs"
      ],
      "deliverables": ["Migration AWS", "Refonte API v2"],
      "skills_used": ["Node.js", "React", "PostgreSQL"]
    }
  ],
  "education": [
    {
      "institution": "Ecole Polytechnique",
      "degree": "Master",
      "field_of_study": "Informatique",
      "start_date": "2014-09",
      "end_date": "2019-06",
      "location": { "city": "Palaiseau", "country_code": "FR" }
    }
  ],
  "languages": [
    { "name": "Francais", "level": "Natif" },
    { "name": "Anglais", "level": "Courant (TOEIC 950)" }
  ],
  "extras": [
    { "name": "Certifications", "summary": "AWS Solutions Architect" },
    { "name": "Benevolat", "summary": "Coach Code for Kids" }
  ],
  "projects": [
    {
      "name": "E-commerce Platform",
      "role": "Lead Developer",
      "start_date": "2023-01",
      "end_date": "2023-06",
      "summary": "Plateforme e-commerce avec paiement Stripe",
      "tech_stack": ["Next.js", "Prisma", "Stripe"],
      "url": "https://github.com/user/project",
      "url_label": "GitHub"
    }
  ],
  "order_hint": ["summary", "skills", "experience", "education", "languages", "extras", "projects"],
  "section_titles": {
    "summary": "Profil",
    "skills": "Competences",
    "experience": "Experience professionnelle",
    "education": "Formation",
    "languages": "Langues",
    "extras": "Informations complementaires",
    "projects": "Projets"
  }
}</code></pre>

        <h2>Modeles de Donnees (Prisma)</h2>

        <table>
          <thead>
            <tr>
              <th>Modele</th>
              <th>Description</th>
              <th>Champs principaux</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>CvFile</code></td>
              <td>CV principal (JSON + metadonnees)</td>
              <td>
                <code>id</code> (cuid), <code>userId</code>, <code>filename</code>, <code>content</code> (Json),
                <code>contentVersion</code> (Int), <code>sourceType</code>, <code>sourceValue</code>,
                <code>jobOfferId</code>, <code>jobOfferSnapshot</code> (Json),
                <code>createdBy</code>, <code>isTranslated</code>, <code>language</code>,
                <code>matchScore</code>, <code>scoreBefore</code>, <code>scoreBreakdown</code>,
                <code>matchScoreStatus</code>, <code>optimiseStatus</code>,
                <code>blocked</code>, <code>pendingChanges</code> (Json),
                <code>createdAt</code>, <code>updatedAt</code>
              </td>
            </tr>
            <tr>
              <td><code>CvVersion</code></td>
              <td>Historique des versions (optimisation IA)</td>
              <td>
                <code>id</code> (cuid), <code>cvFileId</code>, <code>version</code> (Int),
                <code>content</code> (Json), <code>changelog</code>, <code>changeType</code>,
                <code>sourceFile</code>, <code>matchScore</code>, <code>scoreBreakdown</code>,
                <code>createdAt</code>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-info">
          <div class="callout-title">Contrainte unique</div>
          <p>
            <code>CvFile</code> : <code>@@unique([userId, filename])</code> — un utilisateur ne peut pas avoir deux CV avec le meme nom de fichier.<br>
            <code>CvVersion</code> : <code>@@unique([cvFileId, version])</code> — une seule entree par numero de version et par CV.
          </p>
        </div>

        <h2>Couche de Stockage</h2>

        <p>
          Le module <code>lib/cv-core/storage.js</code> fournit une API de haut niveau pour les operations
          CRUD sur les CV. Il a ete migre depuis le systeme de fichiers vers PostgreSQL, en conservant
          les signatures d'origine pour la compatibilite.
        </p>

        <table>
          <thead>
            <tr>
              <th>Fonction</th>
              <th>Signature</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>listUserCvFiles</code></td>
              <td><code>(userId) → string[]</code></td>
              <td>Liste tous les noms de fichiers CV (tries par date desc)</td>
            </tr>
            <tr>
              <td><code>readUserCvFile</code></td>
              <td><code>(userId, filename) → string</code></td>
              <td>Lit le contenu JSON stringifie d'un CV</td>
            </tr>
            <tr>
              <td><code>readUserCvFileWithMeta</code></td>
              <td><code>(userId, filename) → {content, language, contentVersion, createdAt, updatedAt}</code></td>
              <td>Lit le CV avec ses metadonnees DB</td>
            </tr>
            <tr>
              <td><code>writeUserCvFile</code></td>
              <td><code>(userId, filename, content) → string</code></td>
              <td>Ecrit/upsert le contenu (sanitise les null bytes)</td>
            </tr>
            <tr>
              <td><code>cvFileExists</code></td>
              <td><code>(userId, filename) → boolean</code></td>
              <td>Verifie l'existence d'un CV</td>
            </tr>
            <tr>
              <td><code>deleteUserCvFile</code></td>
              <td><code>(userId, filename) → boolean</code></td>
              <td>Supprime un CV (retourne false si inexistant)</td>
            </tr>
            <tr>
              <td><code>detectNewFiles</code></td>
              <td><code>(userId, before) → string[]</code></td>
              <td>Detecte les nouveaux fichiers crees depuis une liste de reference</td>
            </tr>
          </tbody>
        </table>

        <h2>Validation</h2>

        <p>
          La validation utilise <strong>AJV</strong> (pas Zod) avec un JSON Schema centralisé dans <code>data/schema.json</code>.
          Le schema est charge et compile une seule fois (mise en cache).
        </p>

        <pre><code class="language-javascript">// lib/cv-core/validation.js
import Ajv from 'ajv';
import addFormats from 'ajv-formats';

async function loadSchema() {
  const schemaPath = path.join(process.cwd(), 'data', 'schema.json');
  const schemaRaw = await fs.readFile(schemaPath, 'utf-8');
  return JSON.parse(schemaRaw);
}

export async function validateCv(cv) {
  const validate = await getValidator();
  const valid = !!validate(cv);
  const errors = valid ? [] : (validate.errors || []);
  return { valid, errors };
}</code></pre>

        <h2>API Endpoints CV</h2>

        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Methode</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/api/cvs</code></td>
              <td><span class="data-flow-badge input">GET</span></td>
              <td>Lister tous les CV de l'utilisateur (avec metadonnees, tri, cookie <code>cvFile</code>)</td>
            </tr>
            <tr>
              <td><code>/api/cvs/create</code></td>
              <td><span class="data-flow-badge process">POST</span></td>
              <td>Creer un CV vide (full_name, current_title, email)</td>
            </tr>
            <tr>
              <td><code>/api/cvs/read</code></td>
              <td><span class="data-flow-badge input">GET</span></td>
              <td>Lire le contenu d'un CV (<code>?file=xxx.json</code>)</td>
            </tr>
            <tr>
              <td><code>/api/cvs/delete</code></td>
              <td><span class="data-flow-badge process">POST</span></td>
              <td>Supprimer un CV (retourne <code>nextFile</code>)</td>
            </tr>
            <tr>
              <td><code>/api/cvs/delete-bulk</code></td>
              <td><span class="data-flow-badge process">POST</span></td>
              <td>Suppression en masse de plusieurs CV</td>
            </tr>
            <tr>
              <td><code>/api/cvs/versions</code></td>
              <td><span class="data-flow-badge input">GET</span></td>
              <td>Lister les versions (<code>?file=</code>, <code>?version=</code>, <code>?includeContent=</code>)</td>
            </tr>
            <tr>
              <td><code>/api/cvs/versions</code></td>
              <td><span class="data-flow-badge process">POST</span></td>
              <td>Restaurer une version (destructif)</td>
            </tr>
            <tr>
              <td><code>/api/cvs/restore</code></td>
              <td><span class="data-flow-badge process">POST</span></td>
              <td>Restaurer avec sauvegarde de la version courante</td>
            </tr>
            <tr>
              <td><code>/api/cvs/changes</code></td>
              <td><span class="data-flow-badge input">GET</span> / <span class="data-flow-badge process">POST</span></td>
              <td>Review des modifications IA (lire/accepter/rejeter)</td>
            </tr>
            <tr>
              <td><code>/api/cv/match-score</code></td>
              <td><span class="data-flow-badge process">POST</span> / <span class="data-flow-badge input">GET</span></td>
              <td>Calculer / recuperer le match score CV↔offre</td>
            </tr>
            <tr>
              <td><code>/api/cv/source</code></td>
              <td><span class="data-flow-badge input">GET</span></td>
              <td>Obtenir la source d'un CV (URL, PDF, manuel)</td>
            </tr>
            <tr>
              <td><code>/api/cv/metadata</code></td>
              <td><span class="data-flow-badge input">GET</span></td>
              <td>Obtenir les metadonnees d'un CV</td>
            </tr>
            <tr>
              <td><code>/api/cv/improve</code></td>
              <td><span class="data-flow-badge process">POST</span></td>
              <td>Lancer l'optimisation IA d'un CV</td>
            </tr>
            <tr>
              <td><code>/api/cv/apply-review</code></td>
              <td><span class="data-flow-badge process">POST</span></td>
              <td>Appliquer les choix de review (accept/reject)</td>
            </tr>
            <tr>
              <td><code>/api/cv/can-edit</code></td>
              <td><span class="data-flow-badge input">GET</span></td>
              <td>Verifier si l'utilisateur peut editer (credits)</td>
            </tr>
            <tr>
              <td><code>/api/cv/debit-edit</code></td>
              <td><span class="data-flow-badge process">POST</span></td>
              <td>Debiter un credit d'edition</td>
            </tr>
          </tbody>
        </table>

        <h2>Fichiers Cles</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Role</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/cv-core/storage.js</code></td>
              <td>CRUD CV (PostgreSQL via Prisma)</td>
            </tr>
            <tr>
              <td><code>lib/cv-core/validation.js</code></td>
              <td>Validation AJV contre <code>data/schema.json</code></td>
            </tr>
            <tr>
              <td><code>lib/cv-core/versioning.js</code></td>
              <td>Gestion des versions (creation, restauration, rotation)</td>
            </tr>
            <tr>
              <td><code>lib/cv-core/constants.js</code></td>
              <td>Ordre des sections, titres traduits (FR/EN/ES/DE), detection de langue</td>
            </tr>
            <tr>
              <td><code>lib/cv-core/reconstruction.js</code></td>
              <td>Reconstruction de CV a partir de donnees extraites</td>
            </tr>
            <tr>
              <td><code>lib/cv-core/source.js</code></td>
              <td>Tracking de l'origine du CV (link, pdf, manual)</td>
            </tr>
            <tr>
              <td><code>lib/cv-core/modifications/</code></td>
              <td>Application des modifications IA (diff, apply, utils)</td>
            </tr>
            <tr>
              <td><code>lib/cv-core/review/</code></td>
              <td>Systeme de review (state, actions, rollback)</td>
            </tr>
            <tr>
              <td><code>data/schema.json</code></td>
              <td>JSON Schema de reference pour la validation CV</td>
            </tr>
          </tbody>
        </table>

        <h2>Prochaines Sections</h2>

        <ul>
          <li><a href="./structure-cv.html">Structure JSON</a> — Detail de chaque section du CV</li>
          <li><a href="./crud.html">CRUD CV</a> — Operations de gestion (create, read, update, delete)</li>
          <li><a href="./versioning.html">Versioning</a> — Historique, restauration, rotation</li>
          <li><a href="./import-pdf.html">Import PDF</a> — Pipeline d'import via GPT-4o Vision</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
