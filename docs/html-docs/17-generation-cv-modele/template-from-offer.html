<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CV Mod&egrave;le depuis Offre - G&eacute;n&eacute;ration | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>
    <main class="main">
      <div id="header-container"></div>
      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <a href="./overview.html">G&eacute;n&eacute;ration CV Mod&egrave;le</a>
          <span>/</span>
          <span>Depuis Offre</span>
        </div>

        <h1>CV Mod&egrave;le depuis Offre d'Emploi</h1>
        <p class="lead">
          La fonction <code>createTemplateCv()</code> g&eacute;n&egrave;re un CV professionnel fictif complet &agrave; partir d'une ou plusieurs offres d'emploi (URL ou PDF). L'offre est d'abord extraite et structur&eacute;e, puis format&eacute;e en texte lisible, et enfin envoy&eacute;e &agrave; l'IA pour g&eacute;n&eacute;rer un CV mod&egrave;le adapt&eacute; au poste d&eacute;crit.
        </p>

        <div class="callout callout-info">
          <div class="callout-title">Fichier source</div>
          <p><code>lib/features/template-generation/service.js</code></p>
        </div>

        <!-- ==================== SIGNATURE ==================== -->
        <h2>Signature de la Fonction</h2>

        <pre><code class="language-javascript">export async function createTemplateCv({
  links = [],       // Array de URLs d'offres d'emploi
  files = [],       // Array de fichiers PDF { path, name }
  signal = null,    // AbortSignal pour annulation
  userId = null,    // ID utilisateur pour le tracking
  onTitleExtracted = null,  // Callback quand le titre est extrait
})</code></pre>

        <p>La fonction retourne un tableau de r&eacute;sultats, un &eacute;l&eacute;ment par source (URL ou PDF) :</p>

        <pre><code class="language-javascript">// Retour de createTemplateCv()
[
  {
    cvContent,          // JSON string du CV g&eacute;n&eacute;r&eacute;
    jobOfferId,         // ID de la JobOffer en base (pour lien CvFile &rarr; JobOffer)
    jobOfferLanguage,   // Langue d&eacute;tect&eacute;e de l'offre
    source,             // URL ou nom du fichier PDF
  },
  // ... un &eacute;l&eacute;ment par source
]</code></pre>

        <!-- ==================== PIPELINE FLOWCHART ==================== -->
        <h2>Pipeline Complet</h2>

        <div class="diagram">
          <div class="diagram-title">Pipeline de g&eacute;n&eacute;ration CV mod&egrave;le depuis offre d'emploi</div>
          <div class="mermaid">
flowchart TB
    subgraph Input["ENTREE"]
        URLs["URLs d'offres"]
        PDFs["Fichiers PDF"]
    end

    subgraph Step1["ETAPE 1 - VERIFICATION"]
        Credits["checkOpenAICredits()&lt;br/&gt;V&eacute;rification budget OpenAI"]
        Client["getOpenAIClient()&lt;br/&gt;+ getCvModel()"]
        Schema["getCvSchema()&lt;br/&gt;data/template.json (ou fallback)"]
    end

    subgraph Step2["ETAPE 2 - EXTRACTION"]
        ExtractURL["getOrExtractJobOfferFromUrl()&lt;br/&gt;userId, url, signal"]
        ExtractPDF["getOrExtractJobOfferFromPdf()&lt;br/&gt;userId, path, name, signal"]
        Callback["onTitleExtracted(title)&lt;br/&gt;Callback titre extrait"]
    end

    subgraph Step3["ETAPE 3 - FORMATAGE"]
        Format["formatJobOfferForTemplate()&lt;br/&gt;extraction, source, title"]
        Sections["Sections format&eacute;es :&lt;br/&gt;ENTREPRISE, CONTRAT, EXPERIENCE,&lt;br/&gt;LOCALISATION, COMPETENCES, MISSIONS,&lt;br/&gt;FORMATION, LANGUES, AVANTAGES"]
    end

    subgraph Step4["ETAPE 4 - GENERATION IA"]
        CallGPT["callChatGPT()&lt;br/&gt;client, model, cvSchema, jobOfferContent, signal"]
        Prompts["Prompts :&lt;br/&gt;system.md + user.md"]
        Cache["addCacheRetentionIfSupported()&lt;br/&gt;Cache 24h pour GPT-5"]
    end

    subgraph Step5["ETAPE 5 - NORMALISATION"]
        Normalize["normalizeJsonPayload()&lt;br/&gt;Parse et re-stringify"]
        TrackUsage["trackOpenAIUsage()&lt;br/&gt;featureName: create_template_cv_url&lt;br/&gt;ou create_template_cv_pdf"]
    end

    subgraph Output["SORTIE"]
        Result["Array de r&eacute;sultats&lt;br/&gt;{ cvContent, jobOfferId, jobOfferLanguage, source }"]
    end

    URLs --> Credits
    PDFs --> Credits
    Credits --> Client --> Schema

    URLs --> ExtractURL
    PDFs --> ExtractPDF
    ExtractURL --> Callback
    ExtractPDF --> Callback

    Callback --> Format --> Sections

    Sections --> CallGPT
    Schema --> CallGPT
    Prompts --> CallGPT
    Cache --> CallGPT

    CallGPT --> Normalize --> TrackUsage --> Result
          </div>
        </div>

        <!-- ==================== ETAPES DETAILLEES ==================== -->
        <h2>&Eacute;tapes D&eacute;taill&eacute;es</h2>

        <!-- ===== Etape 1 ===== -->
        <h3>&Eacute;tape 1 : V&eacute;rification</h3>

        <div class="data-flow">
          <div class="data-flow-header">VERIFICATION &mdash; Pr&eacute;requis avant g&eacute;n&eacute;ration</div>

          <div class="data-flow-section data-flow-input">
            <div class="data-flow-label">Composants initialis&eacute;s</div>
            <ol>
              <li><code>checkOpenAICredits()</code> &mdash; V&eacute;rifie que le budget OpenAI n'est pas &eacute;puis&eacute;</li>
              <li><code>getOpenAIClient()</code> &mdash; R&eacute;cup&egrave;re le client OpenAI configur&eacute;</li>
              <li><code>getCvModel()</code> &mdash; R&eacute;cup&egrave;re le mod&egrave;le IA &agrave; utiliser</li>
              <li><code>getCvSchema()</code> &mdash; Charge le sch&eacute;ma CV depuis <code>data/template.json</code> (ou fallback par d&eacute;faut)</li>
            </ol>
          </div>
        </div>

        <!-- ===== Etape 2 ===== -->
        <h3>&Eacute;tape 2 : Extraction des Offres</h3>

        <div class="data-flow">
          <div class="data-flow-header">EXTRACTION &mdash; R&eacute;cup&eacute;ration et structuration des offres</div>

          <div class="data-flow-section data-flow-input">
            <div class="data-flow-label">Sources support&eacute;es</div>
            <ul>
              <li><strong>URL :</strong> <code>getOrExtractJobOfferFromUrl(userId, url, signal)</code> &mdash; Extraction avec cache, retourne <code>{ extraction, jobOfferId, title, fromCache }</code></li>
              <li><strong>PDF :</strong> <code>getOrExtractJobOfferFromPdf(userId, path, name, signal)</code> &mdash; M&ecirc;me signature de retour</li>
            </ul>
          </div>

          <div class="data-flow-section data-flow-output">
            <div class="data-flow-label">Callback</div>
            <pre><code class="language-javascript">// Appel&eacute; d&egrave;s que le titre de l'offre est extrait
if (onTitleExtracted) {
  onTitleExtracted(title);
}</code></pre>
          </div>
        </div>

        <div class="callout callout-info">
          <div class="callout-title">Traitement s&eacute;quentiel</div>
          <p>Chaque source (URL ou PDF) est trait&eacute;e s&eacute;quentiellement dans une boucle. Un CV est g&eacute;n&eacute;r&eacute; pour chaque source. Les r&eacute;sultats sont accumul&eacute;s dans un tableau.</p>
        </div>

        <!-- ===== Etape 3 ===== -->
        <h3>&Eacute;tape 3 : Formatage &mdash; <code>formatJobOfferForTemplate()</code></h3>

        <div class="data-flow">
          <div class="data-flow-header">FORMATAGE &mdash; Conversion de l'extraction en texte structur&eacute;</div>

          <div class="data-flow-section data-flow-input">
            <div class="data-flow-label">Entr&eacute;e</div>
            <pre><code class="language-javascript">formatJobOfferForTemplate(extraction, source, title)
// extraction : objet JSON structur&eacute; (issu de l'extraction IA)
// source     : URL ou nom du fichier PDF
// title      : titre de l'offre extrait</code></pre>
          </div>

          <div class="data-flow-section data-flow-prompt">
            <div class="data-flow-label">Sections g&eacute;n&eacute;r&eacute;es</div>
            <table>
              <tr>
                <td><span class="badge badge-primary">ENTREPRISE</span></td>
                <td>Nom de l'entreprise, secteur d'activit&eacute;</td>
              </tr>
              <tr>
                <td><span class="badge badge-primary">TYPE DE CONTRAT</span></td>
                <td>CDI, CDD, freelance, etc.</td>
              </tr>
              <tr>
                <td><span class="badge badge-primary">EXPERIENCE REQUISE</span></td>
                <td>Niveau d'exp&eacute;rience demand&eacute;</td>
              </tr>
              <tr>
                <td><span class="badge badge-primary">LOCALISATION</span></td>
                <td>Ville, r&eacute;gion, t&eacute;l&eacute;travail</td>
              </tr>
              <tr>
                <td><span class="badge badge-warning">COMPETENCES REQUISES</span></td>
                <td>Hard skills, outils, m&eacute;thodologies obligatoires</td>
              </tr>
              <tr>
                <td><span class="badge badge-warning">COMPETENCES SOUHAITEES</span></td>
                <td>Nice-to-have, comp&eacute;tences bonus</td>
              </tr>
              <tr>
                <td><span class="badge badge-success">MISSIONS</span></td>
                <td>Responsabilit&eacute;s et missions du poste</td>
              </tr>
              <tr>
                <td><span class="badge badge-success">FORMATION</span></td>
                <td>Niveau d'&eacute;tudes requis</td>
              </tr>
              <tr>
                <td><span class="badge badge-success">LANGUES</span></td>
                <td>Langues requises ou souhait&eacute;es</td>
              </tr>
              <tr>
                <td><span class="badge badge-success">AVANTAGES</span></td>
                <td>Avantages propos&eacute;s par l'employeur</td>
              </tr>
            </table>
          </div>

          <div class="data-flow-section data-flow-output">
            <div class="data-flow-label">Sortie</div>
            <p>Cha&icirc;ne de texte format&eacute;e avec les sections pr&eacute;c&eacute;dentes, pr&ecirc;te &agrave; &ecirc;tre inject&eacute;e dans le prompt utilisateur.</p>
          </div>
        </div>

        <!-- ===== Etape 4 ===== -->
        <h3>&Eacute;tape 4 : G&eacute;n&eacute;ration IA &mdash; <code>callChatGPT()</code></h3>

        <div class="data-flow">
          <div class="data-flow-header">GENERATION IA &mdash; Appel OpenAI pour cr&eacute;er le CV</div>

          <div class="data-flow-section data-flow-input">
            <div class="data-flow-label">Param&egrave;tres</div>
            <pre><code class="language-javascript">callChatGPT(client, model, cvSchema, jobOfferContent, signal)
// client          : OpenAI client
// model           : mod&egrave;le IA (via getCvModel())
// cvSchema        : sch&eacute;ma JSON du CV attendu
// jobOfferContent : texte format&eacute; de l'offre
// signal          : AbortSignal (optionnel)</code></pre>
          </div>

          <div class="data-flow-section data-flow-prompt">
            <div class="data-flow-label">Prompts</div>
            <table>
              <tr>
                <td><strong>System prompt</strong></td>
                <td><code>lib/features/template-generation/prompts/system.md</code></td>
              </tr>
              <tr>
                <td><strong>User prompt</strong></td>
                <td><code>lib/features/template-generation/prompts/user.md</code></td>
              </tr>
            </table>
            <p>Le user prompt re&ccedil;oit le sch&eacute;ma CV et le contenu format&eacute; de l'offre comme variables de template.</p>
          </div>

          <div class="data-flow-section data-flow-output">
            <div class="data-flow-label">Configuration OpenAI</div>
            <table>
              <thead>
                <tr>
                  <th>Param&egrave;tre</th>
                  <th>Valeur</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>response_format</code></td>
                  <td><code>{ type: 'json_object' }</code></td>
                </tr>
                <tr>
                  <td>Cache retention</td>
                  <td><code>addCacheRetentionIfSupported()</code> &mdash; 24h pour les mod&egrave;les GPT-5</td>
                </tr>
                <tr>
                  <td><code>AbortSignal</code></td>
                  <td>Optionnel &mdash; permet l'annulation de la g&eacute;n&eacute;ration</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="callout callout-info">
          <div class="callout-title">Cache GPT-5</div>
          <p>La fonction <code>addCacheRetentionIfSupported()</code> ajoute un param&egrave;tre de r&eacute;tention de cache de 24 heures pour les mod&egrave;les GPT-5. Cela permet de r&eacute;utiliser le contexte des prompts syst&egrave;me entre les appels, r&eacute;duisant les co&ucirc;ts en tokens.</p>
        </div>

        <!-- ===== Etape 5 ===== -->
        <h3>&Eacute;tape 5 : Normalisation et Tracking</h3>

        <div class="data-flow">
          <div class="data-flow-header">NORMALISATION &mdash; Post-traitement du r&eacute;sultat</div>

          <div class="data-flow-section data-flow-input">
            <div class="data-flow-label">Traitement</div>
            <ol>
              <li><code>normalizeJsonPayload(result.content)</code> &mdash; Parse le JSON g&eacute;n&eacute;r&eacute; par l'IA et le re-stringify pour garantir un format propre</li>
              <li>V&eacute;rification que le contenu est un JSON valide</li>
            </ol>
          </div>

          <div class="data-flow-section data-flow-output">
            <div class="data-flow-label">Tracking</div>
            <pre><code class="language-javascript">await trackOpenAIUsage({
  userId,
  featureName: 'create_template_cv_url',  // ou 'create_template_cv_pdf'
  model,
  promptTokens: response.usage.prompt_tokens,
  completionTokens: response.usage.completion_tokens,
  duration,
});</code></pre>
          </div>
        </div>

        <!-- ==================== API ENDPOINT ==================== -->
        <h2>API Endpoint</h2>

        <div class="data-flow">
          <div class="data-flow-header">POST /api/background-tasks/create-template-cv</div>

          <div class="data-flow-section data-flow-input">
            <div class="data-flow-label">Requ&ecirc;te (FormData)</div>
            <table>
              <thead>
                <tr>
                  <th>Champ</th>
                  <th>Type</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>links</code></td>
                  <td><code>string[]</code></td>
                  <td>URLs des offres d'emploi</td>
                </tr>
                <tr>
                  <td><code>files</code></td>
                  <td><code>File[]</code></td>
                  <td>Fichiers PDF d'offres d'emploi</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="data-flow-section data-flow-prompt">
            <div class="data-flow-label">Traitement</div>
            <ul>
              <li>Cr&eacute;e une <code>BackgroundTask</code> par source (URL ou PDF)</li>
              <li>Feature utilis&eacute;e pour les cr&eacute;dits : <code>gpt_cv_generation</code></li>
              <li>Le r&eacute;sultat de chaque t&acirc;che contient le CV g&eacute;n&eacute;r&eacute; en JSON</li>
            </ul>
          </div>

          <div class="data-flow-section data-flow-output">
            <div class="data-flow-label">R&eacute;ponse</div>
            <pre><code class="language-javascript">// R&eacute;ponse API
{
  success: true,
  tasks: [
    {
      id: "task-id",
      status: "pending",
      source: "https://example.com/offre",
    }
  ]
}</code></pre>
          </div>
        </div>

        <!-- ==================== GESTION DES ERREURS ==================== -->
        <h2>Gestion des Erreurs</h2>

        <table>
          <thead>
            <tr>
              <th>Erreur</th>
              <th>Cause</th>
              <th>&Eacute;tape</th>
              <th>Comportement</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="badge badge-error">Budget &eacute;puis&eacute;</span></td>
              <td><code>checkOpenAICredits()</code> &eacute;choue</td>
              <td>1</td>
              <td>Pipeline interrompu imm&eacute;diatement</td>
            </tr>
            <tr>
              <td><span class="badge badge-error">Offre non d&eacute;tect&eacute;e</span></td>
              <td>URL invalide, page vide ou expir&eacute;e</td>
              <td>2</td>
              <td>Source ignor&eacute;e, autres sources continu&eacute;es</td>
            </tr>
            <tr>
              <td><span class="badge badge-error">Offre expir&eacute;e</span></td>
              <td><code>detectExpiredOrDeletedPage()</code> d&eacute;tecte une page supprim&eacute;e</td>
              <td>2</td>
              <td>Source ignor&eacute;e avec erreur sp&eacute;cifique</td>
            </tr>
            <tr>
              <td><span class="badge badge-warning">R&eacute;ponse IA vide</span></td>
              <td>OpenAI retourne un contenu vide ou invalide</td>
              <td>4</td>
              <td>Erreur lev&eacute;e, t&acirc;che marqu&eacute;e en &eacute;chec</td>
            </tr>
            <tr>
              <td><span class="badge badge-warning">JSON invalide</span></td>
              <td><code>normalizeJsonPayload()</code> ne peut pas parser le r&eacute;sultat</td>
              <td>5</td>
              <td>Erreur lev&eacute;e, t&acirc;che marqu&eacute;e en &eacute;chec</td>
            </tr>
            <tr>
              <td><span class="badge badge-warning">T&acirc;che annul&eacute;e</span></td>
              <td><code>AbortSignal</code> d&eacute;clench&eacute;</td>
              <td>Toute</td>
              <td>Pipeline interrompu proprement</td>
            </tr>
          </tbody>
        </table>

        <!-- ==================== MONITORING ==================== -->
        <h2>Monitoring et Tracking</h2>

        <table>
          <thead>
            <tr>
              <th>Feature Name</th>
              <th>Source</th>
              <th>Donn&eacute;es Track&eacute;es</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>create_template_cv_url</code></td>
              <td>URL</td>
              <td>Mod&egrave;le, tokens prompt/completion, dur&eacute;e, co&ucirc;t estim&eacute;</td>
            </tr>
            <tr>
              <td><code>create_template_cv_pdf</code></td>
              <td>PDF</td>
              <td>Mod&egrave;le, tokens prompt/completion, dur&eacute;e, co&ucirc;t estim&eacute;</td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-success">
          <div class="callout-title">Feature Name distinct par source</div>
          <p>Le <code>featureName</code> est diff&eacute;rent selon que la source est une URL ou un PDF. Cela permet de suivre s&eacute;par&eacute;ment les co&ucirc;ts et volumes de chaque canal d'entr&eacute;e dans le dashboard d'administration.</p>
        </div>

        <!-- ==================== FICHIERS CLES ==================== -->
        <h2>Fichiers Cl&eacute;s</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>R&ocirc;le</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/features/template-generation/service.js</code></td>
              <td><code>createTemplateCv()</code>, <code>formatJobOfferForTemplate()</code>, <code>callChatGPT()</code>, <code>getCvSchema()</code></td>
            </tr>
            <tr>
              <td><code>lib/features/template-generation/prompts/system.md</code></td>
              <td>System prompt &mdash; instructions IA pour la g&eacute;n&eacute;ration</td>
            </tr>
            <tr>
              <td><code>lib/features/template-generation/prompts/user.md</code></td>
              <td>User prompt &mdash; sch&eacute;ma CV + contenu de l'offre format&eacute;</td>
            </tr>
            <tr>
              <td><code>data/template.json</code></td>
              <td>Sch&eacute;ma de r&eacute;f&eacute;rence pour la structure du CV g&eacute;n&eacute;r&eacute;</td>
            </tr>
            <tr>
              <td><code>lib/job-offer/extraction/url.js</code></td>
              <td><code>getOrExtractJobOfferFromUrl()</code> &mdash; extraction et cache des offres URL</td>
            </tr>
            <tr>
              <td><code>lib/job-offer/extraction/pdf.js</code></td>
              <td><code>getOrExtractJobOfferFromPdf()</code> &mdash; extraction des offres PDF</td>
            </tr>
            <tr>
              <td><code>lib/openai/usage.js</code></td>
              <td><code>trackOpenAIUsage()</code> &mdash; enregistrement des tokens et co&ucirc;ts</td>
            </tr>
            <tr>
              <td><code>lib/openai/client.js</code></td>
              <td><code>getOpenAIClient()</code>, <code>getCvModel()</code>, <code>addCacheRetentionIfSupported()</code></td>
            </tr>
            <tr>
              <td><code>lib/openai/credits.js</code></td>
              <td><code>checkOpenAICredits()</code> &mdash; v&eacute;rification du budget</td>
            </tr>
            <tr>
              <td><code>app/api/background-tasks/create-template-cv/route.js</code></td>
              <td>API endpoint &mdash; d&eacute;clenchement des t&acirc;ches en arri&egrave;re-plan</td>
            </tr>
          </tbody>
        </table>

      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>