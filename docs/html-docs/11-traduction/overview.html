<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Traduction - Vue d'ensemble | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>
    <main class="main">
      <div id="header-container"></div>
      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Traduction</span>
        </div>

        <h1>Traduction de CV</h1>
        <p class="lead">
          Traduction de CV via OpenAI avec le framework <code>createJobRunner</code>. Supporte 4 langues (fr, en, es, de), préserve la structure JSON du CV, et utilise des prompts chargés depuis des fichiers Markdown.
        </p>

        <h2>Architecture</h2>

        <div class="diagram">
          <div class="diagram-title">Flux de traduction d'un CV</div>
          <div class="mermaid">
graph TB
    subgraph APIBlock["API - app/api/background-tasks/translate-cv/"]
        Request["POST requete"]
        Auth["Auth + canStartTaskType"]
        Credits["incrementFeatureCounter<br/>translate_cv"]
        Schedule["scheduleTranslateCvJob"]
    end

    subgraph Runner["JOB RUNNER - lib/translation/job.js"]
        EnsureDir["ensureUserCvDir"]
        ReadCV["readUserCvFile sourceFile"]
        Translate["translateCv service"]
        Save["writeUserCvFile translated"]
        DBUpsert["Upsert CvFile en DB"]
        CleanMeta["Nettoyer metadonnees"]
    end

    subgraph Service["SERVICE - lib/translation/service.js"]
        LoadPrompts["loadPrompt +<br/>loadPromptWithVars"]
        OpenAI["executeOpenAIService"]
        Validate["JSON.parse - validation"]
    end

    Request --> Auth --> Credits --> Schedule
    Schedule --> EnsureDir --> ReadCV --> Translate
    Translate --> LoadPrompts --> OpenAI --> Validate
    Validate --> CleanMeta --> Save --> DBUpsert

    style Request fill:#0ea5e9,stroke:#0284c7,color:#fff
    style Auth fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style Credits fill:#f59e0b,stroke:#d97706,color:#fff
    style Schedule fill:#6366f1,stroke:#4f46e5,color:#fff
    style EnsureDir fill:#64748b,stroke:#475569,color:#fff
    style ReadCV fill:#6366f1,stroke:#4f46e5,color:#fff
    style Translate fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style Save fill:#22c55e,stroke:#16a34a,color:#fff
    style DBUpsert fill:#14b8a6,stroke:#0d9488,color:#fff
    style CleanMeta fill:#64748b,stroke:#475569,color:#fff
    style LoadPrompts fill:#6366f1,stroke:#4f46e5,color:#fff
    style OpenAI fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style Validate fill:#22c55e,stroke:#16a34a,color:#fff
          </div>
        </div>

        <h2>Langues supportées</h2>

        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Langue</th>
              <th>Nom dans le prompt</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>fr</code></td>
              <td>Français</td>
              <td>français</td>
            </tr>
            <tr>
              <td><code>en</code></td>
              <td>Anglais</td>
              <td>anglais</td>
            </tr>
            <tr>
              <td><code>es</code></td>
              <td>Espagnol</td>
              <td>español</td>
            </tr>
            <tr>
              <td><code>de</code></td>
              <td>Allemand</td>
              <td>deutsch</td>
            </tr>
          </tbody>
        </table>

        <h2>Service de traduction</h2>

        <p>Le service <code>translateCv()</code> dans <code>lib/translation/service.js</code> :</p>

        <pre><code class="language-javascript">export async function translateCv({
  cvContent,
  targetLanguage,
  signal,
  userId = null
}) {
  const targetLangName = languageNames[targetLanguage] || targetLanguage;

  // Charger les prompts depuis les fichiers .md
  const systemPrompt = await loadPrompt('lib/translation/prompts/system.md');
  const userPrompt = await loadPromptWithVars('lib/translation/prompts/user.md', {
    targetLanguage: targetLangName,
    cvContent,
  });

  const { content } = await executeOpenAIService({
    serviceName: 'translateCv',
    modelSetting: 'model_translate_cv',
    featureName: 'translate_cv',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userPrompt },
    ],
    temperature: 0.3,
    signal,
    userId,
  });

  // Valider que c'est du JSON valide
  JSON.parse(content);
  return content;
}</code></pre>

        <h3>Configuration OpenAI</h3>

        <table>
          <thead>
            <tr>
              <th>Paramètre</th>
              <th>Valeur</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>modelSetting</code></td>
              <td><code>model_translate_cv</code></td>
              <td>Clé de configuration du modèle dans les settings admin</td>
            </tr>
            <tr>
              <td><code>featureName</code></td>
              <td><code>translate_cv</code></td>
              <td>Identifiant pour le tracking télémétrie</td>
            </tr>
            <tr>
              <td><code>temperature</code></td>
              <td><code>0.3</code></td>
              <td>Basse température pour des traductions fidèles</td>
            </tr>
          </tbody>
        </table>

        <h2>Règles de traduction (prompts)</h2>

        <p>Le prompt système (<code>lib/translation/prompts/system.md</code>) définit les règles suivantes :</p>

        <ul>
          <li><strong>Préserver la structure JSON</strong> — Traduire uniquement les valeurs, jamais les clés</li>
          <li><strong>Niveaux de compétences</strong> — Utiliser les tables de correspondance par langue (ex : Débutant → Beginner / Principiante / Anfänger)</li>
          <li><strong>Niveaux de langues CECRL</strong> — Les codes (A1, B2, C1...) restent inchangés, seuls les libellés sont traduits</li>
          <li><strong>Métadonnées</strong> — Le champ <code>meta.language</code> est mis à jour avec le code de la langue cible</li>
        </ul>

        <h2>Job Runner</h2>

        <p>Le job <code>translateCv</code> dans <code>lib/translation/job.js</code> utilise le framework <code>createJobRunner</code> avec les hooks suivants :</p>

        <table>
          <thead>
            <tr>
              <th>Hook</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>beforeRun</code></td>
              <td><code>ensureUserCvDir(userId)</code> — Vérifie que le dossier CV de l'utilisateur existe</td>
            </tr>
            <tr>
              <td><code>prepareInput</code></td>
              <td>Lit le contenu JSON du CV source via <code>readUserCvFile()</code></td>
            </tr>
            <tr>
              <td><code>handleResult</code></td>
              <td>Sauvegarde le CV traduit, nettoie les métadonnées d'amélioration, crée/met à jour l'entrée <code>CvFile</code> en DB</td>
            </tr>
            <tr>
              <td><code>trackSuccess</code></td>
              <td>Événement <code>CV_TRANSLATED</code> avec <code>targetLanguage</code> et <code>sourceFile</code></td>
            </tr>
            <tr>
              <td><code>trackError</code></td>
              <td>Événement <code>CV_TRANSLATED</code> avec status <code>error</code></td>
            </tr>
          </tbody>
        </table>

        <h3>Nettoyage des métadonnées</h3>

        <p>Lors de la traduction, les métadonnées d'amélioration du CV source sont supprimées du CV traduit :</p>

        <pre><code class="language-javascript">// Métadonnées supprimées dans handleResult
delete cvData.meta.improved_from;
delete cvData.meta.improved_at;
delete cvData.meta.score_before;
delete cvData.meta.score_estimate;
delete cvData.meta.changes_count;
delete cvData.meta.changes_made;
delete cvData.meta.modified_sections;</code></pre>

        <div class="callout callout-warning">
          <strong>Réinitialisation des scores</strong> — Le CV traduit est créé avec <code>matchScore: null</code>, <code>matchScoreStatus: null</code>, <code>optimiseStatus: null</code>. L'utilisateur devra recalculer le score de correspondance après traduction.
        </div>

        <h2>Entrée CvFile en DB</h2>

        <p>Le CV traduit est enregistré avec les métadonnées suivantes :</p>

        <table>
          <thead>
            <tr>
              <th>Champ</th>
              <th>Valeur</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>createdBy</code></td>
              <td><code>'translate-cv'</code></td>
            </tr>
            <tr>
              <td><code>originalCreatedBy</code></td>
              <td>Le <code>createdBy</code> du CV source</td>
            </tr>
            <tr>
              <td><code>isTranslated</code></td>
              <td><code>true</code></td>
            </tr>
            <tr>
              <td><code>language</code></td>
              <td>Code de la langue cible (fr, en, es, de)</td>
            </tr>
            <tr>
              <td><code>sourceType</code> / <code>sourceValue</code></td>
              <td>Hérités du CV source</td>
            </tr>
            <tr>
              <td><code>jobOfferId</code></td>
              <td>Hérité du CV source</td>
            </tr>
          </tbody>
        </table>

        <h2>Fichiers clés</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Rôle</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/translation/service.js</code></td>
              <td>Service de traduction via OpenAI (<code>translateCv()</code>)</td>
            </tr>
            <tr>
              <td><code>lib/translation/job.js</code></td>
              <td>Job runner avec <code>createJobRunner</code></td>
            </tr>
            <tr>
              <td><code>lib/translation/prompts/system.md</code></td>
              <td>Prompt système avec règles de traduction</td>
            </tr>
            <tr>
              <td><code>lib/translation/prompts/user.md</code></td>
              <td>Prompt utilisateur avec variables (<code>targetLanguage</code>, <code>cvContent</code>)</td>
            </tr>
            <tr>
              <td><code>lib/i18n/cvLabels.js</code></td>
              <td>Libellés i18n pour les niveaux de compétences et langues</td>
            </tr>
            <tr>
              <td><code>app/api/background-tasks/translate-cv/route.js</code></td>
              <td>Route API de déclenchement de la traduction</td>
            </tr>
          </tbody>
        </table>

      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
