<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email - Vue d'ensemble | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>
    <main class="main">
      <div id="header-container"></div>
      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Email</span>
        </div>

        <h1>Système Email</h1>
        <p class="lead">
          Double transport (SMTP OVH + Resend en fallback), factory pattern <code>createEmailSender()</code>, templates Maily stockés en DB avec fallback HTML hardcodé, et logging systématique de chaque envoi.
        </p>

        <h2>Architecture</h2>

        <div class="diagram">
          <div class="diagram-title">Flux d'envoi d'email</div>
          <div class="mermaid">
graph TB
    subgraph TriggersBlock["DECLENCHEURS"]
        AuthTrigger["Authentification<br/>vérification, reset, changement"]
        WelcomeTrigger["Inscription<br/>bienvenue"]
        PurchaseTrigger["Achat de crédits"]
        RetentionTrigger["Rétention<br/>inactivité"]
    end

    subgraph FactoryBlock["FABRIQUE D ENVOI"]
        CreateSender["Créer l'envoyeur<br/>d'email"]
        LoadTemplate["Charger le modèle<br/>depuis la base"]
        RenderTpl["Rendre le modèle<br/>Maily ou HTML"]
        SubstituteVars["Substituer les variables<br/>nom, url..."]
        FallbackTpl["Secours - modèle<br/>HTML par défaut"]
    end

    subgraph TransportBlock["TRANSPORT D ENVOI"]
        ProviderMode["Mode de transport<br/>auto"]
        SMTPTransport["SMTP OVH"]
        ResendTransport["Resend API"]
        TransportFallback["Secours si<br/>SMTP échoue"]
    end

    subgraph LoggingBlock["JOURNALISATION"]
        EmailLogDB["Journal des emails<br/>en base"]
    end

    AuthTrigger --> CreateSender
    WelcomeTrigger --> CreateSender
    PurchaseTrigger --> CreateSender
    RetentionTrigger --> CreateSender
    CreateSender --> LoadTemplate
    LoadTemplate -->|"Modele trouve"| RenderTpl --> SubstituteVars
    LoadTemplate -->|"Pas de modele"| FallbackTpl
    SubstituteVars --> ProviderMode
    FallbackTpl --> ProviderMode
    ProviderMode -->|"Principal"| SMTPTransport
    SMTPTransport -->|"Erreur"| TransportFallback --> ResendTransport
    ProviderMode -->|"Direct"| ResendTransport
    SMTPTransport --> EmailLogDB
    ResendTransport --> EmailLogDB

    style AuthTrigger fill:#0ea5e9,stroke:#0284c7,color:#fff
    style WelcomeTrigger fill:#0ea5e9,stroke:#0284c7,color:#fff
    style PurchaseTrigger fill:#0ea5e9,stroke:#0284c7,color:#fff
    style RetentionTrigger fill:#0ea5e9,stroke:#0284c7,color:#fff
    style CreateSender fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style LoadTemplate fill:#6366f1,stroke:#4f46e5,color:#fff
    style RenderTpl fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style SubstituteVars fill:#6366f1,stroke:#4f46e5,color:#fff
    style FallbackTpl fill:#64748b,stroke:#475569,color:#fff
    style ProviderMode fill:#f59e0b,stroke:#d97706,color:#fff
    style SMTPTransport fill:#22c55e,stroke:#16a34a,color:#fff
    style ResendTransport fill:#22c55e,stroke:#16a34a,color:#fff
    style TransportFallback fill:#ef4444,stroke:#dc2626,color:#fff
    style EmailLogDB fill:#14b8a6,stroke:#0d9488,color:#fff
          </div>
        </div>

        <h2>Transports</h2>

        <p>Le module <code>transports.js</code> gère deux transports d'envoi d'email :</p>

        <table>
          <thead>
            <tr>
              <th>Transport</th>
              <th>Fournisseur</th>
              <th>Bibliothèque</th>
              <th>Usage</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>SMTP</td>
              <td>OVH</td>
              <td><code>nodemailer</code></td>
              <td>Transport principal (par défaut)</td>
            </tr>
            <tr>
              <td>API</td>
              <td>Resend</td>
              <td><code>resend</code></td>
              <td>Transport de fallback en cas d'échec SMTP</td>
            </tr>
          </tbody>
        </table>

        <h3>Modes de transport</h3>

        <p>La variable d'environnement <code>EMAIL_PROVIDER</code> contrôle le comportement :</p>

        <table>
          <thead>
            <tr>
              <th>Mode</th>
              <th>Comportement</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>smtp</code></td>
              <td>SMTP uniquement, pas de fallback</td>
            </tr>
            <tr>
              <td><code>resend</code></td>
              <td>Resend uniquement, pas de SMTP</td>
            </tr>
            <tr>
              <td><code>auto</code> (défaut)</td>
              <td>SMTP en priorité, Resend en fallback si SMTP échoue</td>
            </tr>
          </tbody>
        </table>

        <pre><code class="language-javascript">// Initialisation lazy des transports
let smtpTransporter = null;
let resendClient = null;

function getSmtpTransporter() {
  if (!smtpTransporter) {
    smtpTransporter = nodemailer.createTransport({
      host: process.env.SMTP_HOST,
      port: parseInt(process.env.SMTP_PORT),
      secure: process.env.SMTP_SECURE === 'true',
      auth: {
        user: process.env.SMTP_USER,
        pass: process.env.SMTP_PASSWORD,
      },
    });
  }
  return smtpTransporter;
}</code></pre>

        <div class="callout callout-info">
          <strong>Initialisation lazy</strong> — Les transports SMTP et Resend sont initialisés à la première utilisation, pas au démarrage du serveur. La fonction <code>verifySmtpConnection()</code> permet de vérifier la connectivité SMTP.
        </div>

        <h2>Factory Pattern</h2>

        <p>La fonction <code>createEmailSender(triggerName, config)</code> dans <code>emailSenderFactory.js</code> génère un envoyeur d'email complet :</p>

        <pre><code class="language-javascript">const sendVerificationEmail = createEmailSender('email_verification', {
  getSubject: (vars) => `Vérifiez votre email`,
  getVariables: (user, extraData) => ({
    name: user.name,
    url: extraData.verificationUrl,
  }),
});</code></pre>

        <h3>Pipeline de rendu</h3>

        <ol>
          <li><strong>Charger le template</strong> — Recherche dans <code>EmailTemplate</code> par <code>triggerName</code></li>
          <li><strong>Rendre le HTML</strong> — Si <code>designJson</code> existe (Maily), rendu via le moteur Maily. Sinon, utilise <code>htmlContent</code> brut.</li>
          <li><strong>Substituer les variables</strong> — Remplace les placeholders <code>{{nom}}</code>, <code>{{url}}</code>, etc.</li>
          <li><strong>Fallback</strong> — Si aucun template en DB, utilise les templates HTML hardcodés dans <code>fallbackTemplates.js</code></li>
          <li><strong>Envoyer</strong> — Via le transport configuré (SMTP/Resend/auto)</li>
          <li><strong>Logger</strong> — Enregistre dans <code>EmailLog</code> (succès ou erreur)</li>
        </ol>

        <h2>Services email</h2>

        <p>Le module <code>emailService.js</code> expose 6 fonctions d'envoi créées via la factory :</p>

        <table>
          <thead>
            <tr>
              <th>Fonction</th>
              <th>Trigger</th>
              <th>Usage</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>sendVerificationEmail()</code></td>
              <td><code>email_verification</code></td>
              <td>Vérification d'adresse email à l'inscription</td>
            </tr>
            <tr>
              <td><code>sendPasswordResetEmail()</code></td>
              <td><code>password_reset</code></td>
              <td>Réinitialisation de mot de passe</td>
            </tr>
            <tr>
              <td><code>sendEmailChangeVerification()</code></td>
              <td><code>email_change</code></td>
              <td>Confirmation de changement d'adresse email</td>
            </tr>
            <tr>
              <td><code>sendWelcomeEmail()</code></td>
              <td><code>welcome</code></td>
              <td>Email de bienvenue après inscription</td>
            </tr>
            <tr>
              <td><code>sendPurchaseCreditsEmail()</code></td>
              <td><code>purchase_credits</code></td>
              <td>Confirmation d'achat de crédits</td>
            </tr>
            <tr>
              <td><code>sendInactivityWarningEmail()</code></td>
              <td>—</td>
              <td>Avertissement de suppression de compte inactif (RGPD)</td>
            </tr>
          </tbody>
        </table>

        <h2>Gestion des tokens</h2>

        <p>Le module <code>emailService.js</code> gère aussi les tokens de vérification :</p>

        <ul>
          <li><code>createVerificationToken()</code> — Crée un token unique pour la vérification d'email (24h d'expiration)</li>
          <li><code>verifyToken()</code> — Vérifie et valide un token de vérification email</li>
          <li><code>createPasswordResetToken()</code> — Crée un token pour la réinitialisation de mot de passe (1h d'expiration)</li>
          <li><code>createEmailChangeRequest()</code> — Crée un token pour le changement d'email (24h d'expiration)</li>
        </ul>

        <h2>Logging</h2>

        <p>Chaque envoi d'email est enregistré dans le modèle <code>EmailLog</code> en base de données, avec :</p>

        <ul>
          <li>L'adresse du destinataire</li>
          <li>Le trigger qui a déclenché l'envoi</li>
          <li>Le statut (succès ou erreur)</li>
          <li>Le transport utilisé (SMTP ou Resend)</li>
          <li>L'horodatage</li>
        </ul>

        <div class="callout callout-warning">
          <strong>Rétention RGPD</strong> — Les <code>EmailLog</code> de plus de 12 mois sont automatiquement supprimés par le job <code>cleanupEmailLogs()</code> dans <code>dataRetention.js</code>.
        </div>

        <h2>Fichiers clés</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Rôle</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/email/emailService.js</code></td>
              <td>6 fonctions d'envoi + gestion des tokens de vérification</td>
            </tr>
            <tr>
              <td><code>lib/email/emailSenderFactory.js</code></td>
              <td>Factory <code>createEmailSender()</code> — chargement template, rendu, envoi, logging</td>
            </tr>
            <tr>
              <td><code>lib/email/transports.js</code></td>
              <td>Double transport SMTP (OVH) + Resend avec mode auto/smtp/resend</td>
            </tr>
            <tr>
              <td><code>lib/email/triggers.js</code></td>
              <td>5 triggers d'email avec catégories (authentication, account, payments)</td>
            </tr>
            <tr>
              <td><code>lib/email/templates/fallbackTemplates.js</code></td>
              <td>6 templates HTML hardcodés de fallback</td>
            </tr>
          </tbody>
        </table>

        <h2>Prochaines sections</h2>
        <ul>
          <li><a href="./templates.html">Templates</a> — Détails des triggers, templates DB et fallbacks HTML</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
