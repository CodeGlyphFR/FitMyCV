<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pipeline Optimisation CV - Vue d'ensemble | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>
    <main class="main">
      <div id="header-container"></div>
      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <a href="./overview.html">Pipeline Optimisation</a>
          <span>/</span>
          <span>Vue d'ensemble</span>
        </div>

        <h1>Pipeline d'Optimisation CV</h1>
        <p class="lead">
          Le pipeline <strong>cv-improvement</strong> permet d'am&eacute;liorer un CV existant de mani&egrave;re cibl&eacute;e &agrave; partir des suggestions g&eacute;n&eacute;r&eacute;es lors du scoring. Il utilise une architecture &agrave; <strong>4 stages</strong> avec parall&eacute;lisation contr&ocirc;l&eacute;e (<code>pLimit(5)</code>), des imports dynamiques pour le chargement diff&eacute;r&eacute; des modules, et un syst&egrave;me de pr&eacute;traitement Chain-of-Thought pour router les suggestions vers les bonnes cibles.
        </p>

        <div class="callout callout-info">
          <div class="callout-title">Co&ucirc;t en cr&eacute;dits</div>
          <p>Le pipeline d'optimisation utilise la feature <code>optimize_cv</code>. Le co&ucirc;t est configurable dans <strong>Administration &rarr; Settings</strong> via <code>incrementFeatureCounter(userId, 'optimize_cv')</code>. Le cr&eacute;dit est d&eacute;bit&eacute; au lancement de la t&acirc;che et <strong>rembours&eacute; automatiquement</strong> en cas d'&eacute;chec.</p>
        </div>

        <!-- ==================== FLOWCHART COMPLET ==================== -->
        <h2>Workflow Global - 4 Stages</h2>

        <div class="diagram">
          <div class="diagram-title">Pipeline complet d'optimisation CV - 4 stages</div>
          <div class="mermaid">
flowchart TB
    subgraph Input["ENTREE"]
        CV["CV existant<br/>Contenu du CV"]
        Score["Score + Suggestions<br/>depuis scoring"]
        UserSel["Sélections utilisateur<br/>suggestions + compétences"]
    end

    subgraph API["POINT D ENTREE API"]
        Improve["Lancer l'amélioration<br/>du CV"]
        Schedule["Planifier la tâche<br/>en arrière-plan"]
    end

    subgraph Stage12["STAGE 1 &amp; 2 - PARALLELE"]
        direction LR
        S1["Stage 1<br/>Classifier les compétences<br/>manquantes"]
        S2["Stage 2<br/>Prétraitement suggestions<br/>Routage par cible"]
    end

    subgraph Stage3["STAGE 3 - AMELIORATIONS"]
        direction TB
        Exp["Améliorer les expériences<br/>Responsabilités, résultats"]
        Proj["Améliorer les projets<br/>Modifier ou créer"]
        Lang["Améliorer les langues<br/>Niveaux, certifications"]
        Extras["Améliorer les extras<br/>Certifications, divers"]
    end

    subgraph Stage4["STAGE 4 - RESUME"]
        SummaryN["Améliorer le résumé<br/>Séquentiel si modifications"]
    end

    subgraph Output["SORTIE"]
        FinalCV["CV amélioré"]
        Changes["Liste des modifications"]
        Metrics["Métriques par étape"]
    end

    CV --> Improve
    Score --> Improve
    UserSel --> Improve
    Improve --> Schedule

    Schedule --> S1
    Schedule --> S2

    S1 --> Stage3
    S2 --> Stage3

    Exp --> Stage4
    Proj --> Stage4
    Lang --> Stage4
    Extras --> Stage4

    Stage4 --> FinalCV
    Stage4 --> Changes
    Stage4 --> Metrics

    style CV fill:#0ea5e9,stroke:#0284c7,color:#fff
    style Score fill:#0ea5e9,stroke:#0284c7,color:#fff
    style UserSel fill:#0ea5e9,stroke:#0284c7,color:#fff
    style Improve fill:#6366f1,stroke:#4f46e5,color:#fff
    style Schedule fill:#6366f1,stroke:#4f46e5,color:#fff
    style S1 fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style S2 fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style Exp fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style Proj fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style Lang fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style Extras fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style SummaryN fill:#22c55e,stroke:#16a34a,color:#fff
    style FinalCV fill:#0ea5e9,stroke:#0284c7,color:#fff
    style Changes fill:#14b8a6,stroke:#0d9488,color:#fff
    style Metrics fill:#14b8a6,stroke:#0d9488,color:#fff
          </div>
        </div>

        <!-- ==================== TABLE DES STAGES ==================== -->
        <h2>Les 4 Stages du Pipeline</h2>

        <table>
          <thead>
            <tr>
              <th>Stage</th>
              <th>Nom</th>
              <th>Fichier</th>
              <th>Ex&eacute;cution</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><span class="badge badge-primary">1</span></td>
              <td>Classification Skills</td>
              <td><code>stages/stage1-classify-skills.js</code></td>
              <td>Parall&egrave;le (avec Stage 2)</td>
              <td>Classe les <code>missingSkillsToAdd</code> en cat&eacute;gories (hard_skills, soft_skills, tools, methodologies)</td>
            </tr>
            <tr>
              <td><span class="badge badge-primary">2</span></td>
              <td>Pr&eacute;traitement Suggestions</td>
              <td><code>stages/stage2-preprocess.js</code></td>
              <td>Parall&egrave;le (avec Stage 1)</td>
              <td>Analyse Chain-of-Thought pour router les suggestions vers les bonnes cibles (exp&eacute;rience, projet, langue, extras)</td>
            </tr>
            <tr>
              <td><span class="badge badge-warning">3</span></td>
              <td>Am&eacute;liorations Parall&egrave;les</td>
              <td><code>stages/stage3-improve/*</code></td>
              <td>Parall&egrave;le (<code>pLimit(5)</code>)</td>
              <td>Ex&eacute;cute les am&eacute;liorations cibl&eacute;es : exp&eacute;riences, projets, langues, extras</td>
            </tr>
            <tr>
              <td><span class="badge badge-success">4</span></td>
              <td>Summary</td>
              <td><code>stages/stage4-summary/improveSummary.js</code></td>
              <td>S&eacute;quentiel (conditionnel)</td>
              <td>Met &agrave; jour le summary uniquement si des exp&eacute;riences ou projets ont &eacute;t&eacute; modifi&eacute;s</td>
            </tr>
          </tbody>
        </table>

        <!-- ==================== API ENTRY POINT ==================== -->
        <h2>Point d'Entr&eacute;e API</h2>

        <p><strong>Fichier :</strong> <code>app/api/cv/improve/route.js</code></p>
        <p><strong>M&eacute;thode :</strong> <code>POST /api/cv/improve</code></p>

        <div class="data-flow">
          <div class="data-flow-header">API - D&eacute;clenchement du pipeline d'optimisation</div>

          <div class="data-flow-section data-flow-input">
            <div class="data-flow-label">Body de la requ&ecirc;te</div>
            <pre><code class="language-json">{
  "cvFile": "mon-cv.json",
  "replaceExisting": false,
  "selectedSuggestionIndices": [0, 2, 5],
  "suggestionsWithContext": [
    { "index": 0, "context": "J'ai 3 ans d'exp en React" },
    { "index": 2, "context": "" }
  ],
  "missingSkillsToAdd": [
    { "skill": "Kubernetes", "level": "intermediate" },
    { "skill": "CI/CD", "level": "advanced" }
  ],
  "pipelineVersion": 2
}</code></pre>
          </div>

          <div class="data-flow-section data-flow-prompt">
            <div class="data-flow-label">Traitement</div>
            <ol>
              <li>Parse les suggestions : format legacy (indices) OU nouveau format (<code>suggestionsWithContext</code>)</li>
              <li>V&eacute;rifie les limites et d&eacute;bite le cr&eacute;dit via <code>incrementFeatureCounter(userId, 'optimize_cv')</code></li>
              <li>Cr&eacute;e un <code>BackgroundTask</code> de type <code>improve-cv</code></li>
              <li>Lance <code>scheduleImproveCvJob()</code> en arri&egrave;re-plan</li>
            </ol>
          </div>

          <div class="data-flow-section data-flow-output">
            <div class="data-flow-label">R&eacute;ponse</div>
            <pre><code class="language-json">{
  "success": true,
  "taskId": "uuid-v4",
  "message": "Am&eacute;lioration en cours..."
}</code></pre>
          </div>
        </div>

        <div class="callout callout-warning">
          <div class="callout-title">Deux formats de suggestions support&eacute;s</div>
          <p><strong>Legacy :</strong> <code>selectedSuggestionIndices</code> &mdash; tableau d'indices simples (sans contexte utilisateur).</p>
          <p><strong>Nouveau :</strong> <code>suggestionsWithContext</code> &mdash; tableau de <code>{ index, context }</code> permettant &agrave; l'utilisateur d'ajouter du contexte libre pour guider l'IA.</p>
        </div>

        <!-- ==================== SCORING ==================== -->
        <h2>Scoring : <code>calculateMatchScoreWithAnalysis()</code></h2>

        <p><strong>Fichier :</strong> <code>lib/scoring/service.js</code></p>
        <p><strong>Mod&egrave;le IA :</strong> <code>model_match_score</code></p>

        <div class="data-flow">
          <div class="data-flow-header">SCORING - Calcul du score de correspondance CV / Offre</div>

          <div class="data-flow-section data-flow-input">
            <div class="data-flow-label">Entr&eacute;es</div>
            <ul>
              <li><code>cvContent</code> &mdash; Contenu JSON du CV (d&eacute;crypt&eacute;)</li>
              <li><code>cvFile</code> &mdash; Record DB avec relations <code>jobOffer</code> et <code>jobOfferSnapshot</code></li>
              <li><code>signal</code> &mdash; AbortSignal pour annulation</li>
              <li><code>userId</code> &mdash; Pour tracking t&eacute;l&eacute;m&eacute;trie OpenAI</li>
            </ul>
          </div>

          <div class="data-flow-section data-flow-prompt">
            <div class="data-flow-label">Formule de pond&eacute;ration (score recalcul&eacute;)</div>
            <pre><code class="language-javascript">calculatedScore = Math.round(
  (technical_skills * 0.35) +
  (experience * 0.30) +
  (education * 0.20) +
  (soft_skills_languages * 0.15)
);</code></pre>
          </div>

          <div class="data-flow-section data-flow-output">
            <div class="data-flow-label">Sortie</div>
            <pre><code class="language-json">{
  "matchScore": 75,
  "scoreBreakdown": {
    "technical_skills": 80,
    "experience": 73,
    "education": 75,
    "soft_skills_languages": 67
  },
  "suggestions": [...],
  "missingSkills": ["Kubernetes", "CI/CD"],
  "matchingSkills": ["Python", "React"]
}</code></pre>
          </div>
        </div>

        <div class="callout callout-info">
          <div class="callout-title">Score recalcul&eacute; vs score GPT</div>
          <p>Le <code>matchScore</code> retourn&eacute; n'est <strong>pas</strong> le <code>match_score</code> brut de GPT. Le score est <strong>recalcul&eacute;</strong> &agrave; partir des sous-scores (<code>scoreBreakdown</code>) avec la formule de pond&eacute;ration ci-dessus. Cela garantit la coh&eacute;rence entre le score global et les sous-scores.</p>
        </div>

        <!-- ==================== COMPARAISON ==================== -->
        <h2>Diff&eacute;rences avec Pipeline G&eacute;n&eacute;ration</h2>

        <table>
          <thead>
            <tr>
              <th>Aspect</th>
              <th>Pipeline G&eacute;n&eacute;ration</th>
              <th>Pipeline Optimisation</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Objectif</strong></td>
              <td>Transformation compl&egrave;te du CV</td>
              <td>Am&eacute;lioration cibl&eacute;e (suggestions)</td>
            </tr>
            <tr>
              <td><strong>D&eacute;clencheur</strong></td>
              <td>URL/PDF/Markdown d'offre d'emploi</td>
              <td>S&eacute;lection de suggestions par l'utilisateur</td>
            </tr>
            <tr>
              <td><strong>Architecture</strong></td>
              <td>3 phases (extraction &rarr; batches &rarr; recomposition)</td>
              <td>4 stages (classify &rarr; preprocess &rarr; improve &rarr; summary)</td>
            </tr>
            <tr>
              <td><strong>Classification</strong></td>
              <td>IA classe automatiquement (KEEP/REMOVE/MOVE)</td>
              <td>L'utilisateur choisit les sections via suggestions</td>
            </tr>
            <tr>
              <td><strong>Parall&eacute;lisation</strong></td>
              <td>6 batches en <code>Promise.all</code> + 1 s&eacute;quentiel</td>
              <td><code>pLimit(5)</code> pour contr&ocirc;ler la concurrence</td>
            </tr>
            <tr>
              <td><strong>Cache</strong></td>
              <td>Cache A/B structur&eacute; + staggered skills</td>
              <td>Pas de cache sp&eacute;cifique</td>
            </tr>
            <tr>
              <td><strong>Review</strong></td>
              <td>Post-g&eacute;n&eacute;ration (<code>initializeReviewState</code>)</td>
              <td>Int&eacute;gr&eacute; au workflow (suggestions s&eacute;lectionn&eacute;es)</td>
            </tr>
            <tr>
              <td><strong>Co&ucirc;t</strong></td>
              <td>Feature <code>gpt_cv_generation</code></td>
              <td>Feature <code>optimize_cv</code></td>
            </tr>
            <tr>
              <td><strong>Imports</strong></td>
              <td>Statiques</td>
              <td>Dynamiques (lazy loading des stages)</td>
            </tr>
          </tbody>
        </table>

        <!-- ==================== FILE STRUCTURE ==================== -->
        <h2>Structure des Fichiers</h2>

        <pre><code class="language-bash">lib/features/cv-improvement/
├── job.js                          # scheduleImproveCvJob() - lancement background
├── orchestrator.js                 # runImprovementPipeline() - 4 stages
├── stages/
│   ├── stage1-classify-skills.js   # classifySkills() - gpt-4o-mini
│   ├── stage2-preprocess.js        # preprocessSuggestions() - Chain-of-Thought
│   ├── stage3-improve/
│   │   ├── improveExperience.js    # improveExperience() - responsabilites, deliverables
│   │   ├── improveProject.js       # improveProject() - modifier ou creer projets
│   │   ├── improveLanguages.js     # improveLanguages(), applyLanguageModifications()
│   │   └── improveExtras.js        # improveExtras(), applyExtrasModifications()
│   └── stage4-summary/
│       └── improveSummary.js       # improveSummary() - summary conditionnel
└── prompts/                        # 12 fichiers .md (6 paires system/user)
    ├── preprocess-system.md / preprocess-user.md
    ├── experience-system.md / experience-user.md
    ├── project-system.md / project-user.md
    ├── languages-system.md / languages-user.md
    ├── extras-system.md / extras-user.md
    └── summary-system.md / summary-user.md

lib/scoring/
├── service.js                      # calculateMatchScoreWithAnalysis()
└── prompts/
    ├── system.md                   # Prompt systeme scoring
    └── user.md                     # Prompt utilisateur scoring</code></pre>

        <!-- ==================== LIENS ==================== -->
        <h2>Sections D&eacute;taill&eacute;es</h2>

        <ul>
          <li><a href="./scoring.html">Scoring</a> &mdash; Calcul du score, pond&eacute;ration, cross-language, API endpoints</li>
          <li><a href="./suggestions.html">Suggestions</a> &mdash; Format des suggestions, s&eacute;lection utilisateur, enrichissement</li>
          <li><a href="./application.html">Application des Am&eacute;liorations</a> &mdash; 4 stages d&eacute;taill&eacute;s avec data-flow</li>
          <li><a href="./review-system.html">Syst&egrave;me de Review</a> &mdash; Apply-review, changements, &eacute;tat de review</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>