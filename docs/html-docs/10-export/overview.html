<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Export - Vue d'ensemble | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>
    <main class="main">
      <div id="header-container"></div>
      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Export</span>
        </div>

        <h1>Export</h1>
        <p class="lead">
          Système d'export de CV en PDF (Puppeteer) et DOCX (bibliothèque <code>docx</code>), avec un pipeline de génération HTML partagé, des templates de sélection persistés côté serveur, et un mécanisme de remboursement automatique des crédits en cas d'erreur.
        </p>

        <h2>Architecture</h2>

        <div class="diagram">
          <div class="diagram-title">Flux d'export PDF et DOCX</div>
          <div class="mermaid">
flowchart TB
    subgraph Client["CLIENT (React)"]
        Preview["Prévisualisation CV"]
        SelectSections["Sélection sections/items"]
        ExportBtn["Bouton Export PDF / DOCX"]
    end

    subgraph Shared["PIPELINE HTML PARTAGÉ (lib/pdf/)"]
        PrepareData["prepareCvData()"]
        Styles["getExportStyles() / getPreviewStyles()"]
        Sections["generateSectionsHtml()"]
        HTML["HTML complet généré"]
    end

    subgraph PDF["EXPORT PDF (app/api/export-pdf/)"]
        Puppeteer["Puppeteer (headless Chrome)"]
        PdfBuffer["Buffer PDF (A4, marges 15mm/12mm)"]
    end

    subgraph DOCX["EXPORT DOCX (app/api/export-word/)"]
        DocxLib["Bibliothèque docx (Packer)"]
        DocxBuffer["Buffer DOCX"]
    end

    subgraph Credits["CRÉDITS"]
        Debit["incrementFeatureCounter()"]
        Refund["refundFeatureUsage()"]
    end

    Client --> ExportBtn
    ExportBtn --> Debit
    Debit --> PrepareData --> Styles --> Sections --> HTML
    HTML --> Puppeteer --> PdfBuffer
    HTML --> DocxLib --> DocxBuffer
    PdfBuffer -->|Erreur| Refund
    DocxBuffer -->|Erreur| Refund
          </div>
        </div>

        <h2>Composants principaux</h2>

        <div class="card-grid">
          <div class="card">
            <h3>lib/pdf/cvUtils.js</h3>
            <p>Fonctions de préparation des données CV : <code>prepareCvData()</code>, <code>formatDate()</code>, <code>formatLocation()</code>, <code>filterItems()</code>, <code>sortExperiences()</code>, <code>sortEducation()</code>. Définit aussi <code>DEFAULT_SECTION_ORDER</code> (7 sections).</p>
          </div>
          <div class="card">
            <h3>lib/pdf/cvStyles.js</h3>
            <p>Styles CSS pour l'export : <code>getBaseStyles()</code> (partagés), <code>getExportStyles()</code> (avec <code>page-break</code> CSS pour PDF), <code>getPreviewStyles()</code> (pour la prévisualisation en ligne).</p>
          </div>
          <div class="card">
            <h3>lib/pdf/sectionGenerators.js</h3>
            <p>Génération HTML des sections : <code>generateHeaderSection()</code> pour l'en-tête, <code>createSectionGenerators()</code> retourne des générateurs pour 7 sections, <code>generateSectionsHtml()</code> assemble le tout.</p>
          </div>
          <div class="card">
            <h3>lib/pdf/cvTranslations.js</h3>
            <p>Traductions des libellés CV en 4 langues (fr, en, es, de) : <code>getTranslation()</code>, <code>translateLevel()</code>, <code>getSectionTitle()</code>, <code>createTranslator()</code>.</p>
          </div>
        </div>

        <h2>Sections du CV</h2>

        <p>L'ordre par défaut est défini dans <code>DEFAULT_SECTION_ORDER</code> :</p>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Section</th>
              <th>Clé</th>
              <th>Filtrage</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>En-tête (nom, titre, contact)</td>
              <td><code>header</code></td>
              <td>Toujours présent</td>
            </tr>
            <tr>
              <td>2</td>
              <td>Résumé professionnel</td>
              <td><code>summary</code></td>
              <td><code>isSectionEnabled()</code></td>
            </tr>
            <tr>
              <td>3</td>
              <td>Expériences professionnelles</td>
              <td><code>experience</code></td>
              <td><code>filterItems()</code> + <code>sortExperiences()</code></td>
            </tr>
            <tr>
              <td>4</td>
              <td>Formation</td>
              <td><code>education</code></td>
              <td><code>filterItems()</code> + <code>sortEducation()</code></td>
            </tr>
            <tr>
              <td>5</td>
              <td>Projets</td>
              <td><code>projects</code></td>
              <td><code>filterItems()</code></td>
            </tr>
            <tr>
              <td>6</td>
              <td>Compétences</td>
              <td><code>skills</code></td>
              <td><code>filterItems()</code></td>
            </tr>
            <tr>
              <td>7</td>
              <td>Langues</td>
              <td><code>languages</code></td>
              <td><code>filterItems()</code></td>
            </tr>
          </tbody>
        </table>

        <h2>Sélection et préférences</h2>

        <h3>Export Templates (serveur)</h3>

        <p>Le endpoint <code>/api/export-templates</code> gère les templates de sélection sauvegardés par l'utilisateur :</p>

        <table>
          <thead>
            <tr>
              <th>Méthode</th>
              <th>Action</th>
              <th>Détails</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>GET</code></td>
              <td>Lister les templates</td>
              <td>Tous les <code>ExportTemplate</code> de l'utilisateur</td>
            </tr>
            <tr>
              <td><code>POST</code></td>
              <td>Créer un template</td>
              <td>Vérifie les noms dupliqués, stocke les sélections en JSON</td>
            </tr>
          </tbody>
        </table>

        <h3>Export Storage (client)</h3>

        <p>Le module <code>lib/export/exportStorage.js</code> gère la persistance locale des préférences d'export par CV via <code>localStorage</code>.</p>

        <h3>Selection Helpers</h3>

        <p>Le module <code>lib/export/selectionHelpers.js</code> fournit :</p>
        <ul>
          <li><code>getDefaultSelections()</code> — Sélections par défaut (toutes les sections activées)</li>
          <li><code>migrateSelections()</code> — Migration des anciennes sélections vers le nouveau format</li>
          <li><code>calculateCounters()</code> — Calcul des compteurs d'éléments sélectionnés</li>
          <li><code>extractMacroSelections()</code> — Extraction des sélections au niveau macro (section)</li>
        </ul>

        <h2>Gestion des crédits</h2>

        <p>Les deux endpoints d'export (PDF et DOCX) suivent le même pattern de gestion des crédits :</p>

        <pre><code class="language-javascript">// 1. Débit avant l'export
const featureResult = await incrementFeatureCounter(userId, featureName);
const { usageId } = featureResult;

try {
  // 2. Génération du fichier (PDF ou DOCX)
  const buffer = await generateExport(html);
  return new Response(buffer, { headers: { ... } });
} catch (error) {
  // 3. Remboursement automatique en cas d'erreur
  if (usageId) {
    await refundFeatureUsage(usageId);
  }
  throw error;
}</code></pre>

        <div class="callout callout-info">
          <strong>Remboursement automatique</strong> — Si l'export échoue après le débit des crédits, la fonction <code>refundFeatureUsage(usageId)</code> rembourse automatiquement le crédit consommé.
        </div>

        <h2>Traductions des libellés</h2>

        <p>Le module <code>cvTranslations.js</code> supporte 4 langues pour les libellés du CV exporté :</p>

        <table>
          <thead>
            <tr>
              <th>Langue</th>
              <th>Code</th>
              <th>Exemples de libellés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Français</td>
              <td><code>fr</code></td>
              <td>Expérience professionnelle, Formation, Compétences</td>
            </tr>
            <tr>
              <td>Anglais</td>
              <td><code>en</code></td>
              <td>Work Experience, Education, Skills</td>
            </tr>
            <tr>
              <td>Espagnol</td>
              <td><code>es</code></td>
              <td>Experiencia Profesional, Educación, Habilidades</td>
            </tr>
            <tr>
              <td>Allemand</td>
              <td><code>de</code></td>
              <td>Berufserfahrung, Ausbildung, Fähigkeiten</td>
            </tr>
          </tbody>
        </table>

        <h2>Fichiers clés</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Rôle</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/pdf/index.js</code></td>
              <td>Point d'entrée — ré-exporte tous les modules du pipeline HTML</td>
            </tr>
            <tr>
              <td><code>lib/pdf/cvUtils.js</code></td>
              <td>Préparation des données CV, tri, filtrage, ordre des sections</td>
            </tr>
            <tr>
              <td><code>lib/pdf/cvStyles.js</code></td>
              <td>Styles CSS pour export et prévisualisation</td>
            </tr>
            <tr>
              <td><code>lib/pdf/sectionGenerators.js</code></td>
              <td>Génération HTML des 7 sections du CV</td>
            </tr>
            <tr>
              <td><code>lib/pdf/cvTranslations.js</code></td>
              <td>Traductions des libellés en 4 langues</td>
            </tr>
            <tr>
              <td><code>lib/export/exportStorage.js</code></td>
              <td>Persistance localStorage des préférences d'export</td>
            </tr>
            <tr>
              <td><code>lib/export/selectionHelpers.js</code></td>
              <td>Helpers de sélection, compteurs, migration</td>
            </tr>
            <tr>
              <td><code>app/api/export-pdf/route.js</code></td>
              <td>Endpoint export PDF (Puppeteer)</td>
            </tr>
            <tr>
              <td><code>app/api/export-word/route.js</code></td>
              <td>Endpoint export DOCX (bibliothèque docx)</td>
            </tr>
            <tr>
              <td><code>app/api/export-templates/route.js</code></td>
              <td>CRUD des templates de sélection</td>
            </tr>
          </tbody>
        </table>

        <h2>Prochaines sections</h2>
        <ul>
          <li><a href="./pdf.html">Export PDF</a> — Détails du pipeline Puppeteer</li>
          <li><a href="./docx.html">Export DOCX</a> — Détails de la génération Word</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
