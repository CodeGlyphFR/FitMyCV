<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Export DOCX | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>
    <main class="main">
      <div id="header-container"></div>
      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <a href="./overview.html">Export</a>
          <span>/</span>
          <span>Export DOCX</span>
        </div>

        <h1>Export DOCX</h1>
        <p class="lead">
          Export de CV au format Word (DOCX) via la bibliothèque <code>docx</code> et son <code>Packer.toBuffer()</code>. Même pipeline de sélection que le PDF, avec gestion des crédits et remboursement automatique.
        </p>

        <h2>Pipeline d'export</h2>

        <div class="diagram">
          <div class="diagram-title">Flux d'export DOCX</div>
          <div class="mermaid">
flowchart LR
    Request["POST /api/export-word"]
    Auth["Authentification"]
    Credits["incrementFeatureCounter()"]
    Build["Construction Document docx"]
    Pack["Packer.toBuffer()"]
    Response["Response (application/vnd.openxmlformats)"]
    Refund["refundFeatureUsage()"]

    Request --> Auth --> Credits --> Build --> Pack --> Response
    Pack -->|Erreur| Refund
          </div>
        </div>

        <h2>Bibliothèque docx</h2>

        <p>L'export DOCX utilise la bibliothèque <code>docx</code> (npm) qui permet de construire des documents Word de manière programmatique :</p>

        <pre><code class="language-javascript">import { Document, Packer, Paragraph, TextRun, ... } from 'docx';

// Construction du document
const doc = new Document({
  sections: [{
    properties: { /* marges, orientation */ },
    children: [
      // Paragraphes, tableaux, listes...
    ],
  }],
});

// Sérialisation en buffer
const buffer = await Packer.toBuffer(doc);</code></pre>

        <h2>Endpoint API</h2>

        <pre><code class="language-javascript">// app/api/export-word/route.js
export async function POST(request) {
  // 1. Authentification
  const session = await auth();

  // 2. Débit du crédit
  const featureResult = await incrementFeatureCounter(
    session.user.id,
    'export_cv'
  );

  try {
    // 3. Construire le document Word
    const doc = generateWordDocument(cvData, selections, translator);

    // 4. Sérialiser en buffer
    const buffer = await Packer.toBuffer(doc);

    // 5. Retourner le buffer DOCX
    return new Response(buffer, {
      headers: {
        'Content-Type': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'Content-Disposition': `attachment; filename="${filename}"`,
      },
    });
  } catch (error) {
    // 6. Remboursement en cas d'erreur
    if (featureResult?.usageId) {
      await refundFeatureUsage(featureResult.usageId);
    }
    throw error;
  }
}</code></pre>

        <h2>Différences avec l'export PDF</h2>

        <table>
          <thead>
            <tr>
              <th>Aspect</th>
              <th>PDF (Puppeteer)</th>
              <th>DOCX (bibliothèque docx)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Moteur de rendu</td>
              <td>Chrome headless (HTML → PDF)</td>
              <td>Construction programmatique (objets → DOCX)</td>
            </tr>
            <tr>
              <td>Pipeline HTML partagé</td>
              <td>Oui (<code>lib/pdf/</code>)</td>
              <td>Non — construction directe</td>
            </tr>
            <tr>
              <td>Styles</td>
              <td>CSS complet</td>
              <td>Styles Word natifs (paragraphes, runs)</td>
            </tr>
            <tr>
              <td>Pagination</td>
              <td>Automatique via CSS page-break</td>
              <td>Gérée par Word à l'ouverture</td>
            </tr>
            <tr>
              <td>Éditable</td>
              <td>Non</td>
              <td>Oui — l'utilisateur peut modifier le document</td>
            </tr>
            <tr>
              <td>Dépendance système</td>
              <td>Chrome/Chromium installé</td>
              <td>Aucune — bibliothèque JS pure</td>
            </tr>
            <tr>
              <td>Feature name (crédits)</td>
              <td><code>export_cv</code></td>
              <td><code>export_cv</code></td>
            </tr>
          </tbody>
        </table>

        <h2>Gestion des erreurs</h2>

        <p>Le même pattern de remboursement que l'export PDF s'applique :</p>

        <ul>
          <li>Les crédits sont débités <strong>avant</strong> la génération</li>
          <li>En cas d'erreur, <code>refundFeatureUsage(usageId)</code> rembourse automatiquement</li>
          <li>L'erreur est loguée et une réponse 500 est retournée au client</li>
        </ul>

        <div class="callout callout-success">
          <strong>Avantage DOCX</strong> — L'export Word ne nécessite pas de browser headless, ce qui le rend plus léger et plus rapide que l'export PDF. Le document généré est éditable par l'utilisateur dans Word, Google Docs ou LibreOffice.
        </div>

      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
