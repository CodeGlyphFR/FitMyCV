<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Authentification | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <!-- Sidebar injectée par layout.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="main">
      <!-- Header injecté par layout.js -->
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Authentification</span>
        </div>

        <h1>Authentification</h1>
        <p class="lead">
          FitMyCV.io utilise NextAuth.js v4 avec le PrismaAdapter pour gérer l'authentification multi-providers :
          Credentials (email/password), Google OAuth, GitHub OAuth et Apple Sign-In. La stratégie de session
          repose sur des JWT signés avec une durée de vie de 7 jours.
        </p>

        <h2>Architecture d'Authentification</h2>

        <div class="diagram">
          <div class="diagram-title">Vue d'ensemble des flux d'authentification</div>
          <div class="mermaid">
flowchart TB
    subgraph Client["CLIENT"]
        Login["Page /auth<br/>(Login/Register)"]
        ExtPage["Page /extension-auth"]
        Account["Page /account"]
    end

    subgraph NextAuth["NEXTAUTH.JS v4"]
        Providers["Providers<br/>(conditionnels)"]
        Callbacks["Callbacks<br/>(jwt, session, signIn)"]
        Events["Events<br/>(createUser)"]
    end

    subgraph Providers_Detail["PROVIDERS"]
        Creds["Credentials<br/>(Email/Password)"]
        Google["Google OAuth"]
        GitHub["GitHub OAuth"]
        Apple["Apple Sign-In"]
    end

    subgraph ExtAuth["EXTENSION AUTH"]
        ExtToken["JWT Extension<br/>(HS256, 7j)"]
        ExtMiddleware["withExtensionAuth"]
    end

    subgraph Storage["STOCKAGE"]
        DB[(PostgreSQL<br/>via Prisma)]
        JWT["JWT Session<br/>(7 jours)"]
    end

    subgraph Security["SÉCURITÉ"]
        ReCaptcha["reCAPTCHA v3"]
        PasswordPolicy["Password Policy"]
        XSS["XSS Sanitization"]
        CSRF["CSRF Protection"]
    end

    Login --> NextAuth
    NextAuth --> Providers_Detail
    Providers_Detail --> DB
    Callbacks --> JWT
    ExtPage --> ExtToken
    Account --> Providers_Detail

    ExtToken --> ExtMiddleware
    Security -.-> Providers_Detail
          </div>
        </div>

        <h2>Configuration NextAuth</h2>

        <p>La configuration centrale se trouve dans <code>lib/auth/options.js</code>. Les providers OAuth sont
        conditionnels : ils ne sont activés que si les variables d'environnement correspondantes sont définies,
        via la fonction utilitaire <code>maybeProvider()</code>.</p>

        <pre><code class="language-javascript">// lib/auth/options.js (extrait simplifié)
import { PrismaAdapter } from "@next-auth/prisma-adapter";
import GoogleProvider from "next-auth/providers/google";
import GithubProvider from "next-auth/providers/github";
import AppleProvider from "next-auth/providers/apple";
import CredentialsProvider from "next-auth/providers/credentials";

function maybeProvider(condition, providerFactory) {
  return condition ? providerFactory() : null;
}

export const authOptions = {
  adapter: PrismaAdapter(prisma),

  session: {
    strategy: "jwt",
    maxAge: 7 * 24 * 60 * 60,   // 7 jours
    updateAge: 24 * 60 * 60,     // Refresh toutes les 24h
  },

  pages: {
    signIn: "/auth",
    error: "/auth",
  },

  providers: [
    maybeProvider(
      process.env.GOOGLE_CLIENT_ID && process.env.GOOGLE_CLIENT_SECRET,
      () => GoogleProvider({ ... })
    ),
    maybeProvider(
      process.env.GITHUB_ID && process.env.GITHUB_SECRET,
      () => GithubProvider({ ... })
    ),
    maybeProvider(
      process.env.APPLE_CLIENT_ID && process.env.APPLE_CLIENT_SECRET
        && process.env.APPLE_TEAM_ID && process.env.APPLE_KEY_ID
        && process.env.APPLE_PRIVATE_KEY,
      () => AppleProvider({ ... })
    ),
    CredentialsProvider({ ... }),
  ].filter(Boolean),

  callbacks: { jwt, session, signIn },
  events: { createUser },
};</code></pre>

        <h2>Providers Disponibles</h2>

        <div class="card-grid">
          <div class="card">
            <h4>Credentials</h4>
            <ul>
              <li>Email + mot de passe</li>
              <li>Hachage bcryptjs (10 rounds)</li>
              <li>reCAPTCHA v3 (score &ge; 0.5)</li>
              <li>Mode auto-signin (après vérification email)</li>
              <li>Vérification mode maintenance</li>
            </ul>
          </div>
          <div class="card">
            <h4>Google OAuth</h4>
            <ul>
              <li>OAuth 2.0 (prompt: select_account)</li>
              <li>Scope : openid, email, profile</li>
              <li>Email auto-vérifié à la création</li>
              <li>Conditionnel (<code>GOOGLE_CLIENT_ID</code>)</li>
            </ul>
          </div>
          <div class="card">
            <h4>GitHub OAuth</h4>
            <ul>
              <li>OAuth 2.0 (prompt: select_account)</li>
              <li>Scope : read:user, user:email</li>
              <li>Récupération email primaire vérifié</li>
              <li>Conditionnel (<code>GITHUB_ID</code>)</li>
            </ul>
          </div>
          <div class="card">
            <h4>Apple Sign-In</h4>
            <ul>
              <li>OAuth 2.0 (prompt: login)</li>
              <li>Requiert 5 variables d'environnement</li>
              <li>JWT client secret (private key)</li>
              <li>Conditionnel (<code>APPLE_CLIENT_ID</code>)</li>
            </ul>
          </div>
        </div>

        <h2>Callbacks NextAuth</h2>

        <h3>Callback JWT</h3>
        <p>Exécuté à chaque rafraîchissement du token JWT. Il enrichit le token avec les données fraîches de la base de données :</p>
        <ul>
          <li>Ajoute <code>id</code>, <code>name</code>, <code>email</code> lors du premier login</li>
          <li>Rafraîchit <code>emailVerified</code> et <code>role</code> depuis la DB à chaque mise à jour</li>
          <li>Auto-vérifie l'email des utilisateurs OAuth (pas de <code>passwordHash</code>)</li>
          <li>Marque le token comme <code>invalid</code> si l'utilisateur n'existe plus en DB</li>
        </ul>

        <h3>Callback Session</h3>
        <p>Construit l'objet session retourné au client :</p>
        <ul>
          <li>Vérifie que l'utilisateur existe toujours en DB (double vérification)</li>
          <li>Invalide la session si mode maintenance actif (sauf ADMIN)</li>
          <li>Retourne les données fraîches : <code>id</code>, <code>name</code>, <code>email</code>, <code>emailVerified</code>, <code>role</code></li>
          <li>Throttle les logs d'invalidation (1 par minute par utilisateur)</li>
        </ul>

        <h3>Callback signIn</h3>
        <p>Contrôle l'autorisation de connexion :</p>
        <ul>
          <li>Vérifie le setting <code>registration_enabled</code> pour bloquer les nouvelles inscriptions OAuth</li>
          <li>Vérifie le mode maintenance (bloque les non-admins)</li>
          <li>Supprime automatiquement les utilisateurs OAuth créés pendant un blocage</li>
          <li>Attribue le plan par défaut via <code>assignDefaultPlan()</code></li>
          <li>Met à jour <code>lastLoginAt</code> (suivi RGPD)</li>
          <li>Track la télémétrie de connexion</li>
        </ul>

        <h2>Récupération de Session</h2>

        <h3>Côté Serveur (API Routes)</h3>

        <pre><code class="language-javascript">// lib/auth/session.js
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth/options";

export async function auth() {
  return getServerSession(authOptions);
}

// Utilisation dans une API Route
import { auth } from '@/lib/auth/session';

export async function GET(request) {
  const session = await auth();

  if (!session?.user?.id) {
    return Response.json({ error: 'Non authentifié' }, { status: 401 });
  }

  // session.user contient :
  // - id: string (UUID)
  // - email: string
  // - name: string | null
  // - emailVerified: Date | null
  // - role: 'USER' | 'ADMIN'
}</code></pre>

        <h3>Côté Client (Composants)</h3>

        <pre><code class="language-javascript">'use client';

import { useSession, signIn, signOut } from 'next-auth/react';

export function AuthButton() {
  const { data: session, status } = useSession();

  if (status === 'loading') return &lt;div&gt;Chargement...&lt;/div&gt;;

  if (session) {
    return (
      &lt;div&gt;
        &lt;p&gt;Connecté : {session.user.email}&lt;/p&gt;
        &lt;p&gt;Rôle : {session.user.role}&lt;/p&gt;
        &lt;button onClick={() =&gt; signOut()}&gt;Déconnexion&lt;/button&gt;
      &lt;/div&gt;
    );
  }

  return &lt;button onClick={() =&gt; signIn()}&gt;Connexion&lt;/button&gt;;
}</code></pre>

        <h2>Authentification Extension Navigateur</h2>

        <p>L'extension Chrome/Firefox utilise un système JWT indépendant de NextAuth, basé sur la bibliothèque <code>jose</code> (algorithme HS256, signé avec <code>NEXTAUTH_SECRET</code>).</p>

        <div class="diagram">
          <div class="diagram-title">Flux d'authentification extension</div>
          <div class="mermaid">
flowchart LR
    subgraph Login["Connexion"]
        A["Email/Password"] -->|POST /api/auth/extension-token| B["JWT Extension<br/>(7 jours)"]
        C["Session Web"] -->|GET .../from-session| B
    end

    subgraph Usage["Utilisation"]
        B -->|Authorization: Bearer| D["withExtensionAuth"]
        D --> E["API Routes /api/ext/*"]
    end

    subgraph Refresh["Renouvellement"]
        B -->|POST .../refresh| F["Nouveau JWT<br/>(7 jours)"]
    end
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Méthode</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/api/auth/extension-token</code></td>
              <td>POST</td>
              <td>Login par email/password, retourne JWT extension (vérifie <code>emailVerified</code> + mode maintenance)</td>
            </tr>
            <tr>
              <td><code>/api/auth/extension-token/from-session</code></td>
              <td>GET</td>
              <td>Génère JWT extension depuis une session NextAuth</td>
            </tr>
            <tr>
              <td><code>/api/auth/extension-token/refresh</code></td>
              <td>POST</td>
              <td>Renouvelle un JWT extension encore valide (vérifie mode maintenance)</td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-info">
          <div class="callout-title">JWT Extension vs Session NextAuth</div>
          <p>Le JWT extension (<code>lib/auth/extensionToken.js</code>) est un token autonome signé avec HS256.
          Il contient <code>sub</code> (userId), <code>type: "extension"</code>, <code>name</code> et <code>email</code>.
          Le middleware <code>withExtensionAuth</code> vérifie ce token et charge l'utilisateur depuis la DB à chaque requête.</p>
        </div>

        <h2>Rôles Utilisateurs</h2>

        <table>
          <thead>
            <tr>
              <th>Rôle</th>
              <th>Description</th>
              <th>Accès</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>USER</code></td>
              <td>Utilisateur standard</td>
              <td>Dashboard, CV, Génération, Profil, Account</td>
            </tr>
            <tr>
              <td><code>ADMIN</code></td>
              <td>Administrateur</td>
              <td>Tout + Dashboard Admin + Accès en maintenance</td>
            </tr>
          </tbody>
        </table>

        <h2>Gestion de Compte</h2>

        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Méthode</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/api/account/profile</code></td>
              <td>PUT</td>
              <td>Modifier nom et/ou email (avec vérification)</td>
            </tr>
            <tr>
              <td><code>/api/account/password</code></td>
              <td>PUT</td>
              <td>Changer le mot de passe (vérifie l'ancien)</td>
            </tr>
            <tr>
              <td><code>/api/account/linked-accounts</code></td>
              <td>GET</td>
              <td>Lister les comptes OAuth liés + providers disponibles</td>
            </tr>
            <tr>
              <td><code>/api/account/link-oauth</code></td>
              <td>POST</td>
              <td>Initier la liaison d'un nouveau provider OAuth</td>
            </tr>
            <tr>
              <td><code>/api/account/unlink-oauth</code></td>
              <td>DELETE</td>
              <td>Supprimer un lien OAuth (si &gt; 1 provider lié)</td>
            </tr>
            <tr>
              <td><code>/api/account/delete</code></td>
              <td>DELETE</td>
              <td>Supprimer le compte (cascade + annulation Stripe)</td>
            </tr>
          </tbody>
        </table>

        <h2>Sécurité</h2>

        <div class="callout callout-warning">
          <div class="callout-title">Mesures de sécurité</div>
          <ul>
            <li><strong>Hachage</strong> : bcryptjs avec 10 salt rounds</li>
            <li><strong>JWT</strong> : signés avec <code>NEXTAUTH_SECRET</code>, durée 7 jours</li>
            <li><strong>Cookies</strong> : <code>httpOnly</code>, <code>sameSite: lax</code>, <code>secure</code> en production (prefixe <code>__Secure-</code> / <code>__Host-</code>)</li>
            <li><strong>CSRF</strong> : protection automatique NextAuth + state token pour OAuth linking</li>
            <li><strong>reCAPTCHA v3</strong> : sur register, login, resend-verification, request-reset, link-oauth (score &ge; 0.5)</li>
            <li><strong>Password Policy</strong> : min 8 chars, majuscule, minuscule, chiffre, caractère spécial, max 128 chars, blacklist mots courants</li>
            <li><strong>XSS</strong> : sanitization via <code>stripHtml()</code>, <code>sanitizeEmail()</code></li>
            <li><strong>Rate limiting</strong> : 1 resend verification/min, 60s cooldown changement email</li>
            <li><strong>Mode maintenance</strong> : bloque tous les non-admins (login + session)</li>
            <li><strong>Toggle inscription</strong> : setting <code>registration_enabled</code> pour désactiver les inscriptions</li>
          </ul>
        </div>

        <h2>Cookies de Session</h2>

        <table>
          <thead>
            <tr>
              <th>Cookie</th>
              <th>Prod Name</th>
              <th>Flags</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Session Token</td>
              <td><code>__Secure-next-auth.session-token</code></td>
              <td>httpOnly, sameSite: lax, secure, maxAge: 7j</td>
            </tr>
            <tr>
              <td>Callback URL</td>
              <td><code>__Secure-next-auth.callback-url</code></td>
              <td>sameSite: lax, secure</td>
            </tr>
            <tr>
              <td>CSRF Token</td>
              <td><code>__Host-next-auth.csrf-token</code></td>
              <td>httpOnly, sameSite: lax, secure</td>
            </tr>
          </tbody>
        </table>

        <h2>Fichiers Clés</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Rôle</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/auth/options.js</code></td>
              <td>Configuration NextAuth (providers, callbacks, events, session)</td>
            </tr>
            <tr>
              <td><code>lib/auth/session.js</code></td>
              <td>Helper <code>auth()</code> pour récupérer la session serveur</td>
            </tr>
            <tr>
              <td><code>lib/auth/extensionToken.js</code></td>
              <td>Sign/verify JWT extension (jose, HS256)</td>
            </tr>
            <tr>
              <td><code>lib/auth/autoSignIn.js</code></td>
              <td>Tokens de connexion auto après vérification email (5 min, usage unique)</td>
            </tr>
            <tr>
              <td><code>lib/api/withExtensionAuth.js</code></td>
              <td>Middleware auth pour les routes API extension</td>
            </tr>
            <tr>
              <td><code>lib/security/passwordPolicy.js</code></td>
              <td>Validation politique de mots de passe</td>
            </tr>
            <tr>
              <td><code>lib/security/xssSanitization.js</code></td>
              <td>Sanitization XSS (stripHtml, sanitizeEmail, escapeHtml)</td>
            </tr>
            <tr>
              <td><code>app/api/auth/[...nextauth]/route.js</code></td>
              <td>Handler NextAuth (GET + POST)</td>
            </tr>
            <tr>
              <td><code>app/api/auth/register/route.js</code></td>
              <td>Inscription credentials</td>
            </tr>
            <tr>
              <td><code>app/extension-auth/page.jsx</code></td>
              <td>Page bridge extension : session web &rarr; JWT extension</td>
            </tr>
          </tbody>
        </table>

        <h2>Variables d'Environnement</h2>

        <table>
          <thead>
            <tr>
              <th>Variable</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>NEXTAUTH_SECRET</code></td>
              <td>Secret pour signer les JWT (NextAuth + extension)</td>
            </tr>
            <tr>
              <td><code>NEXTAUTH_URL</code></td>
              <td>URL de base pour les callbacks NextAuth</td>
            </tr>
            <tr>
              <td><code>GOOGLE_CLIENT_ID</code> / <code>GOOGLE_CLIENT_SECRET</code></td>
              <td>Credentials Google OAuth</td>
            </tr>
            <tr>
              <td><code>GITHUB_ID</code> / <code>GITHUB_SECRET</code></td>
              <td>Credentials GitHub OAuth</td>
            </tr>
            <tr>
              <td><code>APPLE_CLIENT_ID</code> / <code>APPLE_CLIENT_SECRET</code></td>
              <td>Credentials Apple Sign-In</td>
            </tr>
            <tr>
              <td><code>APPLE_TEAM_ID</code> / <code>APPLE_KEY_ID</code> / <code>APPLE_PRIVATE_KEY</code></td>
              <td>Clés Apple Sign-In supplémentaires</td>
            </tr>
            <tr>
              <td><code>NEXT_PUBLIC_RECAPTCHA_SITE_KEY</code></td>
              <td>Clé publique reCAPTCHA v3</td>
            </tr>
          </tbody>
        </table>

        <h2>Prochaines Sections</h2>

        <ul>
          <li><a href="./oauth-flow.html">Flux OAuth</a> - Google, GitHub, Apple + liaison/déliaison de comptes</li>
          <li><a href="./credentials-flow.html">Flux Credentials</a> - Inscription, connexion, réinitialisation mot de passe</li>
          <li><a href="./email-verification.html">Vérification Email</a> - Confirmation, renvoi, changement d'email, connexion automatique</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
