<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Packs Cr&eacute;dits | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>

    <main class="main">
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <a href="./overview.html">Administration</a>
          <span>/</span>
          <span>Packs Cr&eacute;dits</span>
        </div>

        <h1>Packs Cr&eacute;dits</h1>
        <p class="lead">
          Gestion compl&egrave;te des packs de cr&eacute;dits achetables par les utilisateurs. Les packs sont synchronis&eacute;s automatiquement avec Stripe et permettent aux utilisateurs d'acheter des cr&eacute;dits en compl&eacute;ment de leur abonnement ou comme unique moyen de paiement en mode cr&eacute;dits-only.
        </p>

        <h2>Mod&egrave;le Prisma : CreditPack</h2>

        <pre><code class="language-javascript">model CreditPack {
  id              Int      @id @default(autoincrement())
  name            String                  // Auto-g&eacute;n&eacute;r&eacute; : "{creditAmount} Cr&eacute;dits"
  description     String?
  creditAmount    Int      @unique        // Nombre de cr&eacute;dits du pack
  price           Float                   // Prix en euros
  priceCurrency   String   @default("EUR")
  isActive        Boolean  @default(true) // Visible dans l'interface
  stripeProductId String?  @unique        // ID produit Stripe
  stripePriceId   String?  @unique        // ID prix Stripe (paiement unique)
}</code></pre>

        <div class="callout callout-info">
          <div class="callout-title">Nom auto-g&eacute;n&eacute;r&eacute;</div>
          <p>Le champ <code>name</code> est automatiquement g&eacute;n&eacute;r&eacute; au format <code>"{creditAmount} Cr&eacute;dits"</code> lors de la cr&eacute;ation et de la modification. Il est recalcul&eacute; &agrave; chaque changement de <code>creditAmount</code>.</p>
        </div>

        <h2>Exemple de Packs</h2>

        <table>
          <thead>
            <tr>
              <th>Nom</th>
              <th>Cr&eacute;dits</th>
              <th>Prix</th>
              <th>Prix/Cr&eacute;dit</th>
              <th>Actif</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>10 Cr&eacute;dits</td>
              <td>10</td>
              <td>4,99 &euro;</td>
              <td>0,50 &euro;</td>
              <td>Oui</td>
            </tr>
            <tr>
              <td>30 Cr&eacute;dits</td>
              <td>30</td>
              <td>12,99 &euro;</td>
              <td>0,43 &euro;</td>
              <td>Oui</td>
            </tr>
            <tr>
              <td>60 Cr&eacute;dits</td>
              <td>60</td>
              <td>22,99 &euro;</td>
              <td>0,38 &euro;</td>
              <td>Oui</td>
            </tr>
            <tr>
              <td>100 Cr&eacute;dits</td>
              <td>100</td>
              <td>34,99 &euro;</td>
              <td>0,35 &euro;</td>
              <td>Oui</td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-success">
          <div class="callout-title">Strat&eacute;gie tarifaire d&eacute;gressive</div>
          <p>Les packs sont con&ccedil;us avec un prix par cr&eacute;dit <strong>d&eacute;gressif</strong> : plus le pack est gros, plus le co&ucirc;t unitaire est avantageux. Cela incite les utilisateurs &agrave; acheter des packs plus importants.</p>
        </div>

        <h2>Cycle de Vie d'un Pack</h2>

        <div class="diagram">
          <div class="diagram-title">Cycle de vie complet d'un pack de cr&eacute;dits</div>
          <div class="mermaid">
flowchart TB
    subgraph Creation["CR&Eacute;ATION"]
        AdminCreate["Admin cr&eacute;e le pack<br/>POST /api/admin/credit-packs"]
        Validate{"creditAmount<br/>unique ?"}
        GenName["G&eacute;n&eacute;rer nom :<br/>{creditAmount} Cr&eacute;dits"]
        SaveDB["Sauvegarder en DB"]
    end

    subgraph Stripe["SYNCHRONISATION STRIPE"]
        SyncStart["syncStripeProductsInternal()"]
        CreateProduct["Cr&eacute;er Product Stripe"]
        CreatePrice["Cr&eacute;er Price Stripe<br/>(type: one_time)"]
        SetDefault["D&eacute;finir default_price"]
        SaveStripeIds["Sauvegarder stripeProductId<br/>et stripePriceId"]
    end

    subgraph Active["UTILISATION"]
        Visible["Pack visible dans<br/>l'interface utilisateur"]
        Checkout["Utilisateur clique Acheter"]
        StripeCheckout["Stripe Checkout<br/>(mode: payment)"]
        Webhook["Webhook checkout.session.completed"]
        Grant["grantCredits(userId, amount, 'purchase')"]
    end

    subgraph Modification["MODIFICATION"]
        AdminPatch["Admin modifie le pack<br/>PATCH /api/admin/credit-packs/[id]"]
        PriceChanged{"Prix chang&eacute; ?"}
        ArchivePrice["Archiver ancien Price"]
        NewPrice["Cr&eacute;er nouveau Price"]
    end

    subgraph Suppression["SUPPRESSION"]
        AdminDelete["Admin supprime le pack<br/>DELETE /api/admin/credit-packs/[id]"]
        DeleteDB["Supprimer de la DB"]
        ArchiveStripe["Archiver sur Stripe"]
    end

    AdminCreate --> Validate
    Validate -->|"Non"| Error["Erreur 409"]
    Validate -->|"Oui"| GenName
    GenName --> SaveDB
    SaveDB --> SyncStart

    SyncStart --> CreateProduct
    CreateProduct --> CreatePrice
    CreatePrice --> SetDefault
    SetDefault --> SaveStripeIds

    SaveStripeIds --> Visible
    Visible --> Checkout
    Checkout --> StripeCheckout
    StripeCheckout --> Webhook
    Webhook --> Grant

    AdminPatch --> PriceChanged
    PriceChanged -->|"Oui"| ArchivePrice
    ArchivePrice --> NewPrice
    NewPrice --> SaveStripeIds
    PriceChanged -->|"Non"| SaveStripeIds

    AdminDelete --> DeleteDB
    AdminDelete --> ArchiveStripe
          </div>
        </div>

        <h2>GET /api/admin/credit-packs</h2>

        <p>R&eacute;cup&egrave;re tous les packs de cr&eacute;dits, ordonn&eacute;s par ID croissant.</p>

        <h3>R&eacute;ponse</h3>

        <pre><code class="language-json">{
  "packs": [
    {
      "id": 1,
      "name": "10 Cr&eacute;dits",
      "description": null,
      "creditAmount": 10,
      "price": 4.99,
      "priceCurrency": "EUR",
      "isActive": true,
      "stripeProductId": "prod_abc123",
      "stripePriceId": "price_xyz789"
    },
    {
      "id": 2,
      "name": "30 Cr&eacute;dits",
      "creditAmount": 30,
      "price": 12.99,
      "priceCurrency": "EUR",
      "isActive": true,
      "stripeProductId": "prod_def456",
      "stripePriceId": "price_uvw012"
    }
  ]
}</code></pre>

        <h2>POST /api/admin/credit-packs</h2>

        <p>Cr&eacute;e un nouveau pack de cr&eacute;dits. Le nom est auto-g&eacute;n&eacute;r&eacute;.</p>

        <h3>Body (JSON)</h3>

        <pre><code class="language-json">{
  "creditAmount": 50,
  "price": 19.99,
  "priceCurrency": "EUR",
  "isActive": true
}</code></pre>

        <table>
          <thead>
            <tr>
              <th>Champ</th>
              <th>Type</th>
              <th>Requis</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>creditAmount</code></td>
              <td>Int</td>
              <td>Oui</td>
              <td>Nombre de cr&eacute;dits du pack. Doit &ecirc;tre unique</td>
            </tr>
            <tr>
              <td><code>price</code></td>
              <td>Float</td>
              <td>Oui</td>
              <td>Prix du pack en devise sp&eacute;cifi&eacute;e</td>
            </tr>
            <tr>
              <td><code>priceCurrency</code></td>
              <td>String</td>
              <td>Non</td>
              <td>Devise (d&eacute;faut : <code>"EUR"</code>)</td>
            </tr>
            <tr>
              <td><code>isActive</code></td>
              <td>Boolean</td>
              <td>Non</td>
              <td>Visibilit&eacute; du pack (d&eacute;faut : <code>true</code>)</td>
            </tr>
          </tbody>
        </table>

        <h3>Validations</h3>

        <ul>
          <li><strong>Unicit&eacute; creditAmount</strong> : deux packs ne peuvent pas avoir le m&ecirc;me nombre de cr&eacute;dits. Retourne <code>409</code> en cas de doublon.</li>
          <li><strong>Auto-g&eacute;n&eacute;ration du nom</strong> : le champ <code>name</code> est calcul&eacute; comme <code>"{creditAmount} Cr&eacute;dits"</code>.</li>
          <li><strong>Synchronisation Stripe</strong> : apr&egrave;s insertion en base, <code>syncStripeProductsInternal()</code> est appel&eacute; de mani&egrave;re non-bloquante pour cr&eacute;er le Product et le Price sur Stripe.</li>
        </ul>

        <h2>PATCH /api/admin/credit-packs/[id]</h2>

        <p>Modifie un pack existant. Tous les champs sont optionnels.</p>

        <h3>Body (JSON) &mdash; Tous les champs optionnels</h3>

        <pre><code class="language-json">{
  "creditAmount": 75,
  "price": 29.99,
  "isActive": false
}</code></pre>

        <h3>Comportement</h3>

        <ul>
          <li>Si <code>creditAmount</code> change, le <strong>nom est r&eacute;g&eacute;n&eacute;r&eacute;</strong> automatiquement</li>
          <li>L'<strong>unicit&eacute; de creditAmount</strong> est v&eacute;rifi&eacute;e (exclut le pack en cours de modification)</li>
          <li>Si le <strong>prix change</strong>, l'ancien Price Stripe est archiv&eacute; et un nouveau est cr&eacute;&eacute;</li>
          <li>Le nouveau Price est d&eacute;fini comme <code>default_price</code> du Product avant d'archiver l'ancien</li>
          <li>Mettre <code>isActive = false</code> masque le pack dans l'interface utilisateur mais ne le supprime pas de Stripe</li>
        </ul>

        <div class="callout callout-warning">
          <div class="callout-title">D&eacute;sactivation vs Suppression</div>
          <p>Pr&eacute;f&eacute;rez <strong>d&eacute;sactiver</strong> un pack (<code>isActive = false</code>) plut&ocirc;t que de le supprimer. Cela pr&eacute;serve l'historique des transactions et permet de le r&eacute;activer ult&eacute;rieurement.</p>
        </div>

        <h2>DELETE /api/admin/credit-packs/[id]</h2>

        <p>Supprime d&eacute;finitivement un pack de cr&eacute;dits.</p>

        <h3>Op&eacute;rations effectu&eacute;es</h3>

        <ul>
          <li>Suppression du pack en base de donn&eacute;es</li>
          <li>Archivage du Product et du Price correspondants sur Stripe (d&eacute;sactivation, pas de suppression d&eacute;finitive c&ocirc;t&eacute; Stripe)</li>
        </ul>

        <h2>Synchronisation Stripe</h2>

        <p>La synchronisation des packs avec Stripe est g&eacute;r&eacute;e par <code>syncStripeProductsInternal()</code> dans <code>lib/subscription/stripeSync.js</code>.</p>

        <div class="diagram">
          <div class="diagram-title">Synchronisation Pack &harr; Stripe</div>
          <div class="mermaid">
flowchart LR
    subgraph DB["BASE DE DONN&Eacute;ES"]
        Pack["CreditPack<br/>creditAmount, price,<br/>isActive"]
    end

    subgraph Sync["syncStripeProductsInternal()"]
        CheckActive{"Pack actif ?"}
        FindProduct["Chercher Product<br/>par stripeProductId"]
        CreateProduct["Cr&eacute;er Product<br/>(name, metadata)"]
        CheckPrice{"Price &agrave; jour ?<br/>(montant identique)"}
        CreatePrice["Cr&eacute;er Price<br/>(type: one_time)"]
        SetDefault["D&eacute;finir default_price"]
        ArchiveOld["Archiver ancien Price"]
        SaveIds["Sauvegarder IDs<br/>en DB"]
    end

    subgraph Stripe["STRIPE"]
        Product["Product"]
        Price["Price (one_time)"]
    end

    Pack --> CheckActive
    CheckActive -->|"Non"| Skip["Ignor&eacute;"]
    CheckActive -->|"Oui"| FindProduct
    FindProduct -->|"Existe"| CheckPrice
    FindProduct -->|"N'existe pas"| CreateProduct
    CreateProduct --> CheckPrice
    CheckPrice -->|"Montant chang&eacute;"| CreatePrice
    CreatePrice --> SetDefault
    SetDefault --> ArchiveOld
    ArchiveOld --> SaveIds
    CheckPrice -->|"OK"| SaveIds
    SaveIds --> Product
    SaveIds --> Price
          </div>
        </div>

        <div class="callout callout-info">
          <div class="callout-title">Packs inactifs ignor&eacute;s</div>
          <p>Les packs avec <code>isActive = false</code> sont <strong>ignor&eacute;s</strong> par la synchronisation Stripe. Ils ne sont ni cr&eacute;&eacute;s ni mis &agrave; jour c&ocirc;t&eacute; Stripe tant qu'ils restent inactifs.</p>
        </div>

        <h2>Flux d'Achat (C&ocirc;t&eacute; Utilisateur)</h2>

        <p>Le processus d'achat d'un pack de cr&eacute;dits suit le flux suivant :</p>

        <pre><code class="language-javascript">// 1. L'utilisateur s&eacute;lectionne un pack
const response = await fetch('/api/checkout/credits', {
  method: 'POST',
  body: JSON.stringify({ packId: 2 })
});
const { url } = await response.json();
// url = "https://checkout.stripe.com/c/pay/..."

// 2. Redirection vers Stripe Checkout (mode: payment)
window.location.href = url;

// 3. Apr&egrave;s paiement, webhook Stripe d&eacute;clenche :
//    checkout.session.completed &rarr; grantCredits(userId, creditAmount, 'purchase')

// 4. Cr&eacute;dits ajout&eacute;s au CreditBalance de l'utilisateur
// 5. CreditTransaction cr&eacute;&eacute;e (type: 'purchase', stripePaymentIntentId)</code></pre>

        <h2>Fichiers Cl&eacute;s</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>app/api/admin/credit-packs/route.js</code></td>
              <td>GET (liste) et POST (cr&eacute;ation) des packs</td>
            </tr>
            <tr>
              <td><code>app/api/admin/credit-packs/[id]/route.js</code></td>
              <td>PATCH (modification) et DELETE (suppression)</td>
            </tr>
            <tr>
              <td><code>lib/subscription/stripeSync.js</code></td>
              <td>Synchronisation bidirectionnelle avec Stripe (products et prices)</td>
            </tr>
            <tr>
              <td><code>lib/subscription/credits.js</code></td>
              <td>grantCredits() &mdash; attribution des cr&eacute;dits apr&egrave;s achat</td>
            </tr>
            <tr>
              <td><code>app/api/checkout/credits/route.js</code></td>
              <td>Cr&eacute;ation session Stripe Checkout (mode payment)</td>
            </tr>
            <tr>
              <td><code>app/api/subscription/credit-packs/route.js</code></td>
              <td>Liste des packs actifs c&ocirc;t&eacute; utilisateur (tri&eacute;s par creditAmount)</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
