<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administration | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>
    <main class="main">
      <div id="header-container"></div>
      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Administration</span>
        </div>

        <h1>Panneau d'Administration</h1>
        <p class="lead">
          Le panneau admin de FitMyCV.io centralise la gestion des utilisateurs, abonnements, cr&eacute;dits, co&ucirc;ts OpenAI, emails et param&egrave;tres syst&egrave;me. Il est accessible uniquement aux utilisateurs avec le r&ocirc;le <code>ADMIN</code> via <code>/admin/new</code> et expos&eacute; par <strong>65 endpoints API</strong> sous <code>/api/admin/*</code> et <code>/api/analytics/*</code>.
        </p>

        <h2>Architecture du Dashboard</h2>

        <div class="diagram">
          <div class="diagram-title">Modules du panneau admin et flux de donn&eacute;es</div>
          <div class="mermaid">
flowchart TB
    subgraph Dashboard["PANNEAU ADMIN (11 onglets)"]
        Overview["OverviewTab<br/>KPIs + MRR"]
        Users["UsersTab<br/>Gestion utilisateurs"]
        Revenue["RevenueTab<br/>Revenus + marges"]
        Plans["SubscriptionPlansTab<br/>Plans + feature limits"]
        OpenAI["OpenAICostsTab<br/>Monitoring IA"]
        Email["EmailManagementTab<br/>Templates + triggers"]
        Settings["SettingsTab<br/>Configuration"]
        Onboarding["OnboardingTab<br/>Funnel analytics"]
        Features["FeaturesTab<br/>Feature flags"]
        Errors["ErrorsTab<br/>Logs erreurs"]
        Feedback["FeedbackTab<br/>Retours users"]
    end

    subgraph API["65 ENDPOINTS /api/admin/* + /api/analytics/*"]
        UsersAPI["users<br/>users/:id"]
        SettingsAPI["settings<br/>settings/:id<br/>settings/history"]
        PlansAPI["subscription-plans<br/>subscription-mode"]
        CreditsAPI["credit-packs<br/>credit-packs/:id"]
        OpenAIAPI["openai-pricing<br/>openai-balance<br/>openai-alerts<br/>openai-alerts/triggered"]
        EmailAPI["email-templates<br/>email-triggers<br/>email-logs<br/>email-stats<br/>email-test"]
        RevenueAPI["revenue<br/>plan-costs"]
        MaintAPI["maintenance<br/>cancel-all-subscriptions<br/>telemetry/cleanup"]
        OnboardingAPI["onboarding/analytics<br/>onboarding/config<br/>onboarding/stats"]
        AnalyticsAPI["analytics/cv<br/>analytics/features<br/>analytics/conversions<br/>analytics/errors"]
    end

    subgraph DB["BASE DE DONNEES (9 modeles admin)"]
        Models["Setting | SubscriptionPlan<br/>CreditPack | OpenAIPricing<br/>OpenAIAlert | OpenAIUsage<br/>EmailTrigger | EmailTemplate<br/>EmailLog"]
    end

    Dashboard --> API
    API --> DB
          </div>
        </div>

        <h2>Modules</h2>

        <div class="card-grid">
          <div class="card">
            <h4>Utilisateurs</h4>
            <p>Liste pagin&eacute;e avec filtres (r&ocirc;le, email, recherche), cr&eacute;ation manuelle, modification r&ocirc;le/email, validation email, suppression compl&egrave;te (DB + fichiers).</p>
            <p><strong>4 endpoints</strong> &middot; <a href="./users.html">D&eacute;tails &rarr;</a></p>
          </div>
          <div class="card">
            <h4>Mode Abonnement</h4>
            <p>Bascule globale entre mode abonnement (Stripe) et mode cr&eacute;dits uniquement. Compte les abonn&eacute;s payants avant d&eacute;sactivation.</p>
            <p><strong>2 endpoints</strong> &middot; <a href="./subscription-mode.html">D&eacute;tails &rarr;</a></p>
          </div>
          <div class="card">
            <h4>Plans d'Abonnement</h4>
            <p>CRUD des plans avec tiers (0-4), feature limits par plan, calcul automatique du discount annuel, sync Stripe non-bloquante.</p>
            <p><strong>4 endpoints</strong> &middot; <a href="./plans-management.html">D&eacute;tails &rarr;</a></p>
          </div>
          <div class="card">
            <h4>Packs Cr&eacute;dits</h4>
            <p>CRUD des packs avec montant unique (contrainte unique), prix, devise, nom auto-g&eacute;n&eacute;r&eacute;, sync Stripe.</p>
            <p><strong>4 endpoints</strong> &middot; <a href="./credit-packs.html">D&eacute;tails &rarr;</a></p>
          </div>
          <div class="card">
            <h4>Monitoring OpenAI</h4>
            <p>Pricing par mod&egrave;le (standard + priority), balance compte (cache 5 min), alertes configurables avec d&eacute;tection des d&eacute;passements et utilisateurs affect&eacute;s.</p>
            <p><strong>9 endpoints</strong> &middot; <a href="./openai-monitoring.html">D&eacute;tails &rarr;</a></p>
          </div>
          <div class="card">
            <h4>Templates Email</h4>
            <p>Syst&egrave;me trigger/template avec &eacute;diteur visuel Maily/TipTap, activation atomique (un seul actif par trigger), logs, statistiques SMTP (limite 200/h).</p>
            <p><strong>16 endpoints</strong> &middot; <a href="./email-templates.html">D&eacute;tails &rarr;</a></p>
          </div>
          <div class="card">
            <h4>Param&egrave;tres Syst&egrave;me</h4>
            <p>Configuration cl&eacute;/valeur par cat&eacute;gorie, historique via t&eacute;l&eacute;m&eacute;trie, invalidation des caches (mod&egrave;les IA, PDF), diffusion SSE temps r&eacute;el.</p>
            <p><strong>5 endpoints</strong> &middot; <a href="./settings.html">D&eacute;tails &rarr;</a></p>
          </div>
          <div class="card">
            <h4>Revenus &amp; Marges</h4>
            <p>KPIs financiers (MRR, ARR, ARPU), historique par p&eacute;riode configurable, calcul des marges par plan via vue PostgreSQL <code>v_cout_api_par_plan</code>.</p>
            <p><strong>2 endpoints</strong></p>
          </div>
          <div class="card">
            <h4>Onboarding Admin</h4>
            <p>Configuration du flux d'onboarding, analytics du funnel (taux compl&eacute;tion, drop-off par &eacute;tape, health score), statistiques de progression.</p>
            <p><strong>3 endpoints</strong></p>
          </div>
          <div class="card">
            <h4>Analytics &amp; T&eacute;l&eacute;m&eacute;trie</h4>
            <p>Tableaux de bord analytiques : g&eacute;n&eacute;ration CV, utilisation des features, conversions, erreurs, et donn&eacute;es de t&eacute;l&eacute;m&eacute;trie pour le monitoring applicatif.</p>
            <p><strong>12 endpoints</strong></p>
          </div>
          <div class="card">
            <h4>Maintenance &amp; Ops</h4>
            <p>Gestion des sessions actives, annulation globale d'abonnements (avec prorata Stripe), purge t&eacute;l&eacute;m&eacute;trie (7 tables), images publiques, documentation.</p>
            <p><strong>6 endpoints</strong></p>
          </div>
        </div>

        <h2>KPIs du Dashboard</h2>

        <table>
          <thead>
            <tr>
              <th>Cat&eacute;gorie</th>
              <th>M&eacute;triques</th>
              <th>Source API</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Revenus</strong></td>
              <td>MRR, ARR, ARPU, revenus cr&eacute;dits, abonn&eacute;s actifs</td>
              <td><code>/api/admin/revenue</code></td>
            </tr>
            <tr>
              <td><strong>Utilisateurs</strong></td>
              <td>Total, nouveaux (p&eacute;riode), non v&eacute;rifi&eacute;s, CV moyen par user</td>
              <td><code>/api/admin/users</code></td>
            </tr>
            <tr>
              <td><strong>OpenAI</strong></td>
              <td>Co&ucirc;t jour/mois, tokens utilis&eacute;s, balance restante</td>
              <td><code>/api/admin/openai-*</code></td>
            </tr>
            <tr>
              <td><strong>Plans</strong></td>
              <td>Distribution par plan, co&ucirc;t API par plan, marge brute en %</td>
              <td><code>/api/admin/plan-costs</code></td>
            </tr>
            <tr>
              <td><strong>Onboarding</strong></td>
              <td>Taux compl&eacute;tion, taux skip, funnel par &eacute;tape, health score</td>
              <td><code>/api/admin/onboarding/analytics</code></td>
            </tr>
            <tr>
              <td><strong>Emails</strong></td>
              <td>Envois/heure (limite 200 SMTP), taux d'&eacute;chec, timeline 24h</td>
              <td><code>/api/admin/email-stats</code></td>
            </tr>
          </tbody>
        </table>

        <h2>Composants React Admin</h2>

        <p>Le dashboard est construit avec <strong>68 composants React</strong> dans <code>components/admin/</code> :</p>

        <table>
          <thead>
            <tr>
              <th>Composant</th>
              <th>R&ocirc;le</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>TabsBar</code></td>
              <td>Navigation par onglets (Overview, Users, Revenue, Plans, OpenAI, Email, Settings...)</td>
            </tr>
            <tr>
              <td><code>KPICard</code></td>
              <td>Carte m&eacute;trique avec valeur, tendance et ic&ocirc;ne</td>
            </tr>
            <tr>
              <td><code>MRRHistoryChart</code></td>
              <td>Graphique revenus mensuels r&eacute;currents</td>
            </tr>
            <tr>
              <td><code>PlanDistributionChart</code></td>
              <td>Distribution des abonn&eacute;s par plan</td>
            </tr>
            <tr>
              <td><code>EmailDashboard</code></td>
              <td>Interface compl&egrave;te de gestion email (nav, config, templates, historique)</td>
            </tr>
            <tr>
              <td><code>GrapesJsEditorModal</code></td>
              <td>&Eacute;diteur visuel de templates email</td>
            </tr>
            <tr>
              <td><code>OnboardingStatusChart</code></td>
              <td>Graphique de compl&eacute;tion du funnel d'onboarding</td>
            </tr>
            <tr>
              <td><code>ConfirmDialog</code></td>
              <td>Bo&icirc;te de confirmation pour actions destructives</td>
            </tr>
          </tbody>
        </table>

        <h2>S&eacute;curit&eacute; &amp; Autorisation</h2>

        <div class="callout callout-warning">
          <div class="callout-title">Contr&ocirc;le d'acc&egrave;s</div>
          <p>Tous les endpoints admin v&eacute;rifient <code>session?.user?.role === 'ADMIN'</code> et retournent <strong>403 Forbidden</strong> sinon. Deux exceptions :</p>
          <ul>
            <li><code>/api/admin/openai-balance</code> &mdash; Endpoint public (balance affich&eacute;e dans le footer admin)</li>
            <li><code>/api/admin/mutate</code> &mdash; Accessible &agrave; tout utilisateur authentifi&eacute; (mutation CV g&eacute;n&eacute;rique)</li>
          </ul>
        </div>

        <h2>Op&eacute;rations de Maintenance</h2>

        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>M&eacute;thode</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/api/admin/maintenance/active-sessions</code></td>
              <td>GET</td>
              <td>Compte les utilisateurs actifs r&eacute;cents (7 jours) pour &eacute;valuer l'impact d'une maintenance</td>
            </tr>
            <tr>
              <td><code>/api/admin/cancel-all-subscriptions</code></td>
              <td>GET</td>
              <td>Pr&eacute;visualise les abonnements &agrave; annuler avec calcul du prorata de remboursement</td>
            </tr>
            <tr>
              <td><code>/api/admin/cancel-all-subscriptions</code></td>
              <td>POST</td>
              <td>Annule tous les abonnements payants avec remboursement prorata (code: <code>CANCEL_ALL_SUBSCRIPTIONS</code>)</td>
            </tr>
            <tr>
              <td><code>/api/admin/telemetry/cleanup</code></td>
              <td>DELETE</td>
              <td>Purge 7 tables de t&eacute;l&eacute;m&eacute;trie en transaction atomique (FeatureUsage, OpenAICall, OpenAIUsage, TelemetryEvent, CvGenerationSubtask/Offer/Task)</td>
            </tr>
            <tr>
              <td><code>/api/admin/public-images</code></td>
              <td>GET</td>
              <td>Liste les images du dossier public (par dossier, taille, extension)</td>
            </tr>
            <tr>
              <td><code>/api/admin/docs/[[...path]]</code></td>
              <td>GET</td>
              <td>Sert la documentation HTML avec r&eacute;&eacute;criture automatique des chemins relatifs en absolus</td>
            </tr>
          </tbody>
        </table>

        <h2>Sections D&eacute;taill&eacute;es</h2>

        <ul>
          <li><a href="./users.html">Gestion des Utilisateurs</a> &mdash; CRUD, filtres, KPIs utilisateurs</li>
          <li><a href="./subscription-mode.html">Mode Abonnement</a> &mdash; Bascule abonnement/cr&eacute;dits</li>
          <li><a href="./plans-management.html">Gestion des Plans</a> &mdash; Plans, tiers, feature limits, sync Stripe</li>
          <li><a href="./credit-packs.html">Packs Cr&eacute;dits</a> &mdash; Configuration des packs d'achat</li>
          <li><a href="./openai-monitoring.html">Monitoring OpenAI</a> &mdash; Pricing, balance, alertes</li>
          <li><a href="./email-templates.html">Templates Email</a> &mdash; Triggers, templates, logs, statistiques</li>
          <li><a href="./settings.html">Param&egrave;tres Syst&egrave;me</a> &mdash; Configuration cl&eacute;/valeur par cat&eacute;gorie</li>
          <li><a href="../15-api-reference/admin.html">R&eacute;f&eacute;rence API Admin</a> &mdash; Documentation compl&egrave;te des 65 endpoints</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
