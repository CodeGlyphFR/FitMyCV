<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Utilisateurs | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>

    <main class="main">
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <a href="./overview.html">Administration</a>
          <span>/</span>
          <span>Utilisateurs</span>
        </div>

        <h1>Gestion des Utilisateurs</h1>
        <p class="lead">
          Interface d'administration compl&egrave;te pour g&eacute;rer les utilisateurs de la plateforme : consultation pagin&eacute;e avec filtres, cr&eacute;ation manuelle, modification des r&ocirc;les, validation d'email et suppression s&eacute;curis&eacute;e avec nettoyage des fichiers associ&eacute;s.
        </p>

        <h2>Workflow G&eacute;n&eacute;ral</h2>

        <div class="diagram">
          <div class="diagram-title">Flux de gestion des utilisateurs</div>
          <div class="mermaid">
graph TB
    subgraph AdminUI["INTERFACE ADMIN"]
        UsersTab["Onglet gestion<br/>utilisateurs"]
        AddModal["Fenêtre d'ajout<br/>d'utilisateur"]
        EditModal["Fenêtre de<br/>modification"]
    end

    subgraph APIUsers["API GESTION UTILISATEURS"]
        GetUsers["Lister<br/>Liste paginée + KPIs"]
        PostUser["Créer<br/>Création utilisateur"]
        PatchUser["Modifier<br/>un utilisateur"]
        DeleteUser["Supprimer<br/>un utilisateur"]
    end

    subgraph PatchActions["ACTIONS DE MODIFICATION"]
        UpdateRole["Changer le rôle<br/>USER / ADMIN"]
        UpdateEmail["Modifier l'email<br/>+ réinitialiser vérification"]
        ValidateEmail["Valider l'email<br/>manuellement"]
    end

    subgraph DBBlock["BASE DE DONNEES"]
        UserTable[("Utilisateurs")]
        CvFileTable[("Fichiers CV")]
        FilesStorage["Fichiers sur disque"]
    end

    UsersTab -->|"Recherche, filtres"| GetUsers
    AddModal -->|"email, nom, mot de passe, role"| PostUser
    EditModal --> PatchUser
    UsersTab -->|"Supprimer"| DeleteUser

    PatchUser --> UpdateRole
    PatchUser --> UpdateEmail
    PatchUser --> ValidateEmail

    GetUsers --> UserTable
    PostUser --> UserTable
    UpdateRole --> UserTable
    UpdateEmail --> UserTable
    ValidateEmail --> UserTable
    DeleteUser -->|"Cascade complete"| UserTable
    DeleteUser -->|"Nettoyage"| CvFileTable
    DeleteUser -->|"Nettoyage"| FilesStorage

    style UsersTab fill:#0ea5e9,stroke:#0284c7,color:#fff
    style AddModal fill:#0ea5e9,stroke:#0284c7,color:#fff
    style EditModal fill:#0ea5e9,stroke:#0284c7,color:#fff
    style GetUsers fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style PostUser fill:#22c55e,stroke:#16a34a,color:#fff
    style PatchUser fill:#f59e0b,stroke:#d97706,color:#fff
    style DeleteUser fill:#ef4444,stroke:#dc2626,color:#fff
    style UpdateRole fill:#6366f1,stroke:#4f46e5,color:#fff
    style UpdateEmail fill:#6366f1,stroke:#4f46e5,color:#fff
    style ValidateEmail fill:#6366f1,stroke:#4f46e5,color:#fff
    style UserTable fill:#14b8a6,stroke:#0d9488,color:#fff
    style CvFileTable fill:#14b8a6,stroke:#0d9488,color:#fff
    style FilesStorage fill:#64748b,stroke:#475569,color:#fff
          </div>
        </div>

        <h2>GET /api/admin/users</h2>

        <p>R&eacute;cup&egrave;re la liste pagin&eacute;e des utilisateurs avec des KPIs globaux. Accessible uniquement aux administrateurs.</p>

        <h3>Param&egrave;tres de requ&ecirc;te</h3>

        <table>
          <thead>
            <tr>
              <th>Param&egrave;tre</th>
              <th>Type</th>
              <th>D&eacute;faut</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>page</code></td>
              <td>Int</td>
              <td>1</td>
              <td>Num&eacute;ro de page (pagination)</td>
            </tr>
            <tr>
              <td><code>limit</code></td>
              <td>Int</td>
              <td>10</td>
              <td>Nombre de r&eacute;sultats par page (max : 50)</td>
            </tr>
            <tr>
              <td><code>role</code></td>
              <td>String</td>
              <td>&mdash;</td>
              <td>Filtre par r&ocirc;le : <code>USER</code> ou <code>ADMIN</code></td>
            </tr>
            <tr>
              <td><code>emailStatus</code></td>
              <td>String</td>
              <td>&mdash;</td>
              <td>Filtre par statut email : <code>verified</code> ou <code>unverified</code></td>
            </tr>
            <tr>
              <td><code>search</code></td>
              <td>String</td>
              <td>&mdash;</td>
              <td>Recherche dans le nom et l'email (insensible &agrave; la casse)</td>
            </tr>
            <tr>
              <td><code>sortBy</code></td>
              <td>String</td>
              <td>newest</td>
              <td>Tri : <code>newest</code> (plus r&eacute;cent) ou <code>oldest</code> (plus ancien)</td>
            </tr>
          </tbody>
        </table>

        <h3>R&eacute;ponse</h3>

        <pre><code class="language-json">{
  "users": [
    {
      "id": "clu...",
      "name": "Jean Dupont",
      "email": "jean@example.com",
      "role": "USER",
      "emailVerified": "2024-01-15T10:30:00Z",
      "createdAt": "2024-01-10T08:00:00Z",
      "lastActivity": "2024-02-01T14:22:00Z",
      "subscription": {
        "plan": { "name": "Pro", "tier": 1 },
        "status": "active",
        "interval": "monthly"
      },
      "creditBalance": { "balance": 42 },
      "accounts": [
        { "provider": "google" }
      ],
      "_count": { "cvFiles": 3 }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "totalUsers": 256,
    "totalPages": 26
  },
  "kpis": {
    "totalUsers": 256,
    "avgCvPerUser": 2.4,
    "unverifiedCount": 18
  }
}</code></pre>

        <div class="callout callout-info">
          <div class="callout-title">Donn&eacute;es incluses</div>
          <p>Chaque utilisateur retourn&eacute; inclut ses relations : abonnement actif (avec plan), solde de cr&eacute;dits, providers OAuth connect&eacute;s (Google, GitHub, etc.), nombre de CV et derni&egrave;re activit&eacute;.</p>
        </div>

        <h2>POST /api/admin/users</h2>

        <p>Cr&eacute;ation manuelle d'un utilisateur par l'administrateur. Le mot de passe est hash&eacute; c&ocirc;t&eacute; serveur avant stockage.</p>

        <h3>Body (JSON)</h3>

        <pre><code class="language-json">{
  "email": "nouveau@example.com",
  "name": "Marie Martin",
  "password": "MotDePasse123",
  "role": "USER"
}</code></pre>

        <table>
          <thead>
            <tr>
              <th>Champ</th>
              <th>Type</th>
              <th>Requis</th>
              <th>Validation</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>email</code></td>
              <td>String</td>
              <td>Oui</td>
              <td>Format email valide, unicit&eacute; v&eacute;rifi&eacute;e</td>
            </tr>
            <tr>
              <td><code>name</code></td>
              <td>String</td>
              <td>Oui</td>
              <td>Non vide</td>
            </tr>
            <tr>
              <td><code>password</code></td>
              <td>String</td>
              <td>Oui</td>
              <td>Minimum 8 caract&egrave;res</td>
            </tr>
            <tr>
              <td><code>role</code></td>
              <td>String</td>
              <td>Non</td>
              <td><code>USER</code> (d&eacute;faut) ou <code>ADMIN</code></td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-warning">
          <div class="callout-title">Pas de v&eacute;rification email</div>
          <p>Les utilisateurs cr&eacute;&eacute;s manuellement par l'admin n'ont <strong>pas</strong> leur email v&eacute;rifi&eacute; automatiquement. Utilisez l'action <code>validateEmail</code> du PATCH pour valider manuellement si n&eacute;cessaire.</p>
        </div>

        <h2>PATCH /api/admin/users/[userId]</h2>

        <p>Modification d'un utilisateur existant. Le type d'action est d&eacute;termin&eacute; par le champ <code>action</code> envoy&eacute; dans le body.</p>

        <h3>Actions disponibles</h3>

        <table>
          <thead>
            <tr>
              <th>Action</th>
              <th>Champs requis</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>updateRole</code></td>
              <td><code>role</code> (<code>USER</code> ou <code>ADMIN</code>)</td>
              <td>Change le r&ocirc;le de l'utilisateur</td>
            </tr>
            <tr>
              <td><code>updateEmail</code></td>
              <td><code>email</code> (nouveau)</td>
              <td>Met &agrave; jour l'email. Emp&ecirc;che la modification des emails provenant d'OAuth. Remet <code>emailVerified</code> &agrave; <code>null</code></td>
            </tr>
            <tr>
              <td><code>validateEmail</code></td>
              <td>&mdash;</td>
              <td>Valide manuellement l'email en positionnant <code>emailVerified</code> &agrave; la date courante</td>
            </tr>
          </tbody>
        </table>

        <h3>Exemples de requ&ecirc;tes</h3>

        <pre><code class="language-javascript">// Changer le r&ocirc;le d'un utilisateur
await fetch('/api/admin/users/clu123', {
  method: 'PATCH',
  body: JSON.stringify({
    action: 'updateRole',
    role: 'ADMIN'
  })
});

// Modifier l'email
await fetch('/api/admin/users/clu123', {
  method: 'PATCH',
  body: JSON.stringify({
    action: 'updateEmail',
    email: 'nouvel-email@example.com'
  })
});

// Valider manuellement l'email
await fetch('/api/admin/users/clu123', {
  method: 'PATCH',
  body: JSON.stringify({
    action: 'validateEmail'
  })
});</code></pre>

        <div class="callout callout-warning">
          <div class="callout-title">Protection OAuth</div>
          <p>L'action <code>updateEmail</code> refuse la modification si l'email actuel de l'utilisateur provient d'un provider OAuth (Google, GitHub, etc.). Cela &eacute;vite de d&eacute;synchroniser l'identit&eacute; OAuth avec l'email en base.</p>
        </div>

        <h2>DELETE /api/admin/users/[userId]</h2>

        <p>Suppression compl&egrave;te d'un utilisateur avec nettoyage int&eacute;gral de toutes les donn&eacute;es associ&eacute;es.</p>

        <h3>Op&eacute;rations effectu&eacute;es</h3>

        <ul>
          <li><strong>Base de donn&eacute;es</strong> : suppression en cascade de toutes les relations (CV, abonnements, transactions, sessions, comptes OAuth, etc.)</li>
          <li><strong>Fichiers</strong> : suppression des fichiers PDF et images associ&eacute;s aux CV de l'utilisateur (stockage disque/S3)</li>
        </ul>

        <div class="callout callout-warning">
          <div class="callout-title">Protection contre l'auto-suppression</div>
          <p>Un administrateur <strong>ne peut pas se supprimer lui-m&ecirc;me</strong>. L'API retourne une erreur <code>403</code> si le <code>userId</code> correspond &agrave; l'utilisateur connect&eacute;.</p>
        </div>

        <h2>Composants React</h2>

        <p>L'interface d'administration des utilisateurs est construite avec les composants suivants, situ&eacute;s dans <code>components/admin/users/</code> :</p>

        <table>
          <thead>
            <tr>
              <th>Composant</th>
              <th>R&ocirc;le</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>UsersTab</code></td>
              <td>Onglet principal : barre de recherche, filtres (r&ocirc;le, statut email, tri), tableau pagin&eacute;, KPIs en haut de page</td>
            </tr>
            <tr>
              <td><code>UserRow</code></td>
              <td>Ligne du tableau : affiche nom, email, r&ocirc;le, badges, abonnement, cr&eacute;dits, actions (modifier, supprimer)</td>
            </tr>
            <tr>
              <td><code>UserBadges</code></td>
              <td>Badges visuels : r&ocirc;le (USER/ADMIN), statut email (v&eacute;rifi&eacute;/non v&eacute;rifi&eacute;), providers OAuth connect&eacute;s</td>
            </tr>
            <tr>
              <td><code>AddUserModal</code></td>
              <td>Modal de cr&eacute;ation : formulaire email, nom, mot de passe, r&ocirc;le avec validation c&ocirc;t&eacute; client</td>
            </tr>
            <tr>
              <td><code>EditUserModal</code></td>
              <td>Modal d'&eacute;dition : changement de r&ocirc;le, modification d'email, validation manuelle d'email</td>
            </tr>
          </tbody>
        </table>

        <h2>Fichiers Cl&eacute;s</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>app/api/admin/users/route.js</code></td>
              <td>GET (liste pagin&eacute;e + KPIs) et POST (cr&eacute;ation)</td>
            </tr>
            <tr>
              <td><code>app/api/admin/users/[userId]/route.js</code></td>
              <td>PATCH (modification) et DELETE (suppression)</td>
            </tr>
            <tr>
              <td><code>components/admin/users/UsersTab.jsx</code></td>
              <td>Onglet principal avec recherche, filtres et pagination</td>
            </tr>
            <tr>
              <td><code>components/admin/users/UserRow.jsx</code></td>
              <td>Ligne individuelle du tableau utilisateurs</td>
            </tr>
            <tr>
              <td><code>components/admin/users/UserBadges.jsx</code></td>
              <td>Badges de statut (r&ocirc;le, email, OAuth)</td>
            </tr>
            <tr>
              <td><code>components/admin/users/AddUserModal.jsx</code></td>
              <td>Modal de cr&eacute;ation d'utilisateur</td>
            </tr>
            <tr>
              <td><code>components/admin/users/EditUserModal.jsx</code></td>
              <td>Modal d'&eacute;dition d'utilisateur</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
