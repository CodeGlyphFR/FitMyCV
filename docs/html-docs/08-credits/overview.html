<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Système de Crédits | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <!-- Sidebar injectée par layout.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="main">
      <!-- Header injecté par layout.js -->
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Crédits</span>
        </div>

        <h1>Système de Crédits</h1>
        <p class="lead">
          Le système de crédits permet de monétiser les fonctionnalités IA. Chaque action consomme un nombre défini de crédits, configurables en administration.
        </p>

        <h2>Architecture</h2>

        <div class="diagram">
          <div class="diagram-title">Flux de gestion des crédits</div>
          <div class="mermaid">
flowchart TB
    subgraph Sources["SOURCES DE CRÉDITS"]
        Welcome["Crédits bienvenue"]
        Purchase["Achat pack"]
        Refund["Remboursement"]
        Admin["Attribution admin"]
    end

    subgraph Balance["SOLDE"]
        CB[(CreditBalance)]
    end

    subgraph Usage["UTILISATION"]
        Check{{"canUseFeature()"}}
        Debit["debitCredit()"]
        Action["Action IA"]
    end

    subgraph Tracking["TRAÇABILITÉ"]
        CT[(CreditTransaction)]
    end

    Sources --> CB
    CB --> Check
    Check -->|"Crédits OK"| Debit
    Debit --> Action
    Debit --> CT
    Action -->|"Échec"| Refund
          </div>
        </div>

        <h2>Modèles de Données</h2>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>CreditBalance</code></td>
              <td>Solde utilisateur</td>
              <td>userId, balance (int)</td>
            </tr>
            <tr>
              <td><code>CreditTransaction</code></td>
              <td>Historique transactions</td>
              <td>userId, type, amount, reason, featureName, createdAt</td>
            </tr>
            <tr>
              <td><code>CreditPack</code></td>
              <td>Packs à l'achat</td>
              <td>name, credits, price, stripePriceId, isActive</td>
            </tr>
          </tbody>
        </table>

        <h2>Types de Transactions</h2>

        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Description</th>
              <th>Montant</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>welcome</code></td>
              <td>Crédits offerts à l'inscription</td>
              <td>+ (configurable, défaut: 5)</td>
            </tr>
            <tr>
              <td><code>purchase</code></td>
              <td>Achat de pack</td>
              <td>+ (selon pack)</td>
            </tr>
            <tr>
              <td><code>debit</code></td>
              <td>Utilisation feature</td>
              <td>- (selon feature)</td>
            </tr>
            <tr>
              <td><code>refund</code></td>
              <td>Remboursement (échec)</td>
              <td>+ (montant débité)</td>
            </tr>
            <tr>
              <td><code>admin_credit</code></td>
              <td>Attribution par admin</td>
              <td>+ ou -</td>
            </tr>
            <tr>
              <td><code>chargeback</code></td>
              <td>Contestation paiement</td>
              <td>- (négatif possible)</td>
            </tr>
          </tbody>
        </table>

        <h2>Coûts par Feature</h2>

        <p>Les coûts sont configurables via la table <code>Setting</code> :</p>

        <table>
          <thead>
            <tr>
              <th>Feature</th>
              <th>Coût</th>
              <th>Setting Key</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Création CV manuelle</td>
              <td><strong>1</strong> crédit</td>
              <td><code>credits_create_cv_manual</code></td>
            </tr>
            <tr>
              <td>Export CV (PDF/DOCX)</td>
              <td><strong>1</strong> crédit</td>
              <td><code>credits_export_cv</code></td>
            </tr>
            <tr>
              <td>Calcul match score</td>
              <td><strong>1</strong> crédit</td>
              <td><code>credits_match_score</code></td>
            </tr>
            <tr>
              <td>Traduction CV</td>
              <td><strong>1</strong> crédit</td>
              <td><code>credits_translate_cv</code></td>
            </tr>
            <tr>
              <td>Génération CV (offre)</td>
              <td><strong>2</strong> crédits</td>
              <td><code>credits_gpt_cv_generation</code></td>
            </tr>
            <tr>
              <td>Optimisation CV</td>
              <td><strong>2</strong> crédits</td>
              <td><code>credits_optimize_cv</code></td>
            </tr>
            <tr>
              <td>Génération depuis titre</td>
              <td><strong>3</strong> crédits</td>
              <td><code>credits_generate_cv_from_job_title</code></td>
            </tr>
            <tr>
              <td>Import PDF</td>
              <td><strong>5</strong> crédits</td>
              <td><code>credits_import_pdf</code></td>
            </tr>
          </tbody>
        </table>

        <h2>API Crédits</h2>

        <h3>Débiter un crédit</h3>

        <pre><code>// lib/subscription/credits.js

export async function debitCredit(userId, amount, featureName, reason = null) {
  // Transaction atomique
  return prisma.$transaction(async (tx) => {
    // 1. Récupérer le solde actuel
    const balance = await tx.creditBalance.findUnique({
      where: { userId }
    });

    if (!balance || balance.balance < amount) {
      throw new Error('Insufficient credits');
    }

    // 2. Décrémenter le solde
    await tx.creditBalance.update({
      where: { userId },
      data: { balance: { decrement: amount } }
    });

    // 3. Créer la transaction
    return tx.creditTransaction.create({
      data: {
        userId,
        type: 'debit',
        amount: -amount,
        featureName,
        reason: reason || `Usage: ${featureName}`,
        balanceAfter: balance.balance - amount
      }
    });
  });
}</code></pre>

        <h3>Rembourser un crédit</h3>

        <pre><code>export async function refundCredit(userId, amount, featureName, reason) {
  return prisma.$transaction(async (tx) => {
    // 1. Incrémenter le solde
    const updated = await tx.creditBalance.update({
      where: { userId },
      data: { balance: { increment: amount } }
    });

    // 2. Créer la transaction
    return tx.creditTransaction.create({
      data: {
        userId,
        type: 'refund',
        amount: amount, // Positif
        featureName,
        reason,
        balanceAfter: updated.balance
      }
    });
  });
}</code></pre>

        <h3>Vérifier le solde</h3>

        <pre><code>export async function getCreditBalance(userId) {
  const balance = await prisma.creditBalance.findUnique({
    where: { userId }
  });

  return balance?.balance ?? 0;
}

export async function hasEnoughCredits(userId, amount) {
  const balance = await getCreditBalance(userId);
  return balance >= amount;
}</code></pre>

        <h2>Packs de Crédits</h2>

        <div class="card-grid">
          <div class="card">
            <h4>Pack Starter</h4>
            <ul>
              <li><strong>5</strong> crédits</li>
              <li><strong>4.99€</strong></li>
              <li>~1€ / crédit</li>
            </ul>
          </div>
          <div class="card">
            <h4>Pack Standard</h4>
            <ul>
              <li><strong>10</strong> crédits</li>
              <li><strong>8.99€</strong></li>
              <li>~0.90€ / crédit</li>
            </ul>
          </div>
          <div class="card">
            <h4>Pack Pro</h4>
            <ul>
              <li><strong>25</strong> crédits</li>
              <li><strong>19.99€</strong></li>
              <li>~0.80€ / crédit</li>
            </ul>
          </div>
        </div>

        <h2>Flux d'Achat</h2>

        <div class="diagram">
          <div class="diagram-title">Processus d'achat de crédits</div>
          <div class="mermaid">
sequenceDiagram
    participant U as Utilisateur
    participant App as Application
    participant Stripe as Stripe
    participant DB as PostgreSQL

    U->>App: Sélectionne pack
    App->>Stripe: Créer Checkout Session
    Stripe-->>App: Session URL
    App-->>U: Redirection Stripe

    U->>Stripe: Paiement
    Stripe->>App: Webhook: checkout.session.completed
    App->>DB: creditCredit(userId, packCredits)
    App->>DB: Créer CreditTransaction (purchase)
    App-->>U: Redirection succès
          </div>
        </div>

        <h2>Gestion Balance Négative</h2>

        <div class="callout callout-warning">
          <div class="callout-title">Chargeback Protection</div>
          <p>En cas de contestation de paiement (chargeback), les crédits sont débités même si cela rend le solde négatif. L'utilisateur est bloqué jusqu'à régularisation.</p>
        </div>

        <pre><code>// Vérification dans canUseFeature()
const balance = await getCreditBalance(userId);

if (balance < 0) {
  return {
    canUse: false,
    reason: 'balance_negative',
    message: 'Votre solde est négatif suite à une contestation de paiement.'
  };
}</code></pre>

        <h2>API Endpoints</h2>

        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Méthode</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/api/credits/balance</code></td>
              <td>GET</td>
              <td>Récupérer le solde</td>
            </tr>
            <tr>
              <td><code>/api/credits/transactions</code></td>
              <td>GET</td>
              <td>Historique des transactions</td>
            </tr>
            <tr>
              <td><code>/api/credits/purchase</code></td>
              <td>POST</td>
              <td>Initier achat (Stripe Checkout)</td>
            </tr>
            <tr>
              <td><code>/api/admin/credit-packs</code></td>
              <td>GET/POST</td>
              <td>Gestion packs (admin)</td>
            </tr>
            <tr>
              <td><code>/api/admin/users/[id]/credits</code></td>
              <td>POST</td>
              <td>Attribution manuelle (admin)</td>
            </tr>
          </tbody>
        </table>

        <h2>Fichiers Clés</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Rôle</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/subscription/credits.js</code></td>
              <td>Logique crédit/débit/refund</td>
            </tr>
            <tr>
              <td><code>lib/subscription/creditCost.js</code></td>
              <td>Coûts par feature</td>
            </tr>
            <tr>
              <td><code>lib/subscription/featureUsage.js</code></td>
              <td>canUseFeature() intégré</td>
            </tr>
            <tr>
              <td><code>app/api/credits/</code></td>
              <td>Endpoints crédits</td>
            </tr>
          </tbody>
        </table>

        <h2>Prochaines Sections</h2>

        <ul>
          <li><a href="./welcome-credits.html">Crédits Bienvenue</a> - Attribution à l'inscription</li>
          <li><a href="./debit-refund.html">Débit et Remboursement</a> - Opérations sur le solde</li>
          <li><a href="./feature-limits.html">Limites par Feature</a> - Configuration des coûts</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
