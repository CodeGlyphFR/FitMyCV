<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Syst&egrave;me de Cr&eacute;dits | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>

    <main class="main">
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Cr&eacute;dits</span>
        </div>

        <h1>Syst&egrave;me de Cr&eacute;dits</h1>
        <p class="lead">
          Le syst&egrave;me de cr&eacute;dits permet de mon&eacute;tiser les fonctionnalit&eacute;s IA et non-IA. Chaque action consomme un nombre d&eacute;fini de cr&eacute;dits, <strong>configurable dynamiquement</strong> via la table <code>Setting</code> en base de donn&eacute;es. Les mises &agrave; jour sont propag&eacute;es en temps r&eacute;el via SSE (<code>dbEmitter</code>).
        </p>

        <h2>Architecture</h2>

        <div class="diagram">
          <div class="diagram-title">Flux de gestion des cr&eacute;dits</div>
          <div class="mermaid">
flowchart TB
    subgraph Sources["SOURCES DE CREDITS"]
        Welcome["Credits bienvenue<br/>mode credits-only"]
        Purchase["Achat pack<br/>grantCredits"]
        Refund["Remboursement<br/>refundCredit"]
        Admin["Attribution admin<br/>grantCredits type=gift"]
    end

    subgraph Balance["SOLDE"]
        CB[("CreditBalance<br/>balance, totalPurchased,<br/>totalUsed, totalRefunded,<br/>totalGifted")]
    end

    subgraph Usage["UTILISATION"]
        Check{{"canUseFeature"}}
        Increment["incrementFeatureCounter"]
        Debit["debitCredit"]
        Action["Action executee"]
    end

    subgraph Tracking["TRACABILITE"]
        CT[("CreditTransaction<br/>type, amount, featureName,<br/>stripePaymentIntentId")]
        SSE["dbEmitter<br/>SSE temps reel"]
    end

    subgraph Protection["PROTECTION"]
        Chargeback["debitCredits<br/>force, balance negative"]
    end

    Sources --> CB
    CB --> Check
    Check -->|"useCredit: true"| Increment
    Increment --> Debit
    Debit --> Action
    Debit --> CT
    CT --> SSE
    Action -->|"Echec task"| Refund
    Chargeback --> CB
    Chargeback --> CT

    style Welcome fill:#22c55e,stroke:#16a34a,color:#fff
    style Purchase fill:#0ea5e9,stroke:#0284c7,color:#fff
    style Refund fill:#22c55e,stroke:#16a34a,color:#fff
    style Admin fill:#64748b,stroke:#475569,color:#fff
    style CB fill:#14b8a6,stroke:#0d9488,color:#fff
    style Check fill:#f59e0b,stroke:#d97706,color:#fff
    style Increment fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style Debit fill:#ef4444,stroke:#dc2626,color:#fff
    style Action fill:#6366f1,stroke:#4f46e5,color:#fff
    style CT fill:#14b8a6,stroke:#0d9488,color:#fff
    style SSE fill:#64748b,stroke:#475569,color:#fff
    style Chargeback fill:#ef4444,stroke:#dc2626,color:#fff
          </div>
        </div>

        <h2>Mod&egrave;les de Donn&eacute;es</h2>

        <h3>CreditBalance</h3>

        <pre><code class="language-javascript">model CreditBalance {
  id                       String   @id @default(cuid())
  userId                   String   @unique
  balance                  Int      @default(0)
  totalPurchased           Int      @default(0)
  totalUsed                Int      @default(0)
  totalRefunded            Int      @default(0)
  totalGifted              Int      @default(0)
  balanceAfterLastPurchase Int      @default(0)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  user                     User     @relation(...)
}</code></pre>

        <h3>CreditTransaction</h3>

        <pre><code class="language-javascript">model CreditTransaction {
  id                    String          @id @default(cuid())
  userId                String
  amount                Int             // Positif (cr&eacute;dit) ou n&eacute;gatif (d&eacute;bit)
  type                  String          // usage, purchase, gift, refund, chargeback
  featureName           String?         // Feature ayant consomm&eacute; le cr&eacute;dit
  taskId                String?         // BackgroundTask associ&eacute;e
  cvFileId              String?         // CV associ&eacute;
  stripePaymentIntentId String?  @unique // Idempotence achat
  refunded              Boolean  @default(false)
  relatedTransactionId  String?         // Lien vers transaction d'origine (refund)
  metadata              String?         // JSON libre
  stripeInvoiceId       String?         // Facture Stripe
  createdAt             DateTime @default(now())
  user                  User     @relation(...)
  task                  BackgroundTask?
  cvFile                CvFile?
}</code></pre>

        <h3>CreditPack</h3>

        <pre><code class="language-javascript">model CreditPack {
  id              Int      @id @default(autoincrement())
  name            String
  description     String?
  creditAmount    Int      @unique   // Nombre de cr&eacute;dits
  price           Float              // Prix en euros
  priceCurrency   String   @default("EUR")
  isActive        Boolean  @default(true)
  stripeProductId String?  @unique
  stripePriceId   String?  @unique   // Prix unique (paiement one-shot)
}</code></pre>

        <h2>Types de Transactions</h2>

        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Description</th>
              <th>Montant</th>
              <th>Fonction</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>gift</code></td>
              <td>Cr&eacute;dits offerts (bienvenue, admin, bonus)</td>
              <td>+ (configurable)</td>
              <td><code>grantCredits(userId, amount, 'gift')</code></td>
            </tr>
            <tr>
              <td><code>purchase</code></td>
              <td>Achat de pack via Stripe</td>
              <td>+ (selon pack)</td>
              <td><code>grantCredits(userId, amount, 'purchase', {stripePaymentIntentId})</code></td>
            </tr>
            <tr>
              <td><code>usage</code></td>
              <td>Utilisation d'une feature</td>
              <td>- (selon co&ucirc;t feature)</td>
              <td><code>debitCredit(userId, amount, 'usage', {featureName})</code></td>
            </tr>
            <tr>
              <td><code>refund</code></td>
              <td>Remboursement (&eacute;chec task)</td>
              <td>+ (montant initial)</td>
              <td><code>refundCredit(userId, originalTransactionId)</code></td>
            </tr>
            <tr>
              <td><code>cv_creation</code></td>
              <td>Cr&eacute;ation de CV (tra&ccedil;abilit&eacute;)</td>
              <td>- (selon co&ucirc;t feature)</td>
              <td><code>debitCredit(userId, amount, 'cv_creation', {featureName})</code></td>
            </tr>
            <tr>
              <td><code>chargeback</code></td>
              <td>Contestation paiement</td>
              <td>- (n&eacute;gatif possible)</td>
              <td><code>debitCredits(userId, amount, 'chargeback')</code></td>
            </tr>
          </tbody>
        </table>

        <h2>Co&ucirc;ts par Feature</h2>

        <p>Les co&ucirc;ts sont configur&eacute;s dynamiquement via la table <code>Setting</code> (cl&eacute; <code>credits_&lt;featureName&gt;</code>). Chaque appel &agrave; <code>getCreditCostForFeature()</code> interroge la DB sans cache, permettant la modification en temps r&eacute;el via l'admin.</p>

        <table>
          <thead>
            <tr>
              <th>Feature</th>
              <th>Co&ucirc;t d&eacute;faut</th>
              <th>Setting Key</th>
              <th>IA</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Cr&eacute;ation CV manuelle</td>
              <td><strong>1</strong></td>
              <td><code>credits_create_cv_manual</code></td>
              <td>Non</td>
            </tr>
            <tr>
              <td>&Eacute;dition CV</td>
              <td><strong>1</strong></td>
              <td><code>credits_edit_cv</code></td>
              <td>Non</td>
            </tr>
            <tr>
              <td>Export CV (PDF)</td>
              <td><strong>1</strong></td>
              <td><code>credits_export_cv</code></td>
              <td>Non</td>
            </tr>
            <tr>
              <td>Calcul match score</td>
              <td><strong>1</strong></td>
              <td><code>credits_match_score</code></td>
              <td>Oui</td>
            </tr>
            <tr>
              <td>Traduction CV</td>
              <td><strong>1</strong></td>
              <td><code>credits_translate_cv</code></td>
              <td>Oui</td>
            </tr>
            <tr>
              <td>G&eacute;n&eacute;ration CV (offre)</td>
              <td><strong>2</strong></td>
              <td><code>credits_gpt_cv_generation</code></td>
              <td>Oui</td>
            </tr>
            <tr>
              <td>Optimisation CV</td>
              <td><strong>2</strong></td>
              <td><code>credits_optimize_cv</code></td>
              <td>Oui</td>
            </tr>
            <tr>
              <td>G&eacute;n&eacute;ration depuis titre</td>
              <td><strong>3</strong></td>
              <td><code>credits_generate_from_job_title</code></td>
              <td>Oui</td>
            </tr>
            <tr>
              <td>Import PDF</td>
              <td><strong>5</strong></td>
              <td><code>credits_import_pdf</code></td>
              <td>Oui</td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-info">
          <div class="callout-title">S&eacute;mantique du co&ucirc;t 0</div>
          <p>La signification de <code>cost = 0</code> d&eacute;pend du mode actif :</p>
          <ul>
            <li><strong>Mode abonnement</strong> : <code>premiumRequired = true</code> &mdash; la feature est r&eacute;serv&eacute;e aux abonn&eacute;s Premium (bloque m&ecirc;me avec cr&eacute;dits)</li>
            <li><strong>Mode cr&eacute;dits-only</strong> : la feature est <strong>gratuite</strong> pour tous</li>
          </ul>
        </div>

        <h2>Context React (Client)</h2>

        <p><code>lib/creditCosts/CreditCostsContext.jsx</code> fournit les co&ucirc;ts c&ocirc;t&eacute; client via un React Context :</p>

        <pre><code class="language-javascript">// Utilisation dans un composant
import { useCreditCosts } from '@/lib/creditCosts/CreditCostsContext';

const { costs, loading, creditsOnlyMode } = useCreditCosts();

// costs = { gpt_cv_generation: 2, import_pdf: 5, ... }
// creditsOnlyMode = true si subscription_mode_enabled = false</code></pre>

        <p>Le provider fetch les co&ucirc;ts depuis <code>GET /api/credits/costs</code> et &eacute;coute les &eacute;v&eacute;nements SSE <code>settings:updated</code> et <code>credits-updated</code> pour rafra&icirc;chir automatiquement.</p>

        <h2>API Endpoints</h2>

        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>M&eacute;thode</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/api/credits/balance</code></td>
              <td>GET</td>
              <td>Solde complet (balance, totalPurchased, totalUsed, totalRefunded, totalGifted)</td>
            </tr>
            <tr>
              <td><code>/api/credits/transactions</code></td>
              <td>GET</td>
              <td>Historique des transactions (pagination: limit, offset, type)</td>
            </tr>
            <tr>
              <td><code>/api/credits/costs</code></td>
              <td>GET</td>
              <td>Co&ucirc;ts par feature depuis Settings (mode cr&eacute;dits-only uniquement)</td>
            </tr>
            <tr>
              <td><code>/api/checkout/credits</code></td>
              <td>POST</td>
              <td>Cr&eacute;er session Stripe Checkout (mode <code>payment</code>) pour achat pack</td>
            </tr>
            <tr>
              <td><code>/api/subscription/credit-packs</code></td>
              <td>GET</td>
              <td>Liste des packs actifs (tri&eacute;s par creditAmount croissant)</td>
            </tr>
            <tr>
              <td><code>/api/subscription/invoices</code></td>
              <td>GET</td>
              <td>Factures Stripe (abonnements + cr&eacute;dits)</td>
            </tr>
          </tbody>
        </table>

        <h2>Fichiers Cl&eacute;s</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>R&ocirc;le</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/subscription/credits.js</code></td>
              <td>getCreditBalance, debitCredit, debitCredits, refundCredit, grantCredits, getCreditTransactions</td>
            </tr>
            <tr>
              <td><code>lib/subscription/creditCost.js</code></td>
              <td>getCreditCostForFeature(), isPremiumOnlyFeature() &mdash; co&ucirc;ts dynamiques depuis Settings DB</td>
            </tr>
            <tr>
              <td><code>lib/subscription/featureUsage.js</code></td>
              <td>canUseFeature(), incrementFeatureCounter(), refundFeatureUsage(), resetFeatureCounters()</td>
            </tr>
            <tr>
              <td><code>lib/subscription/macroFeatures.js</code></td>
              <td>MACRO_FEATURES (9 features), AI_FEATURES, getDefaultFeatureLimits()</td>
            </tr>
            <tr>
              <td><code>lib/creditCosts/CreditCostsContext.jsx</code></td>
              <td>React Context pour co&ucirc;ts c&ocirc;t&eacute; client + refresh SSE</td>
            </tr>
            <tr>
              <td><code>lib/events/dbEmitter.js</code></td>
              <td>&Eacute;v&eacute;nements SSE temps r&eacute;el (emitCreditsUpdate)</td>
            </tr>
            <tr>
              <td><code>app/api/credits/</code></td>
              <td>Routes balance, transactions, costs</td>
            </tr>
            <tr>
              <td><code>app/api/checkout/credits/</code></td>
              <td>Checkout Stripe pour achat de packs</td>
            </tr>
          </tbody>
        </table>

        <h2>Sections D&eacute;taill&eacute;es</h2>

        <ul>
          <li><a href="./welcome-credits.html">Cr&eacute;dits Bienvenue</a> &mdash; Attribution &agrave; l'inscription (dual mode)</li>
          <li><a href="./debit-refund.html">D&eacute;bit et Remboursement</a> &mdash; Op&eacute;rations sur le solde, idempotence, SSE</li>
          <li><a href="./feature-limits.html">Limites par Feature</a> &mdash; Macro-features, compteurs, canUseFeature()</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
