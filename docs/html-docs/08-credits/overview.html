<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Système de Crédits | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
        <aside class="sidebar">
      <div class="sidebar-header">
        <a href="index.html" class="sidebar-logo">FitMyCV<span class="accent">.io</span></a>
        <div class="sidebar-version">Documentation Technique v1.0.9.5</div>
      </div>

      <nav class="sidebar-nav">
        <!-- Introduction -->
        <div class="nav-section">
          <div class="nav-section-title">Introduction</div>
          <ul class="nav-list">
            <li class="nav-item"><a href="index.html">Accueil</a></li>
          </ul>
        </div>

        <!-- Architecture -->
        <div class="nav-section">
          <div class="nav-section-title">Architecture</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Architecture</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="01-architecture/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="01-architecture/tech-stack.html">Stack technologique</a></li>
                <li class="nav-item"><a href="01-architecture/database.html">Base de données</a></li>
                <li class="nav-item"><a href="01-architecture/patterns.html">Patterns</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Fonctionnalités Core -->
        <div class="nav-section">
          <div class="nav-section-title">Fonctionnalités Core</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Authentification</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="02-authentification/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="02-authentification/oauth-flow.html">OAuth Flow</a></li>
                <li class="nav-item"><a href="02-authentification/credentials-flow.html">Credentials</a></li>
                <li class="nav-item"><a href="02-authentification/email-verification.html">Vérification Email</a></li>
              </ul>
            </li>
            <li class="nav-item has-children">
              <a href="#">Gestion des CV</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="03-gestion-cv/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="03-gestion-cv/crud.html">CRUD</a></li>
                <li class="nav-item"><a href="03-gestion-cv/versioning.html">Versioning</a></li>
                <li class="nav-item"><a href="03-gestion-cv/import-pdf.html">Import PDF</a></li>
                <li class="nav-item"><a href="03-gestion-cv/structure-cv.html">Structure JSON</a></li>
              </ul>
            </li>
            <li class="nav-item has-children">
              <a href="#">Offres d'emploi</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="04-offres-emploi/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="04-offres-emploi/extraction-url.html">Extraction URL</a></li>
                <li class="nav-item"><a href="04-offres-emploi/extraction-pdf.html">Extraction PDF</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Pipelines IA -->
        <div class="nav-section">
          <div class="nav-section-title">Pipelines IA</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Génération CV</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="05-pipeline-generation/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/orchestrator.html">Orchestrateur</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/phase-classification.html">Classification</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/phase-batches.html">Batches</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/phase-recompose.html">Recomposition</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/prompts.html">Prompts IA</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/schemas-io.html">Schemas I/O</a></li>
              </ul>
            </li>
            <li class="nav-item has-children">
              <a href="#">Optimisation CV</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="06-pipeline-optimisation/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="06-pipeline-optimisation/scoring.html">Scoring</a></li>
                <li class="nav-item"><a href="06-pipeline-optimisation/suggestions.html">Suggestions</a></li>
                <li class="nav-item"><a href="06-pipeline-optimisation/application.html">Application</a></li>
                <li class="nav-item"><a href="06-pipeline-optimisation/review-system.html">Review</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Billing -->
        <div class="nav-section">
          <div class="nav-section-title">Billing</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Abonnements</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="07-abonnements/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="07-abonnements/business-models.html">Modèles économiques</a></li>
                <li class="nav-item"><a href="07-abonnements/plans-stripe.html">Plans Stripe</a></li>
                <li class="nav-item"><a href="07-abonnements/checkout-flow.html">Checkout</a></li>
                <li class="nav-item"><a href="07-abonnements/webhooks.html">Webhooks</a></li>
              </ul>
            </li>
            <li class="nav-item has-children">
              <a href="#">Crédits</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="08-credits/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="08-credits/welcome-credits.html">Crédits bienvenue</a></li>
                <li class="nav-item"><a href="08-credits/debit-refund.html">Débit / Remboursement</a></li>
                <li class="nav-item"><a href="08-credits/feature-limits.html">Limites Features</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Système -->
        <div class="nav-section">
          <div class="nav-section-title">Système</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Background Jobs</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="09-background-jobs/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="09-background-jobs/task-types.html">Types de tâches</a></li>
                <li class="nav-item"><a href="09-background-jobs/concurrency.html">Concurrence</a></li>
              </ul>
            </li>
            <li class="nav-item has-children">
              <a href="#">Export</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="10-export/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="10-export/pdf.html">Export PDF</a></li>
                <li class="nav-item"><a href="10-export/docx.html">Export DOCX</a></li>
              </ul>
            </li>
            <li class="nav-item"><a href="11-traduction/overview.html">Traduction</a></li>
          </ul>
        </div>

        <!-- Administration -->
        <div class="nav-section">
          <div class="nav-section-title">Administration</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Dashboard Admin</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="12-administration/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="12-administration/users.html">Utilisateurs</a></li>
                <li class="nav-item"><a href="12-administration/subscription-mode.html">Mode Abonnement</a></li>
                <li class="nav-item"><a href="12-administration/plans-management.html">Gestion Plans</a></li>
                <li class="nav-item"><a href="12-administration/credit-packs.html">Packs Crédits</a></li>
                <li class="nav-item"><a href="12-administration/openai-monitoring.html">Monitoring OpenAI</a></li>
                <li class="nav-item"><a href="12-administration/email-templates.html">Templates Email</a></li>
                <li class="nav-item"><a href="12-administration/settings.html">Paramètres</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Autres -->
        <div class="nav-section">
          <div class="nav-section-title">Autres</div>
          <ul class="nav-list">
            <li class="nav-item"><a href="13-onboarding/overview.html">Onboarding</a></li>
            <li class="nav-item has-children">
              <a href="#">Email</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="14-email/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="14-email/templates.html">Templates</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Référence -->
        <div class="nav-section">
          <div class="nav-section-title">Référence</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">API Reference</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="15-api-reference/index.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="15-api-reference/public.html">Publics</a></li>
                <li class="nav-item"><a href="15-api-reference/authenticated.html">Authentifiés</a></li>
                <li class="nav-item"><a href="15-api-reference/admin.html">Admin</a></li>
              </ul>
            </li>
            <li class="nav-item"><a href="16-composants/index.html">Composants React</a></li>
          </ul>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
            <header class="header">
        <button class="mobile-menu-button" title="Menu">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
        <div class="search-container">
          <input type="text" class="search-input" placeholder="Rechercher dans la documentation...">
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Changer le thème">
          <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
          </svg>
        </button>
      </header>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Crédits</span>
        </div>

        <h1>Système de Crédits</h1>
        <p class="lead">
          Le système de crédits permet de monétiser les fonctionnalités IA. Chaque action consomme un nombre défini de crédits, configurables en administration.
        </p>

        <h2>Architecture</h2>

        <div class="diagram">
          <div class="diagram-title">Flux de gestion des crédits</div>
          <div class="mermaid">
flowchart TB
    subgraph Sources["SOURCES DE CRÉDITS"]
        Welcome["Crédits bienvenue"]
        Purchase["Achat pack"]
        Refund["Remboursement"]
        Admin["Attribution admin"]
    end

    subgraph Balance["SOLDE"]
        CB[(CreditBalance)]
    end

    subgraph Usage["UTILISATION"]
        Check{{"canUseFeature()"}}
        Debit["debitCredit()"]
        Action["Action IA"]
    end

    subgraph Tracking["TRAÇABILITÉ"]
        CT[(CreditTransaction)]
    end

    Sources --> CB
    CB --> Check
    Check -->|"Crédits OK"| Debit
    Debit --> Action
    Debit --> CT
    Action -->|"Échec"| Refund
          </div>
        </div>

        <h2>Modèles de Données</h2>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>CreditBalance</code></td>
              <td>Solde utilisateur</td>
              <td>userId, balance (int)</td>
            </tr>
            <tr>
              <td><code>CreditTransaction</code></td>
              <td>Historique transactions</td>
              <td>userId, type, amount, reason, featureName, createdAt</td>
            </tr>
            <tr>
              <td><code>CreditPack</code></td>
              <td>Packs à l'achat</td>
              <td>name, credits, price, stripePriceId, isActive</td>
            </tr>
          </tbody>
        </table>

        <h2>Types de Transactions</h2>

        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Description</th>
              <th>Montant</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>welcome</code></td>
              <td>Crédits offerts à l'inscription</td>
              <td>+ (configurable, défaut: 5)</td>
            </tr>
            <tr>
              <td><code>purchase</code></td>
              <td>Achat de pack</td>
              <td>+ (selon pack)</td>
            </tr>
            <tr>
              <td><code>debit</code></td>
              <td>Utilisation feature</td>
              <td>- (selon feature)</td>
            </tr>
            <tr>
              <td><code>refund</code></td>
              <td>Remboursement (échec)</td>
              <td>+ (montant débité)</td>
            </tr>
            <tr>
              <td><code>admin_credit</code></td>
              <td>Attribution par admin</td>
              <td>+ ou -</td>
            </tr>
            <tr>
              <td><code>chargeback</code></td>
              <td>Contestation paiement</td>
              <td>- (négatif possible)</td>
            </tr>
          </tbody>
        </table>

        <h2>Coûts par Feature</h2>

        <p>Les coûts sont configurables via la table <code>Setting</code> :</p>

        <table>
          <thead>
            <tr>
              <th>Feature</th>
              <th>Coût</th>
              <th>Setting Key</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Création CV manuelle</td>
              <td><strong>1</strong> crédit</td>
              <td><code>credits_create_cv_manual</code></td>
            </tr>
            <tr>
              <td>Export CV (PDF/DOCX)</td>
              <td><strong>1</strong> crédit</td>
              <td><code>credits_export_cv</code></td>
            </tr>
            <tr>
              <td>Calcul match score</td>
              <td><strong>1</strong> crédit</td>
              <td><code>credits_match_score</code></td>
            </tr>
            <tr>
              <td>Traduction CV</td>
              <td><strong>1</strong> crédit</td>
              <td><code>credits_translate_cv</code></td>
            </tr>
            <tr>
              <td>Génération CV (offre)</td>
              <td><strong>2</strong> crédits</td>
              <td><code>credits_gpt_cv_generation</code></td>
            </tr>
            <tr>
              <td>Optimisation CV</td>
              <td><strong>2</strong> crédits</td>
              <td><code>credits_optimize_cv</code></td>
            </tr>
            <tr>
              <td>Génération depuis titre</td>
              <td><strong>3</strong> crédits</td>
              <td><code>credits_generate_cv_from_job_title</code></td>
            </tr>
            <tr>
              <td>Import PDF</td>
              <td><strong>5</strong> crédits</td>
              <td><code>credits_import_pdf</code></td>
            </tr>
          </tbody>
        </table>

        <h2>API Crédits</h2>

        <h3>Débiter un crédit</h3>

        <pre><code>// lib/subscription/credits.js

export async function debitCredit(userId, amount, featureName, reason = null) {
  // Transaction atomique
  return prisma.$transaction(async (tx) => {
    // 1. Récupérer le solde actuel
    const balance = await tx.creditBalance.findUnique({
      where: { userId }
    });

    if (!balance || balance.balance < amount) {
      throw new Error('Insufficient credits');
    }

    // 2. Décrémenter le solde
    await tx.creditBalance.update({
      where: { userId },
      data: { balance: { decrement: amount } }
    });

    // 3. Créer la transaction
    return tx.creditTransaction.create({
      data: {
        userId,
        type: 'debit',
        amount: -amount,
        featureName,
        reason: reason || `Usage: ${featureName}`,
        balanceAfter: balance.balance - amount
      }
    });
  });
}</code></pre>

        <h3>Rembourser un crédit</h3>

        <pre><code>export async function refundCredit(userId, amount, featureName, reason) {
  return prisma.$transaction(async (tx) => {
    // 1. Incrémenter le solde
    const updated = await tx.creditBalance.update({
      where: { userId },
      data: { balance: { increment: amount } }
    });

    // 2. Créer la transaction
    return tx.creditTransaction.create({
      data: {
        userId,
        type: 'refund',
        amount: amount, // Positif
        featureName,
        reason,
        balanceAfter: updated.balance
      }
    });
  });
}</code></pre>

        <h3>Vérifier le solde</h3>

        <pre><code>export async function getCreditBalance(userId) {
  const balance = await prisma.creditBalance.findUnique({
    where: { userId }
  });

  return balance?.balance ?? 0;
}

export async function hasEnoughCredits(userId, amount) {
  const balance = await getCreditBalance(userId);
  return balance >= amount;
}</code></pre>

        <h2>Packs de Crédits</h2>

        <div class="card-grid">
          <div class="card">
            <h4>Pack Starter</h4>
            <ul>
              <li><strong>5</strong> crédits</li>
              <li><strong>4.99€</strong></li>
              <li>~1€ / crédit</li>
            </ul>
          </div>
          <div class="card">
            <h4>Pack Standard</h4>
            <ul>
              <li><strong>10</strong> crédits</li>
              <li><strong>8.99€</strong></li>
              <li>~0.90€ / crédit</li>
            </ul>
          </div>
          <div class="card">
            <h4>Pack Pro</h4>
            <ul>
              <li><strong>25</strong> crédits</li>
              <li><strong>19.99€</strong></li>
              <li>~0.80€ / crédit</li>
            </ul>
          </div>
        </div>

        <h2>Flux d'Achat</h2>

        <div class="diagram">
          <div class="diagram-title">Processus d'achat de crédits</div>
          <div class="mermaid">
sequenceDiagram
    participant U as Utilisateur
    participant App as Application
    participant Stripe as Stripe
    participant DB as PostgreSQL

    U->>App: Sélectionne pack
    App->>Stripe: Créer Checkout Session
    Stripe-->>App: Session URL
    App-->>U: Redirection Stripe

    U->>Stripe: Paiement
    Stripe->>App: Webhook: checkout.session.completed
    App->>DB: creditCredit(userId, packCredits)
    App->>DB: Créer CreditTransaction (purchase)
    App-->>U: Redirection succès
          </div>
        </div>

        <h2>Gestion Balance Négative</h2>

        <div class="callout callout-warning">
          <div class="callout-title">Chargeback Protection</div>
          <p>En cas de contestation de paiement (chargeback), les crédits sont débités même si cela rend le solde négatif. L'utilisateur est bloqué jusqu'à régularisation.</p>
        </div>

        <pre><code>// Vérification dans canUseFeature()
const balance = await getCreditBalance(userId);

if (balance < 0) {
  return {
    canUse: false,
    reason: 'balance_negative',
    message: 'Votre solde est négatif suite à une contestation de paiement.'
  };
}</code></pre>

        <h2>API Endpoints</h2>

        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Méthode</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/api/credits/balance</code></td>
              <td>GET</td>
              <td>Récupérer le solde</td>
            </tr>
            <tr>
              <td><code>/api/credits/transactions</code></td>
              <td>GET</td>
              <td>Historique des transactions</td>
            </tr>
            <tr>
              <td><code>/api/credits/purchase</code></td>
              <td>POST</td>
              <td>Initier achat (Stripe Checkout)</td>
            </tr>
            <tr>
              <td><code>/api/admin/credit-packs</code></td>
              <td>GET/POST</td>
              <td>Gestion packs (admin)</td>
            </tr>
            <tr>
              <td><code>/api/admin/users/[id]/credits</code></td>
              <td>POST</td>
              <td>Attribution manuelle (admin)</td>
            </tr>
          </tbody>
        </table>

        <h2>Fichiers Clés</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Rôle</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/subscription/credits.js</code></td>
              <td>Logique crédit/débit/refund</td>
            </tr>
            <tr>
              <td><code>lib/subscription/creditCost.js</code></td>
              <td>Coûts par feature</td>
            </tr>
            <tr>
              <td><code>lib/subscription/featureUsage.js</code></td>
              <td>canUseFeature() intégré</td>
            </tr>
            <tr>
              <td><code>app/api/credits/</code></td>
              <td>Endpoints crédits</td>
            </tr>
          </tbody>
        </table>

      </div>
    </main>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/main.js"></script>
</body>
</html>
