<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Onboarding - Vue d'ensemble | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>
    <main class="main">
      <div id="header-container"></div>
      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Onboarding</span>
        </div>

        <h1>Onboarding</h1>
        <p class="lead">
          Tutoriel guid√© en 9 √©tapes avec modals, tooltips et validation progressive. L'√©tat est persist√© en JSON dans le mod√®le <code>User</code> (champ <code>onboardingState</code>), synchronis√© en temps r√©el via SSE, avec protection anti-r√©gression et gestion admin.
        </p>

        <h2>Architecture</h2>

        <div class="diagram">
          <div class="diagram-title">Flux d'onboarding</div>
          <div class="mermaid">
flowchart TB
    subgraph Client["CLIENT (React)"]
        Hook["useOnboarding() hook"]
        Modal["Modal / Carousel"]
        Tooltip["Tooltip guid√©"]
        Actions["Actions utilisateur"]
    end

    subgraph API["API (/api/user/onboarding/)"]
        GET["GET ‚Äî Lire l'√©tat"]
        PUT["PUT ‚Äî Mettre √† jour l'√©tat"]
        PATCH["PATCH ‚Äî Mise √† jour partielle"]
        POST["POST ‚Äî Actions (complete/skip/reset)"]
        Cache["Cache en m√©moire (TTL 1000ms)"]
        AntiRegress["Protection anti-r√©gression (409)"]
    end

    subgraph State["√âTAT (lib/onboarding/)"]
        Config["onboardingConfig.js ‚Äî Timings, API"]
        Constants["onboardingConstants.js ‚Äî 9 √©tapes"]
        Steps["onboardingSteps.js ‚Äî Factory i18n"]
        StateLib["onboardingState.js ‚Äî Mutations"]
    end

    subgraph DB["BASE DE DONN√âES"]
        User["User.onboardingState (JSON)"]
    end

    subgraph SSE["TEMPS R√âEL"]
        Emitter["dbEmitter.emit('onboarding:updated')"]
        Stream["SSE /api/events/stream"]
    end

    Hook --> GET
    Actions --> PUT
    Actions --> POST
    GET --> Cache --> User
    PUT --> AntiRegress --> User
    POST --> User
    User --> Emitter --> Stream --> Hook

    Config --> Steps
    Constants --> Steps
    StateLib --> API
          </div>
        </div>

        <h2>Les 9 √©tapes</h2>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Cl√©</th>
              <th>Type</th>
              <th>Description</th>
              <th>Validation</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td><code>edit_mode</code></td>
              <td>Modal + Tooltip</td>
              <td>Introduction au mode d'√©dition de CV</td>
              <td>Fermeture du modal et du tooltip</td>
            </tr>
            <tr>
              <td>2</td>
              <td><code>ai_generation</code></td>
              <td>Modal + Tooltip</td>
              <td>Premi√®re g√©n√©ration de CV par IA (URL ou PDF d'offre d'emploi)</td>
              <td>Compl√©tion d'une t√¢che <code>AI_GENERATION_TYPES</code></td>
            </tr>
            <tr>
              <td>3</td>
              <td><code>task_manager</code></td>
              <td>Tooltip</td>
              <td>D√©couverte du gestionnaire de t√¢ches background</td>
              <td>Fermeture du tooltip</td>
            </tr>
            <tr>
              <td>4</td>
              <td><code>open_generated_cv</code></td>
              <td>Tooltip</td>
              <td>Ouverture et consultation du CV g√©n√©r√©</td>
              <td>Pr√©condition : <code>step4.cvGenerated</code> doit √™tre <code>true</code></td>
            </tr>
            <tr>
              <td>5</td>
              <td><code>ai_review</code></td>
              <td>Modal + Tooltip</td>
              <td>Analyse et revue IA du CV</td>
              <td>Lancement de la revue IA</td>
            </tr>
            <tr>
              <td>6</td>
              <td><code>match_score</code></td>
              <td>Tooltip</td>
              <td>Calcul du score de correspondance CV ‚Üî offre</td>
              <td>Lancement du calcul de score</td>
            </tr>
            <tr>
              <td>7</td>
              <td><code>optimization</code></td>
              <td>Modal + Tooltip</td>
              <td>Optimisation ATS du CV</td>
              <td>Lancement de l'optimisation</td>
            </tr>
            <tr>
              <td>8</td>
              <td><code>history</code></td>
              <td>Modal + Tooltip</td>
              <td>Consultation de l'historique et des versions du CV</td>
              <td>Ouverture de l'historique</td>
            </tr>
            <tr>
              <td>9</td>
              <td><code>export</code></td>
              <td>Modal + Tooltip</td>
              <td>Export du CV en PDF ou DOCX</td>
              <td>D√©clenchement d'un export</td>
            </tr>
          </tbody>
        </table>

        <h2>Configuration</h2>

        <h3>Constantes de timing</h3>

        <table>
          <thead>
            <tr>
              <th>Constante</th>
              <th>Valeur</th>
              <th>Usage</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>STEP_TRANSITION_DELAY</code></td>
              <td>2000 ms</td>
              <td>D√©lai entre la validation d'une √©tape et l'affichage de la suivante</td>
            </tr>
            <tr>
              <td><code>STEPS_WITHOUT_TIMER</code></td>
              <td><code>['ai_generation', 'task_manager']</code></td>
              <td>Steps qui s'encha√Ænent imm√©diatement (pas de d√©lai de transition)</td>
            </tr>
            <tr>
              <td><code>WELCOME_MORPH_DURATION</code></td>
              <td>700 ms</td>
              <td>Animation de morphing du modal de bienvenue vers la checklist</td>
            </tr>
            <tr>
              <td><code>MODAL_CLOSE_ANIMATION_DURATION</code></td>
              <td>300 ms</td>
              <td>Dur√©e de fermeture des modals</td>
            </tr>
            <tr>
              <td><code>STEP_VALIDATION_DELAY</code></td>
              <td>500 ms</td>
              <td>D√©lai avant validation automatique d'un step</td>
            </tr>
            <tr>
              <td><code>STEP_CELEBRATION_DURATION</code></td>
              <td>1500 ms</td>
              <td>Dur√©e de la c√©l√©bration (confetti + son) entre les √©tapes</td>
            </tr>
            <tr>
              <td><code>BUTTON_POLLING_INTERVAL</code></td>
              <td>200 ms</td>
              <td>Intervalle de recherche des boutons dans le DOM</td>
            </tr>
            <tr>
              <td><code>BUTTON_POLLING_TIMEOUT</code></td>
              <td>10000 ms</td>
              <td>Timeout max avant abandon de la recherche de boutons</td>
            </tr>
            <tr>
              <td><code>ELEMENT_POSITION_RETRY_INTERVAL</code></td>
              <td>100 ms</td>
              <td>Intervalle entre tentatives de recherche d'√©l√©ment (useElementPosition)</td>
            </tr>
            <tr>
              <td><code>ELEMENT_POSITION_MAX_RETRIES</code></td>
              <td>50</td>
              <td>Max tentatives de recherche d'√©l√©ment (5s total)</td>
            </tr>
            <tr>
              <td><code>LOADING_TO_ONBOARDING_DELAY</code></td>
              <td>1000 ms</td>
              <td>D√©lai entre fermeture du loading screen et affichage du welcome modal</td>
            </tr>
            <tr>
              <td><code>CACHE_TTL</code></td>
              <td>1000 ms</td>
              <td>Dur√©e du cache en m√©moire de l'√©tat onboarding (API)</td>
            </tr>
            <tr>
              <td><code>MAX_RETRY_ATTEMPTS</code></td>
              <td>3</td>
              <td>Nombre maximum de tentatives de retry API</td>
            </tr>
          </tbody>
        </table>

        <h3>D√©finition des √©tapes</h3>

        <p>Les 9 √©tapes principales (id 1-9) sont d√©finies dans <code>onboardingConstants.js</code>, plus une √©tape Welcome (id 0) :</p>

        <pre><code class="language-javascript">export const ONBOARDING_STEPS_COUNT = 9;

// √âtape Welcome (√©tape 0, admin uniquement)
export const WELCOME_STEP = { id: 0, key: 'welcome', emoji: 'üëã' };

// √âtapes principales (1-9)
export const STEP_DEFINITIONS = [
  { id: 1, key: 'edit_mode', emoji: '‚úèÔ∏è' },
  { id: 2, key: 'ai_generation', emoji: '‚ú®' },
  { id: 3, key: 'task_manager', emoji: 'üìã' },
  { id: 4, key: 'open_generated_cv', emoji: 'üìÑ' },
  { id: 5, key: 'ai_review', emoji: 'üîç' },
  { id: 6, key: 'match_score', emoji: 'üéØ' },
  { id: 7, key: 'optimization', emoji: 'üöÄ' },
  { id: 8, key: 'history', emoji: 'üîÑ' },
  { id: 9, key: 'export', emoji: 'üì•' },
];

// D√©finitions incluant Welcome (pour admin)
export const ADMIN_STEP_DEFINITIONS = [WELCOME_STEP, ...STEP_DEFINITIONS];</code></pre>

        <h2>√âtat de l'onboarding</h2>

        <p>L'√©tat est stock√© en JSON dans <code>User.onboardingState</code> :</p>

        <pre><code class="language-javascript">// DEFAULT_ONBOARDING_STATE
{
  currentStep: 0,
  completedSteps: [],
  hasCompleted: false,
  isSkipped: false,
  modals: {
    welcome: { completed: false },
    step1: { completed: false },    // edit_mode
    step2: { completed: false },    // ai_generation
    step5: { completed: false },    // ai_review
    step7: { completed: false },    // optimization
    step8: { completed: false },    // history
    step9: { completed: false },    // export
    completion: { completed: false },
  },
  tooltips: {
    "1": { closedManually: false },
    "2": { closedManually: false },
    "3": { closedManually: false },
    "4": { closedManually: false },
    "5": { closedManually: false },
    "6": { closedManually: false },
    "7": { closedManually: false },
    "8": { closedManually: false },
    "9": { closedManually: false },
  },
  timestamps: {
    startedAt: null,
    completedAt: null,
    skippedAt: null,
    lastStepChangeAt: null,
  },
  step4: {
    cvGenerated: false,
    cvFilename: null,
  },
}</code></pre>

        <h3>Fonctions de mutation</h3>

        <p>Le module <code>onboardingState.js</code> fournit des fonctions pures de mutation :</p>

        <ul>
          <li><code>markModalCompleted(state, stepKey)</code> ‚Äî Marquer un modal comme compl√©t√©</li>
          <li><code>markTooltipClosed(state, stepKey)</code> ‚Äî Marquer un tooltip comme ferm√©</li>
          <li><code>markStepCompleted(state, stepKey)</code> ‚Äî Marquer une √©tape comme compl√©t√©e et l'ajouter √† <code>completedSteps[]</code></li>
          <li><code>updateCurrentStep(state, stepIndex)</code> ‚Äî Mettre √† jour l'√©tape courante</li>
          <li><code>markOnboardingCompleted(state)</code> ‚Äî Terminer l'onboarding (<code>hasCompleted: true</code>)</li>
          <li><code>updateStep4Preconditions(state)</code> ‚Äî Mettre √† jour les pr√©conditions de l'√©tape 4 (<code>step4.cvGenerated</code>)</li>
          <li><code>normalizeOnboardingState(state)</code> ‚Äî Normaliser l'√©tat (ajouter les champs manquants)</li>
          <li><code>validateOnboardingState(state)</code> ‚Äî Valider la coh√©rence de l'√©tat</li>
        </ul>

        <h2>API Onboarding</h2>

        <p>Le endpoint <code>/api/user/onboarding</code> g√®re 4 m√©thodes HTTP :</p>

        <table>
          <thead>
            <tr>
              <th>M√©thode</th>
              <th>Action</th>
              <th>D√©tails</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>GET</code></td>
              <td>Lire l'√©tat</td>
              <td>Cache en m√©moire avec TTL de 1000ms. Retourne l'√©tat normalis√©.</td>
            </tr>
            <tr>
              <td><code>PUT</code></td>
              <td>Mettre √† jour</td>
              <td>Mise √† jour de l'√©tape courante. <strong>Protection anti-r√©gression</strong> : retourne 409 si <code>currentStep</code> recule.</td>
            </tr>
            <tr>
              <td><code>PATCH</code></td>
              <td>Mise √† jour partielle</td>
              <td>Merge partiel de l'√©tat (ex : un seul champ d'une √©tape). Cache invalid√© apr√®s mise √† jour.</td>
            </tr>
            <tr>
              <td><code>POST</code></td>
              <td>Actions</td>
              <td>3 actions : <code>complete</code> (terminer), <code>skip</code> (passer), <code>reset</code> (r√©initialiser).</td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-warning">
          <strong>Anti-r√©gression</strong> ‚Äî La route PUT retourne une erreur 409 (Conflict) si le client essaie de diminuer le <code>currentStep</code>. Cela emp√™che les conditions de course entre plusieurs onglets ou appareils.
        </div>

        <h2>Synchronisation temps r√©el</h2>

        <p>Chaque modification de l'√©tat d'onboarding √©met un √©v√©nement SSE :</p>

        <pre><code class="language-javascript">// Apr√®s mise √† jour en DB
dbEmitter.emit('onboarding:updated', {
  userId,
  data: updatedState,
});

// Le client React re√ßoit l'√©v√©nement via SSE
// et met √† jour le hook useOnboarding()</code></pre>

        <p>Le endpoint SSE √©coute aussi <code>onboarding:reset</code> pour g√©rer la r√©initialisation admin.</p>

        <h2>Factory i18n</h2>

        <p>La fonction <code>createOnboardingSteps(t)</code> dans <code>onboardingSteps.js</code> g√©n√®re les 9 √©tapes avec :</p>

        <ul>
          <li><code>targetSelector</code> ‚Äî S√©lecteur CSS de l'√©l√©ment cible pour le tooltip</li>
          <li><code>tooltip</code> ‚Äî Configuration du tooltip (titre, description, position)</li>
          <li><code>modal</code> ‚Äî Configuration du modal avec carousel (√©crans multiples) ‚Äî pr√©sent aux √©tapes 1, 2, 5, 7, 8, 9</li>
          <li><code>validation</code> ‚Äî R√®gles de validation pour passer √† l'√©tape suivante</li>
          <li><code>preconditions</code> ‚Äî Conditions requises pour afficher l'√©tape (ex : √©tape 4 n√©cessite <code>step4.cvGenerated</code>)</li>
          <li><code>fallback</code> ‚Äî Comportement alternatif si la pr√©condition √©choue</li>
        </ul>

        <p>Toutes les cha√Ænes de caract√®res sont pass√©es par la fonction de traduction <code>t()</code> pour supporter l'internationalisation.</p>

        <h3>Mapping modals ‚Üí √©tapes</h3>

        <p>Le module <code>onboardingConfig.js</code> d√©finit le mapping <code>STEP_TO_MODAL_KEY</code> entre les √©tapes et les cl√©s de modals dans l'√©tat :</p>

        <table>
          <thead>
            <tr>
              <th>√âtape</th>
              <th>Cl√© modal</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>welcome</code> (√©tape 0)</td>
              <td><code>welcome</code></td>
            </tr>
            <tr>
              <td><code>edit_mode</code> (√©tape 1)</td>
              <td><code>step1</code></td>
            </tr>
            <tr>
              <td><code>ai_generation</code> (√©tape 2)</td>
              <td><code>step2</code></td>
            </tr>
            <tr>
              <td><code>ai_review</code> (√©tape 5)</td>
              <td><code>step5</code></td>
            </tr>
            <tr>
              <td><code>optimization</code> (√©tape 7)</td>
              <td><code>step7</code></td>
            </tr>
            <tr>
              <td><code>history</code> (√©tape 8)</td>
              <td><code>step8</code></td>
            </tr>
            <tr>
              <td><code>export</code> (√©tape 9)</td>
              <td><code>step9</code></td>
            </tr>
          </tbody>
        </table>

        <h2>Actions disponibles</h2>

        <pre><code class="language-javascript">// Objet ONBOARDING_ACTIONS export√© par onboardingSteps.js
ONBOARDING_ACTIONS = {
  complete: 'complete',  // Terminer l'onboarding normalement
  skip: 'skip',          // Passer l'onboarding
  reset: 'reset',        // R√©initialiser (admin)
}</code></pre>

        <h2>Admin</h2>

        <p>L'interface admin dispose de deux endpoints d√©di√©s :</p>

        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/api/admin/onboarding/analytics</code></td>
              <td>KPIs : totalUsers, started, completed, skipped, inProgress, stuck, completionRate, skipRate, avgCompletionTime, healthScore. Funnel par √©tape, analyse des abandons, stats modals, timeline.</td>
            </tr>
            <tr>
              <td><code>/api/admin/onboarding/reset</code></td>
              <td>R√©initialisation de l'√©tat d'onboarding d'un utilisateur. √âmet <code>onboarding:reset</code> via SSE.</td>
            </tr>
          </tbody>
        </table>

        <h2>Fichiers cl√©s</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>R√¥le</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/onboarding/onboardingConfig.js</code></td>
              <td>Constantes de timing, configuration API, mapping <code>STEP_TO_MODAL_KEY</code></td>
            </tr>
            <tr>
              <td><code>lib/onboarding/onboardingConstants.js</code></td>
              <td>D√©finition des 9 √©tapes (id, key, emoji), constantes</td>
            </tr>
            <tr>
              <td><code>lib/onboarding/onboardingSteps.js</code></td>
              <td>Factory i18n <code>createOnboardingSteps(t)</code>, modals, tooltips, validation</td>
            </tr>
            <tr>
              <td><code>lib/onboarding/onboardingState.js</code></td>
              <td>√âtat par d√©faut, fonctions de mutation, validation, normalisation</td>
            </tr>
            <tr>
              <td><code>app/api/user/onboarding/route.js</code></td>
              <td>API REST (GET/PUT/PATCH/POST) avec cache, anti-r√©gression, SSE</td>
            </tr>
            <tr>
              <td><code>app/api/admin/onboarding/analytics/route.js</code></td>
              <td>KPIs et analytics d'onboarding (admin)</td>
            </tr>
            <tr>
              <td><code>app/api/admin/onboarding/reset/route.js</code></td>
              <td>R√©initialisation d'onboarding utilisateur (admin)</td>
            </tr>
          </tbody>
        </table>

      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
