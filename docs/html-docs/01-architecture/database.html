<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Base de Données | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <!-- Sidebar injectée par layout.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="main">
      <!-- Header injecté par layout.js -->
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <a href="./overview.html">Architecture</a>
          <span>/</span>
          <span>Base de données</span>
        </div>

        <h1>Base de Données</h1>
        <p class="lead">
          FitMyCV.io utilise PostgreSQL via Prisma ORM avec 34 modèles de données organisés en domaines fonctionnels.
        </p>

        <h2>Schéma Relationnel</h2>

        <div class="diagram">
          <div class="diagram-title">Relations principales - Utilisateur</div>
          <div class="mermaid">
flowchart TB
    User["<strong>User</strong><br/>id, email, name, role"]

    subgraph CV["CV & Documents"]
        CvFile["<strong>CvFile</strong><br/>content JSON, matchScore"]
        CvVersion["<strong>CvVersion</strong><br/>versionNumber, origin"]
    end

    subgraph Jobs["Offres d'Emploi"]
        JobOffer["<strong>JobOffer</strong><br/>title, company, requirements"]
        CvGenerationOffer["<strong>CvGenerationOffer</strong><br/>status, generatedCvId"]
    end

    subgraph Billing["Facturation"]
        Subscription["<strong>Subscription</strong><br/>status, periodEnd"]
        CreditBalance["<strong>CreditBalance</strong><br/>balance"]
        CreditTransaction["<strong>CreditTransaction</strong><br/>amount, type"]
    end

    User --> CvFile
    User --> JobOffer
    User --> Subscription
    User --> CreditBalance
    User --> CreditTransaction

    CvFile --> CvVersion
    CvFile --> CvGenerationOffer
    JobOffer --> CvGenerationOffer
          </div>
        </div>

        <div class="diagram">
          <div class="diagram-title">Relations principales - Génération & Abonnements</div>
          <div class="mermaid">
flowchart TB
    subgraph Generation["Pipeline Génération"]
        CvGenerationTask["<strong>CvGenerationTask</strong><br/>mode, status, progress"]
        CvGenerationOffer["<strong>CvGenerationOffer</strong><br/>status, matchScore"]
        CvGenerationSubtask["<strong>CvGenerationSubtask</strong><br/>phase, status"]
    end

    subgraph Plans["Plans & Limites"]
        SubscriptionPlan["<strong>SubscriptionPlan</strong><br/>name, price, features"]
        FeatureLimit["<strong>FeatureLimit</strong><br/>feature, monthlyLimit"]
        FeatureUsageCounter["<strong>FeatureUsageCounter</strong><br/>feature, count, month"]
    end

    CvGenerationTask --> CvGenerationOffer
    CvGenerationTask --> CvGenerationSubtask

    SubscriptionPlan --> FeatureLimit
    User["<strong>User</strong>"] --> FeatureUsageCounter
          </div>
        </div>

        <h2>Domaines Fonctionnels</h2>

        <h3>1. Utilisateurs & Auth</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>User</code></td>
              <td>Utilisateur principal</td>
              <td>id, email, name, role, hashedPassword</td>
            </tr>
            <tr>
              <td><code>Account</code></td>
              <td>Comptes OAuth liés</td>
              <td>provider, providerAccountId, access_token</td>
            </tr>
            <tr>
              <td><code>Session</code></td>
              <td>Sessions actives</td>
              <td>sessionToken, expires</td>
            </tr>
            <tr>
              <td><code>VerificationToken</code></td>
              <td>Tokens de vérification email</td>
              <td>identifier, token, expires</td>
            </tr>
          </tbody>
        </table>

        <h3>2. CV & Documents</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>CvFile</code></td>
              <td>CV stocké en JSON</td>
              <td>content (JSON), matchScore, isDefault, jobOfferId</td>
            </tr>
            <tr>
              <td><code>CvVersion</code></td>
              <td>Historique des versions</td>
              <td>versionNumber, content, origin, description</td>
            </tr>
            <tr>
              <td><code>CvTemplate</code></td>
              <td>Templates de CV</td>
              <td>name, structure, isDefault</td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-info">
          <div class="callout-title">Stockage du contenu CV</div>
          <p>Le contenu du CV est stocké en JSON dans le champ <code>content</code> de <code>CvFile</code>. Structure : sections (experiences, skills, education, etc.) avec leurs items.</p>
        </div>

        <h3>3. Offres d'Emploi</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>JobOffer</code></td>
              <td>Offre d'emploi extraite</td>
              <td>url, content (JSON), extractedAt</td>
            </tr>
            <tr>
              <td><code>JobOfferRaw</code></td>
              <td>Contenu brut de la page</td>
              <td>html, text, fetchedAt</td>
            </tr>
          </tbody>
        </table>

        <h3>4. Génération CV (Pipeline)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>CvGenerationTask</code></td>
              <td>Tâche master de génération</td>
              <td>userId, status, mode, totalOffers, creditsRefunded</td>
            </tr>
            <tr>
              <td><code>CvGenerationOffer</code></td>
              <td>Offre à traiter dans une tâche</td>
              <td>taskId, jobOfferId, status, classificationResult</td>
            </tr>
            <tr>
              <td><code>CvGenerationSubtask</code></td>
              <td>Sous-tâche IA (traçabilité)</td>
              <td>type, input, output, tokens, cost, duration</td>
            </tr>
          </tbody>
        </table>

        <h3>5. Abonnements & Crédits</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>Subscription</code></td>
              <td>Abonnement Stripe actif</td>
              <td>stripeSubscriptionId, status, currentPeriodEnd</td>
            </tr>
            <tr>
              <td><code>SubscriptionPlan</code></td>
              <td>Plans disponibles</td>
              <td>name, priceMonthly, stripePriceId</td>
            </tr>
            <tr>
              <td><code>FeatureLimit</code></td>
              <td>Limites par plan/feature</td>
              <td>planId, featureName, usageLimit, isEnabled</td>
            </tr>
            <tr>
              <td><code>FeatureUsageCounter</code></td>
              <td>Compteurs mensuels</td>
              <td>userId, featureName, count, periodStart</td>
            </tr>
            <tr>
              <td><code>CreditBalance</code></td>
              <td>Solde crédits utilisateur</td>
              <td>userId, balance</td>
            </tr>
            <tr>
              <td><code>CreditTransaction</code></td>
              <td>Historique transactions</td>
              <td>type, amount, reason, featureName</td>
            </tr>
            <tr>
              <td><code>CreditPack</code></td>
              <td>Packs à l'achat</td>
              <td>name, credits, price, isActive</td>
            </tr>
          </tbody>
        </table>

        <h3>6. OpenAI Monitoring</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>OpenAIUsageLog</code></td>
              <td>Log de chaque appel API</td>
              <td>userId, featureName, model, tokens, cost</td>
            </tr>
            <tr>
              <td><code>OpenAICostAlert</code></td>
              <td>Configuration alertes</td>
              <td>type, threshold, isEnabled</td>
            </tr>
            <tr>
              <td><code>OpenAICostNotification</code></td>
              <td>Alertes déclenchées</td>
              <td>alertId, currentValue, triggeredAt</td>
            </tr>
          </tbody>
        </table>

        <h3>7. Email & Notifications</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>EmailTemplate</code></td>
              <td>Templates email</td>
              <td>name, subject, htmlContent, trigger</td>
            </tr>
            <tr>
              <td><code>EmailLog</code></td>
              <td>Historique envois</td>
              <td>templateId, recipient, status, sentAt</td>
            </tr>
          </tbody>
        </table>

        <h3>8. Configuration</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>Setting</code></td>
              <td>Paramètres système</td>
              <td>key, value, category, description</td>
            </tr>
            <tr>
              <td><code>BackgroundTask</code></td>
              <td>Tâches asynchrones</td>
              <td>type, status, payload, result</td>
            </tr>
          </tbody>
        </table>

        <h2>Indexes et Performance</h2>

        <pre><code>// Indexes critiques définis dans schema.prisma

// Recherche rapide des CV par utilisateur
@@index([userId], map: "CvFile_userId_idx")

// Recherche offres par URL (cache)
@@unique([url, userId], map: "JobOffer_url_userId_key")

// Compteurs par période
@@unique([userId, featureName, periodStart], map: "FeatureUsageCounter_unique")

// Logs OpenAI pour analytics
@@index([userId, createdAt], map: "OpenAIUsageLog_user_date_idx")
@@index([featureName, createdAt], map: "OpenAIUsageLog_feature_date_idx")</code></pre>

        <h2>Migrations</h2>

        <div class="card-grid">
          <div class="card">
            <h4>Créer une migration</h4>
            <pre><code>npx prisma migrate dev --name description</code></pre>
          </div>
          <div class="card">
            <h4>Appliquer en production</h4>
            <pre><code>npx prisma migrate deploy</code></pre>
          </div>
          <div class="card">
            <h4>Régénérer le client</h4>
            <pre><code>npx prisma generate</code></pre>
          </div>
        </div>

        <h2>Connexion à la Base</h2>

        <pre><code>// lib/prisma.js - Singleton Prisma Client
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis;

const prisma = globalForPrisma.prisma ?? new PrismaClient({
  log: process.env.NODE_ENV === 'development'
    ? ['query', 'error', 'warn']
    : ['error'],
});

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma;
}

export default prisma;</code></pre>

        <div class="callout callout-warning">
          <div class="callout-title">Connection Pooling</div>
          <p>En production, utiliser un connection pooler (PgBouncer) pour gérer les connexions. La variable <code>DATABASE_URL</code> doit pointer vers le pooler.</p>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
