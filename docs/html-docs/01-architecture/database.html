<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Base de Données | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <!-- Sidebar injectée par layout.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="main">
      <!-- Header injecté par layout.js -->
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <a href="./overview.html">Architecture</a>
          <span>/</span>
          <span>Base de données</span>
        </div>

        <h1>Base de Données</h1>
        <p class="lead">
          FitMyCV.io utilise PostgreSQL via Prisma 6 ORM avec 34 modèles de données organisés en 9 domaines fonctionnels.
        </p>

        <h2>Schéma Relationnel</h2>

        <div class="diagram">
          <div class="diagram-title">Relations principales - Utilisateur</div>
          <div class="mermaid">
erDiagram
    User ||--o{ CvFile : possède
    User ||--o{ JobOffer : crée
    User ||--o| Subscription : souscrit
    User ||--o| CreditBalance : possède
    User ||--o{ CreditTransaction : effectue
    User ||--o{ Account : "OAuth lié"
    User ||--o{ BackgroundTask : lance
    User ||--o{ CvGenerationTask : génère
    User ||--o{ ExportTemplate : configure

    CvFile ||--o{ CvVersion : historique
    CvFile }o--o| JobOffer : "adapté pour"
    CvFile }o--o| CreditTransaction : "crédit utilisé"

    JobOffer ||--o{ CvFile : "CVs générés"

    CvGenerationTask ||--o{ CvGenerationOffer : contient
    CvGenerationOffer ||--o{ CvGenerationSubtask : exécute

    Subscription }o--|| SubscriptionPlan : "plan choisi"
    SubscriptionPlan ||--o{ SubscriptionPlanFeatureLimit : "limites"
          </div>
        </div>

        <div class="diagram">
          <div class="diagram-title">Relations - Email & Monitoring</div>
          <div class="mermaid">
erDiagram
    EmailTrigger ||--o{ EmailTemplate : "templates associés"
    EmailTemplate ||--o{ EmailLog : "envois"

    User ||--o{ OpenAIUsage : "usage agrégé"
    User ||--o{ OpenAICall : "appels individuels"
    User ||--o{ TelemetryEvent : "événements"
    User ||--o{ FeatureUsage : "utilisation features"
    User ||--o{ FeatureUsageCounter : "compteurs mensuels"
    User ||--o{ Feedback : "retours"
    User ||--o{ ConsentLog : "consentements"
    User ||--o{ LinkHistory : "liens visités"
          </div>
        </div>

        <h2>Domaines Fonctionnels</h2>

        <h3>1. Utilisateurs & Auth (5 modèles)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>User</code></td>
              <td>Utilisateur principal</td>
              <td>id, email, name, role, passwordHash, stripeCustomerId, onboardingState</td>
            </tr>
            <tr>
              <td><code>Account</code></td>
              <td>Comptes OAuth liés (Google, LinkedIn)</td>
              <td>provider, providerAccountId, access_token, refresh_token</td>
            </tr>
            <tr>
              <td><code>EmailVerificationToken</code></td>
              <td>Tokens vérification email</td>
              <td>userId, token, expires</td>
            </tr>
            <tr>
              <td><code>AutoSignInToken</code></td>
              <td>Tokens connexion automatique</td>
              <td>userId, token, expires</td>
            </tr>
            <tr>
              <td><code>EmailChangeRequest</code></td>
              <td>Demandes changement d'email</td>
              <td>userId, newEmail, token, expires</td>
            </tr>
          </tbody>
        </table>

        <h3>2. CV & Documents (3 modèles)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>CvFile</code></td>
              <td>CV stocké en JSON dans la DB</td>
              <td>content (Json), contentVersion, matchScore, scoreBefore, optimiseStatus, pendingChanges, language</td>
            </tr>
            <tr>
              <td><code>CvVersion</code></td>
              <td>Historique des versions (optimisation, adaptation, restore)</td>
              <td>version (Int), content (Json), changelog, changeType, matchScore</td>
            </tr>
            <tr>
              <td><code>ExportTemplate</code></td>
              <td>Configurations de sélection pour export PDF</td>
              <td>userId, name, selections (Json)</td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-info">
          <div class="callout-title">Stockage du contenu CV</div>
          <p>Le contenu du CV est stocké en JSON dans le champ <code>content</code> de <code>CvFile</code>. La version courante est suivie via <code>contentVersion</code>. Les modifications IA sont dans <code>pendingChanges</code> avec un statut par changement (pending/accepted/rejected).</p>
        </div>

        <h3>3. Offres d'Emploi (1 modèle)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>JobOffer</code></td>
              <td>Offre d'emploi extraite (URL ou PDF)</td>
              <td>sourceType ('url'|'pdf'), sourceValue, contentHash, content (Json), extractionModel, tokensUsed</td>
            </tr>
          </tbody>
        </table>

        <h3>4. Pipeline Génération CV (3 modèles)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>CvGenerationTask</code></td>
              <td>Tâche master de génération</td>
              <td>userId, sourceCvFileId, mode ('adapt'|'optimize'), status, totalOffers, completedOffers, creditsDebited</td>
            </tr>
            <tr>
              <td><code>CvGenerationOffer</code></td>
              <td>Offre à traiter dans une tâche</td>
              <td>taskId, sourceUrl, jobOfferId, offerIndex, status, classificationResult, batchResults, generatedCvFileId</td>
            </tr>
            <tr>
              <td><code>CvGenerationSubtask</code></td>
              <td>Sous-tâche IA unitaire (traçabilité)</td>
              <td>offerId, type (classify|batch_*|recompose), itemIndex, input/output (Json), modifications (Json), modelUsed, promptTokens, cachedTokens, completionTokens, estimatedCost, durationMs</td>
            </tr>
          </tbody>
        </table>

        <h3>5. Abonnements & Crédits (7 modèles)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>Subscription</code></td>
              <td>Abonnement Stripe actif</td>
              <td>stripeSubscriptionId, planId, status, billingPeriod, currentPeriodEnd, cancelAtPeriodEnd</td>
            </tr>
            <tr>
              <td><code>SubscriptionPlan</code></td>
              <td>Plans disponibles</td>
              <td>name, isFree, tier, priceMonthly, priceYearly, stripeProductId</td>
            </tr>
            <tr>
              <td><code>SubscriptionPlanFeatureLimit</code></td>
              <td>Limites par plan/feature</td>
              <td>planId, featureName, isEnabled, usageLimit</td>
            </tr>
            <tr>
              <td><code>FeatureUsageCounter</code></td>
              <td>Compteurs par période (reset auto)</td>
              <td>userId, featureName, count, periodStart, periodEnd</td>
            </tr>
            <tr>
              <td><code>CreditBalance</code></td>
              <td>Solde crédits utilisateur</td>
              <td>userId, balance, totalPurchased, totalUsed, totalRefunded, totalGifted</td>
            </tr>
            <tr>
              <td><code>CreditTransaction</code></td>
              <td>Historique transactions crédits</td>
              <td>userId, amount, type, featureName, stripePaymentIntentId, refunded</td>
            </tr>
            <tr>
              <td><code>CreditPack</code></td>
              <td>Packs de crédits à l'achat</td>
              <td>name, creditAmount, price, isActive, stripePriceId</td>
            </tr>
          </tbody>
        </table>

        <h3>6. OpenAI Monitoring (4 modèles)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>OpenAIUsage</code></td>
              <td>Usage agrégé par jour/feature/modèle</td>
              <td>userId, featureName, model, date, promptTokens, cachedTokens, completionTokens, estimatedCost, callsCount</td>
            </tr>
            <tr>
              <td><code>OpenAICall</code></td>
              <td>Log de chaque appel API individuel</td>
              <td>userId, featureName, model, promptTokens, cachedTokens, completionTokens, estimatedCost, duration</td>
            </tr>
            <tr>
              <td><code>OpenAIPricing</code></td>
              <td>Grille tarifaire par modèle (standard + priority)</td>
              <td>modelName, inputPricePerMToken, outputPricePerMToken, cachePricePerMToken, isActive</td>
            </tr>
            <tr>
              <td><code>OpenAIAlert</code></td>
              <td>Configuration alertes de coûts</td>
              <td>type, threshold, enabled, name, description</td>
            </tr>
          </tbody>
        </table>

        <h3>7. Email & Notifications (3 modèles)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>EmailTrigger</code></td>
              <td>Événements déclencheurs d'emails</td>
              <td>name (unique), label, variables (Json), category, isSystem</td>
            </tr>
            <tr>
              <td><code>EmailTemplate</code></td>
              <td>Templates email éditables</td>
              <td>name, triggerId, subject, designJson, htmlContent, isActive, isDefault</td>
            </tr>
            <tr>
              <td><code>EmailLog</code></td>
              <td>Historique d'envois</td>
              <td>templateId, templateName, recipientEmail, status, provider ('resend'), providerId</td>
            </tr>
          </tbody>
        </table>

        <h3>8. Telemetry & Analytics (4 modèles)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>TelemetryEvent</code></td>
              <td>Événements de tracking</td>
              <td>userId, type, category, metadata, deviceId, duration, status</td>
            </tr>
            <tr>
              <td><code>FeatureUsage</code></td>
              <td>Usage cumulé par feature</td>
              <td>userId, featureName, usageCount, lastUsedAt, totalDuration</td>
            </tr>
            <tr>
              <td><code>Feedback</code></td>
              <td>Retours utilisateurs et bug reports</td>
              <td>userId, rating, comment, isBugReport, status</td>
            </tr>
            <tr>
              <td><code>ConsentLog</code></td>
              <td>Historique consentements RGPD</td>
              <td>userId, action, preferences, ip, userAgent</td>
            </tr>
          </tbody>
        </table>

        <h3>9. Configuration & Système (4 modèles)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>Setting</code></td>
              <td>Paramètres système (modèles IA, config)</td>
              <td>settingName (unique), value, category, description</td>
            </tr>
            <tr>
              <td><code>BackgroundTask</code></td>
              <td>Tâches asynchrones avec tracking</td>
              <td>id, title, type, status, deviceId, userId, payload, result, error, creditUsed</td>
            </tr>
            <tr>
              <td><code>LinkHistory</code></td>
              <td>Historique des URLs visitées</td>
              <td>userId, url (unique par user)</td>
            </tr>
            <tr>
              <td><code>StripeWebhookLog</code></td>
              <td>Log des webhooks Stripe reçus</td>
              <td>eventId (unique), eventType, payload, processed, error</td>
            </tr>
          </tbody>
        </table>

        <h2>Indexes et Performance</h2>

        <p>Les indexes critiques sont définis directement dans <code>schema.prisma</code> :</p>

        <pre><code class="language-javascript">// Contraintes d'unicité composées
@@unique([userId, filename])          // CvFile : 1 nom par user
@@unique([userId, sourceValue])       // JobOffer : pas de doublon offre
@@unique([userId, featureName])       // FeatureUsageCounter : 1 compteur par feature
@@unique([userId, featureName, model, date]) // OpenAIUsage : agrégation unique

// Indexes de recherche
@@index([userId])                     // Sur presque tous les modèles
@@index([status])                     // BackgroundTask, CvGenerationTask
@@index([createdAt])                  // Pour pagination et tri
@@index([deviceId])                   // BackgroundTask : sync par device
@@index([type, timestamp])            // TelemetryEvent : analytics
@@index([featureName, date])          // OpenAIUsage : rapports par feature

// Indexes composés pour requêtes fréquentes
@@index([userId, createdAt])          // CreditTransaction, LinkHistory
@@index([cvFile, status])             // BackgroundTask : tâches par CV
@@index([offerId, type])              // CvGenerationSubtask : sous-tâches par offre</code></pre>

        <h2>Migrations</h2>

        <div class="card-grid">
          <div class="card">
            <h4>Créer une migration</h4>
            <pre><code class="language-bash">npx prisma migrate dev --name description</code></pre>
          </div>
          <div class="card">
            <h4>Appliquer en production</h4>
            <pre><code class="language-bash">npx prisma migrate deploy</code></pre>
          </div>
          <div class="card">
            <h4>Régénérer le client</h4>
            <pre><code class="language-bash">npx prisma generate</code></pre>
          </div>
          <div class="card">
            <h4>Migrations de données</h4>
            <pre><code class="language-bash">npm run db:migrate-data</code></pre>
            <p>Scripts JS dans <code>prisma/data-migrations/</code></p>
          </div>
        </div>

        <h2>Connexion à la Base</h2>

        <pre><code class="language-javascript">// lib/prisma.js - Singleton Prisma Client
import { PrismaClient } from "@prisma/client";

const globalForPrisma = globalThis;

const prisma = globalForPrisma.prisma ?? new PrismaClient();

if (process.env.NODE_ENV !== "production") {
  globalForPrisma.prisma = prisma;
}

export default prisma;</code></pre>

        <div class="callout callout-info">
          <div class="callout-title">Singleton Pattern</div>
          <p>Le client Prisma est instancié une seule fois et stocké dans <code>globalThis</code> pour éviter les connexions multiples en mode développement (hot reload Next.js).</p>
        </div>

        <div class="callout callout-warning">
          <div class="callout-title">Connection Pooling</div>
          <p>En production, utiliser un connection pooler (PgBouncer) pour gérer les connexions. La variable <code>DATABASE_URL</code> doit pointer vers le pooler.</p>
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
