<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Base de Données | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
        <aside class="sidebar">
      <div class="sidebar-header">
        <a href="index.html" class="sidebar-logo">FitMyCV<span class="accent">.io</span></a>
        <div class="sidebar-version">Documentation Technique v1.0.9.5</div>
      </div>

      <nav class="sidebar-nav">
        <!-- Introduction -->
        <div class="nav-section">
          <div class="nav-section-title">Introduction</div>
          <ul class="nav-list">
            <li class="nav-item"><a href="index.html">Accueil</a></li>
          </ul>
        </div>

        <!-- Architecture -->
        <div class="nav-section">
          <div class="nav-section-title">Architecture</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Architecture</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="01-architecture/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="01-architecture/tech-stack.html">Stack technologique</a></li>
                <li class="nav-item"><a href="01-architecture/database.html">Base de données</a></li>
                <li class="nav-item"><a href="01-architecture/patterns.html">Patterns</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Fonctionnalités Core -->
        <div class="nav-section">
          <div class="nav-section-title">Fonctionnalités Core</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Authentification</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="02-authentification/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="02-authentification/oauth-flow.html">OAuth Flow</a></li>
                <li class="nav-item"><a href="02-authentification/credentials-flow.html">Credentials</a></li>
                <li class="nav-item"><a href="02-authentification/email-verification.html">Vérification Email</a></li>
              </ul>
            </li>
            <li class="nav-item has-children">
              <a href="#">Gestion des CV</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="03-gestion-cv/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="03-gestion-cv/crud.html">CRUD</a></li>
                <li class="nav-item"><a href="03-gestion-cv/versioning.html">Versioning</a></li>
                <li class="nav-item"><a href="03-gestion-cv/import-pdf.html">Import PDF</a></li>
                <li class="nav-item"><a href="03-gestion-cv/structure-cv.html">Structure JSON</a></li>
              </ul>
            </li>
            <li class="nav-item has-children">
              <a href="#">Offres d'emploi</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="04-offres-emploi/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="04-offres-emploi/extraction-url.html">Extraction URL</a></li>
                <li class="nav-item"><a href="04-offres-emploi/extraction-pdf.html">Extraction PDF</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Pipelines IA -->
        <div class="nav-section">
          <div class="nav-section-title">Pipelines IA</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Génération CV</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="05-pipeline-generation/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/orchestrator.html">Orchestrateur</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/phase-classification.html">Classification</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/phase-batches.html">Batches</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/phase-recompose.html">Recomposition</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/prompts.html">Prompts IA</a></li>
                <li class="nav-item"><a href="05-pipeline-generation/schemas-io.html">Schemas I/O</a></li>
              </ul>
            </li>
            <li class="nav-item has-children">
              <a href="#">Optimisation CV</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="06-pipeline-optimisation/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="06-pipeline-optimisation/scoring.html">Scoring</a></li>
                <li class="nav-item"><a href="06-pipeline-optimisation/suggestions.html">Suggestions</a></li>
                <li class="nav-item"><a href="06-pipeline-optimisation/application.html">Application</a></li>
                <li class="nav-item"><a href="06-pipeline-optimisation/review-system.html">Review</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Billing -->
        <div class="nav-section">
          <div class="nav-section-title">Billing</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Abonnements</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="07-abonnements/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="07-abonnements/business-models.html">Modèles économiques</a></li>
                <li class="nav-item"><a href="07-abonnements/plans-stripe.html">Plans Stripe</a></li>
                <li class="nav-item"><a href="07-abonnements/checkout-flow.html">Checkout</a></li>
                <li class="nav-item"><a href="07-abonnements/webhooks.html">Webhooks</a></li>
              </ul>
            </li>
            <li class="nav-item has-children">
              <a href="#">Crédits</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="08-credits/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="08-credits/welcome-credits.html">Crédits bienvenue</a></li>
                <li class="nav-item"><a href="08-credits/debit-refund.html">Débit / Remboursement</a></li>
                <li class="nav-item"><a href="08-credits/feature-limits.html">Limites Features</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Système -->
        <div class="nav-section">
          <div class="nav-section-title">Système</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Background Jobs</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="09-background-jobs/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="09-background-jobs/task-types.html">Types de tâches</a></li>
                <li class="nav-item"><a href="09-background-jobs/concurrency.html">Concurrence</a></li>
              </ul>
            </li>
            <li class="nav-item has-children">
              <a href="#">Export</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="10-export/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="10-export/pdf.html">Export PDF</a></li>
                <li class="nav-item"><a href="10-export/docx.html">Export DOCX</a></li>
              </ul>
            </li>
            <li class="nav-item"><a href="11-traduction/overview.html">Traduction</a></li>
          </ul>
        </div>

        <!-- Administration -->
        <div class="nav-section">
          <div class="nav-section-title">Administration</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">Dashboard Admin</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="12-administration/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="12-administration/users.html">Utilisateurs</a></li>
                <li class="nav-item"><a href="12-administration/subscription-mode.html">Mode Abonnement</a></li>
                <li class="nav-item"><a href="12-administration/plans-management.html">Gestion Plans</a></li>
                <li class="nav-item"><a href="12-administration/credit-packs.html">Packs Crédits</a></li>
                <li class="nav-item"><a href="12-administration/openai-monitoring.html">Monitoring OpenAI</a></li>
                <li class="nav-item"><a href="12-administration/email-templates.html">Templates Email</a></li>
                <li class="nav-item"><a href="12-administration/settings.html">Paramètres</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Autres -->
        <div class="nav-section">
          <div class="nav-section-title">Autres</div>
          <ul class="nav-list">
            <li class="nav-item"><a href="13-onboarding/overview.html">Onboarding</a></li>
            <li class="nav-item has-children">
              <a href="#">Email</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="14-email/overview.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="14-email/templates.html">Templates</a></li>
              </ul>
            </li>
          </ul>
        </div>

        <!-- Référence -->
        <div class="nav-section">
          <div class="nav-section-title">Référence</div>
          <ul class="nav-list">
            <li class="nav-item has-children">
              <a href="#">API Reference</a>
              <ul class="nav-children nav-list">
                <li class="nav-item"><a href="15-api-reference/index.html">Vue d'ensemble</a></li>
                <li class="nav-item"><a href="15-api-reference/public.html">Publics</a></li>
                <li class="nav-item"><a href="15-api-reference/authenticated.html">Authentifiés</a></li>
                <li class="nav-item"><a href="15-api-reference/admin.html">Admin</a></li>
              </ul>
            </li>
            <li class="nav-item"><a href="16-composants/index.html">Composants React</a></li>
          </ul>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
            <header class="header">
        <button class="mobile-menu-button" title="Menu">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
        <div class="search-container">
          <input type="text" class="search-input" placeholder="Rechercher dans la documentation...">
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Changer le thème">
          <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
          </svg>
        </button>
      </header>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <a href="overview.html">Architecture</a>
          <span>/</span>
          <span>Base de données</span>
        </div>

        <h1>Base de Données</h1>
        <p class="lead">
          FitMyCV.io utilise PostgreSQL via Prisma ORM avec 34 modèles de données organisés en domaines fonctionnels.
        </p>

        <h2>Schéma Relationnel</h2>

        <div class="diagram">
          <div class="diagram-title">Relations principales - Utilisateur</div>
          <div class="mermaid">
flowchart TB
    User["<strong>User</strong><br/>id, email, name, role"]

    subgraph CV["CV & Documents"]
        CvFile["<strong>CvFile</strong><br/>content JSON, matchScore"]
        CvVersion["<strong>CvVersion</strong><br/>versionNumber, origin"]
    end

    subgraph Jobs["Offres d'Emploi"]
        JobOffer["<strong>JobOffer</strong><br/>title, company, requirements"]
        CvGenerationOffer["<strong>CvGenerationOffer</strong><br/>status, generatedCvId"]
    end

    subgraph Billing["Facturation"]
        Subscription["<strong>Subscription</strong><br/>status, periodEnd"]
        CreditBalance["<strong>CreditBalance</strong><br/>balance"]
        CreditTransaction["<strong>CreditTransaction</strong><br/>amount, type"]
    end

    User --> CvFile
    User --> JobOffer
    User --> Subscription
    User --> CreditBalance
    User --> CreditTransaction

    CvFile --> CvVersion
    CvFile --> CvGenerationOffer
    JobOffer --> CvGenerationOffer
          </div>
        </div>

        <div class="diagram">
          <div class="diagram-title">Relations principales - Génération & Abonnements</div>
          <div class="mermaid">
flowchart TB
    subgraph Generation["Pipeline Génération"]
        CvGenerationTask["<strong>CvGenerationTask</strong><br/>mode, status, progress"]
        CvGenerationOffer["<strong>CvGenerationOffer</strong><br/>status, matchScore"]
        CvGenerationSubtask["<strong>CvGenerationSubtask</strong><br/>phase, status"]
    end

    subgraph Plans["Plans & Limites"]
        SubscriptionPlan["<strong>SubscriptionPlan</strong><br/>name, price, features"]
        FeatureLimit["<strong>FeatureLimit</strong><br/>feature, monthlyLimit"]
        FeatureUsageCounter["<strong>FeatureUsageCounter</strong><br/>feature, count, month"]
    end

    CvGenerationTask --> CvGenerationOffer
    CvGenerationTask --> CvGenerationSubtask

    SubscriptionPlan --> FeatureLimit
    User["<strong>User</strong>"] --> FeatureUsageCounter
          </div>
        </div>

        <h2>Domaines Fonctionnels</h2>

        <h3>1. Utilisateurs & Auth</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>User</code></td>
              <td>Utilisateur principal</td>
              <td>id, email, name, role, hashedPassword</td>
            </tr>
            <tr>
              <td><code>Account</code></td>
              <td>Comptes OAuth liés</td>
              <td>provider, providerAccountId, access_token</td>
            </tr>
            <tr>
              <td><code>Session</code></td>
              <td>Sessions actives</td>
              <td>sessionToken, expires</td>
            </tr>
            <tr>
              <td><code>VerificationToken</code></td>
              <td>Tokens de vérification email</td>
              <td>identifier, token, expires</td>
            </tr>
          </tbody>
        </table>

        <h3>2. CV & Documents</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>CvFile</code></td>
              <td>CV stocké en JSON</td>
              <td>content (JSON), matchScore, isDefault, jobOfferId</td>
            </tr>
            <tr>
              <td><code>CvVersion</code></td>
              <td>Historique des versions</td>
              <td>versionNumber, content, origin, description</td>
            </tr>
            <tr>
              <td><code>CvTemplate</code></td>
              <td>Templates de CV</td>
              <td>name, structure, isDefault</td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-info">
          <div class="callout-title">Stockage du contenu CV</div>
          <p>Le contenu du CV est stocké en JSON dans le champ <code>content</code> de <code>CvFile</code>. Structure : sections (experiences, skills, education, etc.) avec leurs items.</p>
        </div>

        <h3>3. Offres d'Emploi</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>JobOffer</code></td>
              <td>Offre d'emploi extraite</td>
              <td>url, content (JSON), extractedAt</td>
            </tr>
            <tr>
              <td><code>JobOfferRaw</code></td>
              <td>Contenu brut de la page</td>
              <td>html, text, fetchedAt</td>
            </tr>
          </tbody>
        </table>

        <h3>4. Génération CV (Pipeline)</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>CvGenerationTask</code></td>
              <td>Tâche master de génération</td>
              <td>userId, status, mode, totalOffers, creditsRefunded</td>
            </tr>
            <tr>
              <td><code>CvGenerationOffer</code></td>
              <td>Offre à traiter dans une tâche</td>
              <td>taskId, jobOfferId, status, classificationResult</td>
            </tr>
            <tr>
              <td><code>CvGenerationSubtask</code></td>
              <td>Sous-tâche IA (traçabilité)</td>
              <td>type, input, output, tokens, cost, duration</td>
            </tr>
          </tbody>
        </table>

        <h3>5. Abonnements & Crédits</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>Subscription</code></td>
              <td>Abonnement Stripe actif</td>
              <td>stripeSubscriptionId, status, currentPeriodEnd</td>
            </tr>
            <tr>
              <td><code>SubscriptionPlan</code></td>
              <td>Plans disponibles</td>
              <td>name, priceMonthly, stripePriceId</td>
            </tr>
            <tr>
              <td><code>FeatureLimit</code></td>
              <td>Limites par plan/feature</td>
              <td>planId, featureName, usageLimit, isEnabled</td>
            </tr>
            <tr>
              <td><code>FeatureUsageCounter</code></td>
              <td>Compteurs mensuels</td>
              <td>userId, featureName, count, periodStart</td>
            </tr>
            <tr>
              <td><code>CreditBalance</code></td>
              <td>Solde crédits utilisateur</td>
              <td>userId, balance</td>
            </tr>
            <tr>
              <td><code>CreditTransaction</code></td>
              <td>Historique transactions</td>
              <td>type, amount, reason, featureName</td>
            </tr>
            <tr>
              <td><code>CreditPack</code></td>
              <td>Packs à l'achat</td>
              <td>name, credits, price, isActive</td>
            </tr>
          </tbody>
        </table>

        <h3>6. OpenAI Monitoring</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>OpenAIUsageLog</code></td>
              <td>Log de chaque appel API</td>
              <td>userId, featureName, model, tokens, cost</td>
            </tr>
            <tr>
              <td><code>OpenAICostAlert</code></td>
              <td>Configuration alertes</td>
              <td>type, threshold, isEnabled</td>
            </tr>
            <tr>
              <td><code>OpenAICostNotification</code></td>
              <td>Alertes déclenchées</td>
              <td>alertId, currentValue, triggeredAt</td>
            </tr>
          </tbody>
        </table>

        <h3>7. Email & Notifications</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>EmailTemplate</code></td>
              <td>Templates email</td>
              <td>name, subject, htmlContent, trigger</td>
            </tr>
            <tr>
              <td><code>EmailLog</code></td>
              <td>Historique envois</td>
              <td>templateId, recipient, status, sentAt</td>
            </tr>
          </tbody>
        </table>

        <h3>8. Configuration</h3>

        <table>
          <thead>
            <tr>
              <th>Modèle</th>
              <th>Description</th>
              <th>Champs clés</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>Setting</code></td>
              <td>Paramètres système</td>
              <td>key, value, category, description</td>
            </tr>
            <tr>
              <td><code>BackgroundTask</code></td>
              <td>Tâches asynchrones</td>
              <td>type, status, payload, result</td>
            </tr>
          </tbody>
        </table>

        <h2>Indexes et Performance</h2>

        <pre><code>// Indexes critiques définis dans schema.prisma

// Recherche rapide des CV par utilisateur
@@index([userId], map: "CvFile_userId_idx")

// Recherche offres par URL (cache)
@@unique([url, userId], map: "JobOffer_url_userId_key")

// Compteurs par période
@@unique([userId, featureName, periodStart], map: "FeatureUsageCounter_unique")

// Logs OpenAI pour analytics
@@index([userId, createdAt], map: "OpenAIUsageLog_user_date_idx")
@@index([featureName, createdAt], map: "OpenAIUsageLog_feature_date_idx")</code></pre>

        <h2>Migrations</h2>

        <div class="card-grid">
          <div class="card">
            <h4>Créer une migration</h4>
            <pre><code>npx prisma migrate dev --name description</code></pre>
          </div>
          <div class="card">
            <h4>Appliquer en production</h4>
            <pre><code>npx prisma migrate deploy</code></pre>
          </div>
          <div class="card">
            <h4>Régénérer le client</h4>
            <pre><code>npx prisma generate</code></pre>
          </div>
        </div>

        <h2>Connexion à la Base</h2>

        <pre><code>// lib/prisma.js - Singleton Prisma Client
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis;

const prisma = globalForPrisma.prisma ?? new PrismaClient({
  log: process.env.NODE_ENV === 'development'
    ? ['query', 'error', 'warn']
    : ['error'],
});

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma;
}

export default prisma;</code></pre>

        <div class="callout callout-warning">
          <div class="callout-title">Connection Pooling</div>
          <p>En production, utiliser un connection pooler (PgBouncer) pour gérer les connexions. La variable <code>DATABASE_URL</code> doit pointer vers le pooler.</p>
        </div>

      </div>
    </main>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/main.js"></script>
</body>
</html>
