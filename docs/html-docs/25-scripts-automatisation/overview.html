<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scripts d'Automatisation | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>
    <main class="main">
      <div id="header-container"></div>
      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Scripts d'Automatisation</span>
        </div>

        <h1>Scripts d'Automatisation</h1>
        <p class="lead">
          Le dossier <code>scripts/</code> contient 6 scripts d'automatisation couvrant le versioning (Conventional Commits 4 parties), les migrations de donn√©es, la synchronisation Stripe (production et staging), et la gestion des templates email.
        </p>

        <!-- ‚îÄ‚îÄ‚îÄ Vue d'ensemble ‚îÄ‚îÄ‚îÄ -->

        <h2>Vue d'ensemble</h2>

        <table>
          <thead>
            <tr>
              <th>Script</th>
              <th>Langage</th>
              <th>Contexte</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>bump-version.sh</code></td>
              <td>Bash</td>
              <td>CI/CD (GitHub Actions)</td>
              <td>Incr√©mentation automatique de version 4 parties via Conventional Commits</td>
            </tr>
            <tr>
              <td><code>run-data-migrations.js</code></td>
              <td>Node.js (CJS)</td>
              <td>D√©ploiement</td>
              <td>Ex√©cution des scripts de migration de donn√©es post-Prisma</td>
            </tr>
            <tr>
              <td><code>sync-stripe.mjs</code></td>
              <td>Node.js (ESM)</td>
              <td>Production</td>
              <td>Synchronisation des plans et packs avec Stripe (prod)</td>
            </tr>
            <tr>
              <td><code>sync-staging-stripe.js</code></td>
              <td>Node.js (CJS)</td>
              <td>Staging</td>
              <td>Synchronisation compl√®te Live &rarr; Test (4 phases)</td>
            </tr>
            <tr>
              <td><code>export-email-templates.js</code></td>
              <td>Node.js (CJS)</td>
              <td>D√©veloppement</td>
              <td>Export des templates email depuis la DB vers des fichiers JSON</td>
            </tr>
            <tr>
              <td><code>preview-emails.js</code></td>
              <td>Node.js (CJS)</td>
              <td>D√©veloppement</td>
              <td>Serveur HTTP de pr√©visualisation des emails (dark/light mode)</td>
            </tr>
          </tbody>
        </table>

        <div class="diagram">
          <div class="diagram-title">Scripts dans le cycle de vie du projet</div>
          <div class="mermaid">
graph LR
    subgraph DEV["D√©veloppement"]
        EXPORT["export-email-templates.js"]
        PREVIEW["preview-emails.js"]
    end

    subgraph CICD["CI/CD (merge sur main)"]
        BUMP["bump-version.sh"]
        MIGRATE["run-data-migrations.js"]
        SYNC["sync-stripe.mjs"]
    end

    subgraph STAGING["Pre-production (PR)"]
        STAGING_STRIPE["sync-staging-stripe.js"]
    end

    EXPORT --> PREVIEW
    BUMP --> MIGRATE
    MIGRATE --> SYNC

    style EXPORT fill:#64748b,stroke:#475569,color:#fff
    style PREVIEW fill:#64748b,stroke:#475569,color:#fff
    style BUMP fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style MIGRATE fill:#14b8a6,stroke:#0d9488,color:#fff
    style SYNC fill:#6366f1,stroke:#4f46e5,color:#fff
    style STAGING_STRIPE fill:#6366f1,stroke:#4f46e5,color:#fff
          </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ bump-version.sh ‚îÄ‚îÄ‚îÄ -->

        <h2>bump-version.sh &mdash; Versioning 4 parties</h2>

        <p>Script Bash ex√©cut√© automatiquement par GitHub Actions lors du merge sur <code>main</code>. Il scanne tous les commits depuis le dernier tag et incr√©mente la version selon les pr√©fixes Conventional Commits.</p>

        <h3>Format de version</h3>

        <pre><code class="language-bash"># Format : X.X.X.X (Major.Minor.Patch.Build)
# Exemple : 1.3.2.7</code></pre>

        <h3>R√®gles de bump</h3>

        <table>
          <thead>
            <tr>
              <th>Pr√©fixe de commit</th>
              <th>Partie incr√©ment√©e</th>
              <th>Exemple</th>
              <th>R√©sultat</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>feat!:</code> ou <code>BREAKING CHANGE:</code></td>
              <td><strong>1er</strong> (Major)</td>
              <td><code>feat!: supprimer API v1</code></td>
              <td><code>1.3.2.7</code> &rarr; <code>2.0.0.0</code></td>
            </tr>
            <tr>
              <td><code>feat:</code></td>
              <td><strong>2e</strong> (Minor)</td>
              <td><code>feat: ajouter export PDF</code></td>
              <td><code>1.3.2.7</code> &rarr; <code>1.4.0.0</code></td>
            </tr>
            <tr>
              <td><code>fix:</code></td>
              <td><strong>3e</strong> (Patch)</td>
              <td><code>fix: corriger affichage mobile</code></td>
              <td><code>1.3.2.7</code> &rarr; <code>1.3.3.0</code></td>
            </tr>
            <tr>
              <td>Autre (<code>chore:</code>, <code>docs:</code>...)</td>
              <td><strong>4e</strong> (Build)</td>
              <td><code>chore: mettre √† jour CI</code></td>
              <td><code>1.3.2.7</code> &rarr; <code>1.3.2.8</code></td>
            </tr>
          </tbody>
        </table>

        <div class="callout callout-warning">
          <strong>Le plus haut niveau gagne</strong> &mdash; Si une PR contient √† la fois un <code>fix:</code> et un <code>feat:</code>, c'est le <code>feat:</code> (Minor) qui s'applique. Le script retient toujours le niveau le plus √©lev√© parmi tous les commits.
        </div>

        <h3>Algorithme</h3>

        <div class="diagram">
          <div class="diagram-title">Flux d'ex√©cution de bump-version.sh</div>
          <div class="mermaid">
graph TD
    A["Lire version depuis package.json"] --> B["D√©couper en V1.V2.V3.V4"]
    B --> C["Valider : chaque partie est un entier"]
    C --> D["git describe --tags : trouver dernier tag"]
    D --> E["git log depuis le tag : r√©cup√©rer tous les commits"]
    E --> F{"Scanner les pr√©fixes"}
    F -->|"feat!: trouv√©"| G["BUMP = major"]
    F -->|"feat: trouv√©"| H["BUMP = minor"]
    F -->|"fix: trouv√©"| I["BUMP = patch"]
    F -->|"Aucun"| J["BUMP = build"]
    G --> K["Calculer nouvelle version"]
    H --> K
    I --> K
    J --> K
    K --> L["Mettre √† jour package.json + package-lock.json"]
    L --> M["Scan dynamique : grep -rl ancienne version"]
    M --> N["sed -i remplacement dans tous les fichiers"]

    style A fill:#0ea5e9,stroke:#0284c7,color:#fff
    style B fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style C fill:#f59e0b,stroke:#d97706,color:#fff
    style D fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style E fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style F fill:#f59e0b,stroke:#d97706,color:#fff
    style G fill:#ef4444,stroke:#dc2626,color:#fff
    style H fill:#22c55e,stroke:#16a34a,color:#fff
    style I fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style J fill:#64748b,stroke:#475569,color:#fff
    style K fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style L fill:#14b8a6,stroke:#0d9488,color:#fff
    style M fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style N fill:#22c55e,stroke:#16a34a,color:#fff
          </div>
        </div>

        <h3>Propagation de la version</h3>

        <p>Apr√®s mise √† jour de <code>package.json</code>, le script scanne dynamiquement <strong>tous les fichiers</strong> du projet (hors <code>.git</code>, <code>node_modules</code>, <code>.next</code>, <code>dist</code>) et remplace l'ancienne version par la nouvelle :</p>

        <pre><code class="language-bash"># Scan dynamique
EXCLUDE_DIRS=("--exclude-dir=.git" "--exclude-dir=node_modules" ...)
FILES_TO_UPDATE=$(grep -rl "${EXCLUDE_DIRS[@]}" "$OLD_VERSION" . || true)

# Remplacement dans chaque fichier trouv√©
for FILE in $FILES_TO_UPDATE; do
    sed -i "s/$OLD_VERSION/$NEW_VERSION/g" "$FILE"
done</code></pre>

        <div class="callout callout-info">
          <strong>Fichiers impact√©s</strong> &mdash; La version est propag√©e dans <code>docs/</code>, <code>README.md</code>, les fichiers de configuration, et tout fichier contenant le num√©ro de version. Les <code>package.json</code> et <code>package-lock.json</code> sont trait√©s s√©par√©ment via Node.js pour pr√©server le formatage JSON.
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ run-data-migrations ‚îÄ‚îÄ‚îÄ -->

        <h2>run-data-migrations.js &mdash; Migrations de donn√©es</h2>

        <p>Ex√©cute les scripts de migration de donn√©es stock√©s dans <code>prisma/data-migrations/</code>. Compl√©mentaire aux migrations Prisma (sch√©ma), ce script g√®re les transformations de <strong>donn√©es</strong> (renommage, nettoyage, calculs).</p>

        <h3>Fonctionnement</h3>

        <div class="diagram">
          <div class="diagram-title">Flux d'ex√©cution des migrations de donn√©es</div>
          <div class="mermaid">
graph TD
    A["Cr√©er table _data_migrations<br/>(si inexistante)"] --> B["Lire prisma/data-migrations/*.js"]
    B --> C["Trier par nom (chronologique)"]
    C --> D{"Pour chaque fichier"}
    D --> E["V√©rifier dans _data_migrations"]
    E -->|"D√©j√† appliqu√©"| D
    E -->|"Non appliqu√©"| F["Ex√©cuter migration(prisma)"]
    F -->|"Succ√®s"| G["INSERT dans _data_migrations"]
    G --> D
    F -->|"Erreur"| H["process.exit(1)"]

    style A fill:#0ea5e9,stroke:#0284c7,color:#fff
    style B fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style C fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style D fill:#f59e0b,stroke:#d97706,color:#fff
    style E fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style F fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style G fill:#22c55e,stroke:#16a34a,color:#fff
    style H fill:#ef4444,stroke:#dc2626,color:#fff
          </div>
        </div>

        <h3>Table de suivi</h3>

        <pre><code class="language-sql">-- Table cr√©√©e automatiquement au premier lancement
CREATE TABLE IF NOT EXISTS "_data_migrations" (
  "id"         SERIAL PRIMARY KEY,
  "name"       TEXT UNIQUE NOT NULL,
  "applied_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);</code></pre>

        <h3>Format d'un script de migration</h3>

        <pre><code class="language-javascript">// prisma/data-migrations/20240215_1430_normalize_skill_levels.js
module.exports = async (prisma) => {
  // Normaliser les niveaux de comp√©tence en valeurs num√©riques
  const skills = await prisma.skill.findMany({
    where: { level: { not: null } }
  });

  for (const skill of skills) {
    const numericLevel = normalizeToNumber(skill.level);
    if (numericLevel !== null && numericLevel !== skill.level) {
      await prisma.skill.update({
        where: { id: skill.id },
        data: { level: numericLevel }
      });
    }
  }
};</code></pre>

        <div class="callout callout-info">
          <strong>Convention de nommage</strong> &mdash; Les fichiers suivent le format <code>YYYYMMDD_HHMM_description.js</code>. Le tri alphab√©tique garantit l'ordre chronologique d'ex√©cution.
        </div>

        <div class="callout callout-warning">
          <strong>Ex√©cution unique</strong> &mdash; Chaque migration n'est ex√©cut√©e qu'une seule fois gr√¢ce √† la table de suivi. En cas d'erreur, le script s'arr√™te imm√©diatement (<code>process.exit(1)</code>) pour √©viter les effets de bord.
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ sync-stripe.mjs ‚îÄ‚îÄ‚îÄ -->

        <h2>sync-stripe.mjs &mdash; Synchronisation Stripe (Production)</h2>

        <p>Script ESM qui synchronise les plans d'abonnement et packs de cr√©dits entre la base de donn√©es et Stripe en <strong>production</strong>.</p>

        <h3>Usage</h3>

        <pre><code class="language-bash"># Synchronisation avec sortie d√©taill√©e
node scripts/sync-stripe.mjs

# Mode silencieux (CI/CD)
node scripts/sync-stripe.mjs --quiet</code></pre>

        <h3>Pr√©requis</h3>

        <table>
          <thead>
            <tr>
              <th>Variable d'environnement</th>
              <th>Obligatoire</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>STRIPE_SECRET_KEY</code></td>
              <td>Oui</td>
              <td>Cl√© secr√®te Stripe (d√©tecte automatiquement mode TEST vs LIVE)</td>
            </tr>
            <tr>
              <td><code>DATABASE_URL</code></td>
              <td>Oui</td>
              <td>URL de connexion PostgreSQL</td>
            </tr>
          </tbody>
        </table>

        <h3>R√©sultat</h3>

        <p>Le script d√©l√®gue √† <code>syncStripeProductsInternal()</code> de <code>lib/subscription/stripeSync.js</code> et affiche un r√©sum√© :</p>

        <pre><code class="language-bash">üîÑ Synchronisation Stripe en cours...

üìä Database: fitmycv_prod
üîë Stripe: Mode LIVE

‚úÖ Synchronisation termin√©e!

üìã R√©sultats:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Plans d'abonnement:
  ‚Ä¢ Cr√©√©s: 0
  ‚Ä¢ Mis √† jour: 3
  ‚Ä¢ Ignor√©s: 1
Packs de cr√©dits:
  ‚Ä¢ Cr√©√©s: 0
  ‚Ä¢ Mis √† jour: 2
  ‚Ä¢ Ignor√©s: 0
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</code></pre>

        <!-- ‚îÄ‚îÄ‚îÄ sync-staging-stripe ‚îÄ‚îÄ‚îÄ -->

        <h2>sync-staging-stripe.js &mdash; Synchronisation Stripe (Staging)</h2>

        <p>Script complet de synchronisation pour l'environnement de pre-production. Il clone la configuration Stripe Live vers Test en <strong>4 phases</strong>.</p>

        <h3>Les 4 phases</h3>

        <div class="diagram">
          <div class="diagram-title">Pipeline de synchronisation Staging</div>
          <div class="mermaid">
graph LR
    P1["Phase 1<br/>Products &amp; Prices<br/>Live ‚Üí Test"] --> P2["Phase 2<br/>Update DB<br/>Stripe Test ‚Üí DB"]
    P2 --> P3["Phase 3<br/>Coupons<br/>Live ‚Üí Test"]
    P3 --> P4["Phase 4<br/>Promo Codes<br/>Live ‚Üí Test"]

    style P1 fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style P2 fill:#14b8a6,stroke:#0d9488,color:#fff
    style P3 fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style P4 fill:#8b5cf6,stroke:#7c3aed,color:#fff
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Phase</th>
              <th>Source</th>
              <th>Destination</th>
              <th>Donn√©es</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>1</strong></td>
              <td>Stripe Live</td>
              <td>Stripe Test</td>
              <td>Produits + Prix (montant, devise, intervalle)</td>
            </tr>
            <tr>
              <td><strong>2</strong></td>
              <td>Stripe Test</td>
              <td>Base de donn√©es staging</td>
              <td>SubscriptionPlan (monthly/yearly IDs) + CreditPack (price ID)</td>
            </tr>
            <tr>
              <td><strong>3</strong></td>
              <td>Stripe Live</td>
              <td>Stripe Test</td>
              <td>Coupons (%, montant, dur√©e)</td>
            </tr>
            <tr>
              <td><strong>4</strong></td>
              <td>Stripe Live</td>
              <td>Stripe Test</td>
              <td>Codes promo associ√©s aux coupons</td>
            </tr>
          </tbody>
        </table>

        <h3>Variables d'environnement</h3>

        <table>
          <thead>
            <tr>
              <th>Variable</th>
              <th>Obligatoire</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>STRIPE_SECRET_KEY</code></td>
              <td>Oui</td>
              <td>Cl√© Stripe <strong>TEST</strong> (staging)</td>
            </tr>
            <tr>
              <td><code>DATABASE_URL</code></td>
              <td>Oui</td>
              <td>URL de la DB staging</td>
            </tr>
            <tr>
              <td><code>STRIPE_LIVE_SECRET_KEY</code></td>
              <td>Non</td>
              <td>Cl√© Stripe <strong>LIVE</strong> (pour phases 1, 3, 4). Sans cette cl√©, seule la phase 2 s'ex√©cute.</td>
            </tr>
          </tbody>
        </table>

        <h3>Matching des produits</h3>

        <p>Le script fait correspondre les produits Stripe avec la DB via le <strong>nom du produit</strong> :</p>

        <pre><code class="language-javascript">// Phase 1 : Match par nom de produit (Live ‚Üí Test)
const testProductsByName = new Map(
  testProducts.data.map(p => [p.name, p])
);

// Phase 1 : Match des prix par montant + devise + type + intervalle
const exists = testPrices.data.some(tp =>
  tp.unit_amount === livePrice.unit_amount &&
  tp.currency === livePrice.currency &&
  tp.type === livePrice.type &&
  (livePrice.type !== 'recurring' ||
    tp.recurring?.interval === livePrice.recurring?.interval)
);

// Phase 2 : Match DB ‚Üî Stripe par nom
const dbNames = new Set([
  ...dbPlans.map(p => p.name),
  ...dbPacks.map(p => p.name)
]);</code></pre>

        <h3>R√©sum√© de sortie</h3>

        <pre><code class="language-bash">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä Sync Summary:
   Products:       2
   Prices:         4
   Plans (DB):     3
   Credit Packs:   2
   Coupons:        1
   Promo Codes:    2
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</code></pre>

        <!-- ‚îÄ‚îÄ‚îÄ export-email-templates ‚îÄ‚îÄ‚îÄ -->

        <h2>export-email-templates.js &mdash; Export Templates Email</h2>

        <p>Exporte les templates email depuis la base de donn√©es vers des fichiers JSON dans <code>prisma/email-templates/</code>. Utilis√© pour versionner les templates et permettre leur pr√©visualisation.</p>

        <h3>Fonctionnement</h3>

        <pre><code class="language-bash"># Ex√©cution
node scripts/export-email-templates.js</code></pre>

        <div class="diagram">
          <div class="diagram-title">Flux d'export des templates</div>
          <div class="mermaid">
graph LR
    DB["DB: EmailTemplate<br/>+ EmailTrigger"] --> QUERY["findMany<br/>(include trigger)"]
    QUERY --> SLUG["Slugify nom<br/>+ trigger name"]
    SLUG --> WRITE["√âcrire fichier JSON<br/>prisma/email-templates/"]

    style DB fill:#14b8a6,stroke:#0d9488,color:#fff
    style QUERY fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style SLUG fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style WRITE fill:#22c55e,stroke:#16a34a,color:#fff
          </div>
        </div>

        <h3>Format de sortie</h3>

        <p>Chaque template est export√© dans un fichier nomm√© <code>{triggerName}--{slug}.json</code> :</p>

        <pre><code class="language-json">// prisma/email-templates/welcome--bienvenue-sur-fitmycv.json
{
  "name": "Bienvenue sur FitMyCV",
  "triggerName": "welcome",
  "subject": "Bienvenue sur FitMyCV.io !",
  "variables": ["userName", "loginUrl", "welcomeCredits"],
  "htmlContent": "&lt;!DOCTYPE html&gt;...",
  "designJson": { ... },
  "isActive": true,
  "isDefault": true
}</code></pre>

        <div class="callout callout-info">
          <strong>Slugification</strong> &mdash; Le nom du template est converti en slug (minuscules, sans accents, tirets) via la fonction interne <code>slugify()</code> : <code>"Bienvenue sur FitMyCV"</code> &rarr; <code>"bienvenue-sur-fitmycv"</code>.
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ preview-emails ‚îÄ‚îÄ‚îÄ -->

        <h2>preview-emails.js &mdash; Pr√©visualisation Emails</h2>

        <p>Lance un serveur HTTP local pour pr√©visualiser les templates email avec support du <strong>dark/light mode</strong> et substitution de variables de test.</p>

        <h3>Usage</h3>

        <pre><code class="language-bash"># Lancer le serveur (port 3001 par d√©faut)
node scripts/preview-emails.js

# Changer le port
node scripts/preview-emails.js --port 4000</code></pre>

        <h3>Fonctionnalit√©s</h3>

        <table>
          <thead>
            <tr>
              <th>Fonctionnalit√©</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Index HTML</strong></td>
              <td>Page d'accueil listant tous les templates avec liens vers chaque mode</td>
            </tr>
            <tr>
              <td><strong>Mode Auto</strong></td>
              <td>Respecte <code>prefers-color-scheme</code> du syst√®me</td>
            </tr>
            <tr>
              <td><strong>Mode Light</strong></td>
              <td>Force l'affichage clair</td>
            </tr>
            <tr>
              <td><strong>Mode Dark</strong></td>
              <td>Injecte des styles CSS dark mode (classes FitMyCV)</td>
            </tr>
            <tr>
              <td><strong>Variables de test</strong></td>
              <td>Substitution automatique des <code>{{placeholders}}</code></td>
            </tr>
          </tbody>
        </table>

        <h3>Variables de test par template</h3>

        <pre><code class="language-javascript">const TEST_VARIABLES = {
  email_verification: {
    userName: 'Jean Dupont',
    verificationUrl: 'https://app.fitmycv.io/auth/verify-email?token=abc123xyz',
  },
  welcome: {
    userName: 'Marie Martin',
    loginUrl: 'https://app.fitmycv.io/auth/signin',
    welcomeCredits: '5',
  },
  password_reset: {
    userName: 'Pierre Bernard',
    resetUrl: 'https://app.fitmycv.io/auth/reset-password?token=reset123xyz',
  },
  email_change: {
    userName: 'Sophie Durand',
    verificationUrl: 'https://app.fitmycv.io/auth/verify-email-change?token=...',
    newEmail: 'sophie.new@example.com',
  },
  purchase_credits: {
    userName: 'Lucas Petit',
    creditsAmount: '50',
    totalPrice: '9,99 ‚Ç¨',
    invoiceUrl: 'https://pay.stripe.com/invoice/abc123',
  },
};</code></pre>

        <h3>URLs g√©n√©r√©es</h3>

        <p>Pour chaque template, 3 fichiers HTML sont g√©n√©r√©s dans <code>.email-preview/</code> :</p>

        <pre><code class="language-bash">http://localhost:3001/                     # Index (liste tous les templates)
http://localhost:3001/welcome.html          # Mode Auto
http://localhost:3001/welcome-light.html    # Mode Light forc√©
http://localhost:3001/welcome-dark.html     # Mode Dark forc√©
http://localhost:3001/email_verification.html
http://localhost:3001/password_reset.html
http://localhost:3001/email_change.html
http://localhost:3001/purchase_credits.html</code></pre>

        <div class="callout callout-success">
          <strong>Workflow recommand√©</strong> &mdash; Ex√©cuter d'abord <code>export-email-templates.js</code> pour r√©cup√©rer les templates depuis la DB, puis <code>preview-emails.js</code> pour les pr√©visualiser dans le navigateur.
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ R√©capitulatif ‚îÄ‚îÄ‚îÄ -->

        <h2>R√©capitulatif des commandes</h2>

        <table>
          <thead>
            <tr>
              <th>Commande</th>
              <th>Contexte</th>
              <th>Quand l'utiliser</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>bash scripts/bump-version.sh</code></td>
              <td>CI/CD uniquement</td>
              <td>Automatique au merge sur <code>main</code> (ne pas lancer manuellement)</td>
            </tr>
            <tr>
              <td><code>npm run db:migrate-data</code></td>
              <td>D√©ploiement</td>
              <td>Apr√®s <code>npx prisma migrate deploy</code>, automatique en CI/CD</td>
            </tr>
            <tr>
              <td><code>node scripts/sync-stripe.mjs</code></td>
              <td>Production</td>
              <td>Apr√®s modification des plans/packs en DB</td>
            </tr>
            <tr>
              <td><code>node scripts/sync-staging-stripe.js</code></td>
              <td>Staging</td>
              <td>Avant tests de paiement sur <code>dev.fitmycv.io</code></td>
            </tr>
            <tr>
              <td><code>node scripts/export-email-templates.js</code></td>
              <td>Dev</td>
              <td>Apr√®s modification d'un template email en DB</td>
            </tr>
            <tr>
              <td><code>node scripts/preview-emails.js</code></td>
              <td>Dev</td>
              <td>Pour valider visuellement les emails (dark/light)</td>
            </tr>
          </tbody>
        </table>

      </div>
    </main>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
