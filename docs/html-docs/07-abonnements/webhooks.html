<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webhooks Stripe | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>

    <main class="main">
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <a href="./overview.html">Abonnements</a>
          <span>/</span>
          <span>Webhooks</span>
        </div>

        <h1>Webhooks Stripe</h1>
        <p class="lead">
          Le handler <code>POST /api/webhooks/stripe</code> traite <strong>9 types d'events</strong> Stripe avec une architecture modulaire, une idempotence renforc&eacute;e et une tra&ccedil;abilit&eacute; compl&egrave;te.
        </p>

        <h2>Architecture Modulaire</h2>

        <pre><code class="language-bash">app/api/webhooks/stripe/
├── route.js              # Router principal (signature, logging, dispatch)
└── handlers/
    ├── index.js          # Re-export de tous les handlers
    ├── subscriptions.js  # handleSubscriptionUpdate, handleSubscriptionDeleted
    ├── checkout.js       # handleCheckoutCompleted
    ├── payments.js       # handlePaymentSuccess, handleChargeSucceeded
    ├── invoices.js       # handleInvoicePaid, handleInvoicePaymentFailed
    ├── disputes.js       # handleChargeDispute
    └── utils.js          # createInvoiceForCreditPurchase, updateCustomerBillingDetails</code></pre>

        <h2>&Eacute;v&eacute;nements G&eacute;r&eacute;s</h2>

        <table>
          <thead>
            <tr>
              <th>Event Stripe</th>
              <th>Handler</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>customer.subscription.created</code></td>
              <td><code>handleSubscriptionUpdate</code></td>
              <td>Cr&eacute;er/MAJ Subscription en DB (plan, status, p&eacute;riode, billing)</td>
            </tr>
            <tr>
              <td><code>customer.subscription.updated</code></td>
              <td><code>handleSubscriptionUpdate</code></td>
              <td>Sync status, plan, p&eacute;riode, cancelAtPeriodEnd</td>
            </tr>
            <tr>
              <td><code>customer.subscription.deleted</code></td>
              <td><code>handleSubscriptionDeleted</code></td>
              <td>Downgrade vers Gratuit (sauf si upgrade en cours)</td>
            </tr>
            <tr>
              <td><code>checkout.session.completed</code></td>
              <td><code>handleCheckoutCompleted</code></td>
              <td><strong>Abonnement</strong> : MAJ billing details Customer<br/><strong>Cr&eacute;dits</strong> : grantCredits() avec idempotence</td>
            </tr>
            <tr>
              <td><code>payment_intent.succeeded</code></td>
              <td><code>handlePaymentSuccess</code></td>
              <td><strong>Fallback</strong> cr&eacute;dits : grantCredits() si checkout n'a pas trait&eacute;</td>
            </tr>
            <tr>
              <td><code>charge.succeeded</code></td>
              <td><code>handleChargeSucceeded</code></td>
              <td><strong>Cr&eacute;ation facture</strong> cr&eacute;dits (billing_details garantis) + email</td>
            </tr>
            <tr>
              <td><code>invoice.paid</code></td>
              <td><code>handleInvoicePaid</code></td>
              <td>Renouvellement : reset compteurs features, MAJ p&eacute;riode</td>
            </tr>
            <tr>
              <td><code>invoice.payment_failed</code></td>
              <td><code>handleInvoicePaymentFailed</code></td>
              <td>Downgrade imm&eacute;diat vers plan Gratuit</td>
            </tr>
            <tr>
              <td><code>charge.dispute.created</code></td>
              <td><code>handleChargeDispute</code></td>
              <td><strong>Cr&eacute;dits</strong> : d&eacute;bit forc&eacute; (balance n&eacute;gative possible)<br/><strong>Abonnement</strong> : annulation imm&eacute;diate</td>
            </tr>
          </tbody>
        </table>

        <h2>Workflow Achat de Cr&eacute;dits</h2>

        <p>L'attribution des cr&eacute;dits et la cr&eacute;ation de facture sont r&eacute;parties sur 3 webhooks pour garantir la fiabilit&eacute; :</p>

        <div class="diagram">
          <div class="diagram-title">Cha&icirc;ne de webhooks pour achat de cr&eacute;dits</div>
          <div class="mermaid">
sequenceDiagram
    participant CS as Paiement terminé
    participant PI as Intention de paiement réussie
    participant CH as Charge réussie

    Note over CS: PRIORITAIRE : Attribution crédits<br/>(métadonnées complètes)
    CS->>CS: Attribuer les crédits
    CS->>CS: Vérifier l'unicité du paiement

    Note over PI: SECOURS : Si paiement non traité
    PI->>PI: Vérifier si transaction existe déjà
    PI->>PI: Attribuer les crédits si absent

    Note over CH: FACTURE : infos facturation GARANTIES
    CH->>CH: Vérifier ou créer la transaction
    CH->>CH: Créer la facture d'achat de crédits
    CH->>CH: Envoyer email confirmation
          </div>
        </div>

        <div class="callout callout-success">
          <div class="callout-title">Pourquoi charge.succeeded pour les factures ?</div>
          <p>C'est le <strong>seul webhook</strong> o&ugrave; Stripe <strong>garantit</strong> que <code>billing_details</code> est disponible et complet. Les webhooks <code>checkout.session.completed</code> et <code>payment_intent.succeeded</code> arrivent trop t&ocirc;t (charges pas encore cr&eacute;&eacute;es).</p>
        </div>

        <h2>Idempotence</h2>

        <p>Trois niveaux de protection contre les doublons :</p>

        <table>
          <thead>
            <tr>
              <th>Niveau</th>
              <th>M&eacute;canisme</th>
              <th>D&eacute;tail</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>1. Event ID</strong></td>
              <td><code>StripeWebhookLog.eventId</code> (unique)</td>
              <td>V&eacute;rification <code>processed: true</code> avant traitement</td>
            </tr>
            <tr>
              <td><strong>2. PaymentIntent ID</strong></td>
              <td><code>CreditTransaction.stripePaymentIntentId</code> (unique)</td>
              <td>Emp&ecirc;che la double attribution de cr&eacute;dits</td>
            </tr>
            <tr>
              <td><strong>3. Race condition</strong></td>
              <td>Catch <code>P2002</code> (unique constraint)</td>
              <td>G&egrave;re les webhooks arrivant simultan&eacute;ment</td>
            </tr>
          </tbody>
        </table>

        <h2>Mod&egrave;le StripeWebhookLog</h2>

        <pre><code class="language-javascript">model StripeWebhookLog {
  id        String   @id @default(cuid())
  eventId   String   @unique    // ID unique de l'event Stripe
  eventType String              // "checkout.session.completed", etc.
  payload   String              // Payload JSON complet
  processed Boolean  @default(false)
  error     String?             // Message d'erreur si &eacute;chec
  createdAt DateTime @default(now())
}</code></pre>

        <h2>Flux du Router Principal</h2>

        <pre><code class="language-javascript">// app/api/webhooks/stripe/route.js

export async function POST(request) {
  // 1. V&eacute;rifier signature Stripe
  const event = stripe.webhooks.constructEvent(
    body, signature, process.env.STRIPE_WEBHOOK_SECRET
  );

  // 2. Logger l'event dans StripeWebhookLog
  await prisma.stripeWebhookLog.create({ ... });

  // 3. V&eacute;rifier idempotence (event d&eacute;j&agrave; trait&eacute; ?)
  const alreadyProcessed = await prisma.stripeWebhookLog.findFirst({
    where: { eventId: event.id, processed: true }
  });
  if (alreadyProcessed) return { received: true };

  // 4. Router vers le handler appropri&eacute;
  switch (event.type) {
    case 'customer.subscription.created':
    case 'customer.subscription.updated':
      await handleSubscriptionUpdate(event.data.object);
      break;
    case 'customer.subscription.deleted':
      await handleSubscriptionDeleted(event.data.object);
      break;
    // ... 5 autres events
  }

  // 5. Marquer comme trait&eacute;
  await prisma.stripeWebhookLog.updateMany({
    where: { eventId: event.id },
    data: { processed: true }
  });
}</code></pre>

        <h2>Handler handleSubscriptionDeleted</h2>

        <div class="callout callout-info">
          <div class="callout-title">D&eacute;tection d'upgrade</div>
          <p>Lors d'un upgrade, Stripe supprime l'ancien abonnement et en cr&eacute;e un nouveau. Le handler v&eacute;rifie si l'utilisateur a d&eacute;j&agrave; un abonnement <strong>diff&eacute;rent et actif</strong> en DB avant de d&eacute;clencher le downgrade. Si c'est le cas, l'event est ignor&eacute;.</p>
        </div>

        <h2>Cr&eacute;ation de Factures (Cr&eacute;dits)</h2>

        <pre><code class="language-javascript">// handlers/utils.js - createInvoiceForCreditPurchase()

// 1. R&eacute;cup&eacute;rer billing_details depuis la charge
const billingDetails = paymentIntent.charges.data[0].billing_details;

// 2. Mettre &agrave; jour le Customer Stripe
await stripe.customers.update(customer, {
  name: billingDetails.name,
  address: billingDetails.address,
});

// 3. Cr&eacute;er un draft invoice
const invoice = await stripe.invoices.create({
  customer, auto_advance: false,
  description: `Achat de ${creditAmount} cr&eacute;dits FitMyCV.io`,
  rendering: { template: STRIPE_INVOICE_TEMPLATE_ID }, // optionnel
});

// 4. Ajouter l'item
await stripe.invoiceItems.create({ customer, invoice: invoice.id, amount, currency });

// 5. Finaliser (g&eacute;n&egrave;re le PDF)
const finalizedInvoice = await stripe.invoices.finalizeInvoice(invoice.id);

// 6. Marquer comme pay&eacute; (hors-bande car d&eacute;j&agrave; pay&eacute; via Checkout)
await stripe.invoices.pay(finalizedInvoice.id, { paid_out_of_band: true });

// 7. Lier &agrave; la CreditTransaction
await prisma.creditTransaction.update({
  where: { id: transactionId },
  data: { stripeInvoiceId: paidInvoice.id }
});</code></pre>

        <h2>Variables d'Environnement</h2>

        <table>
          <thead>
            <tr>
              <th>Variable</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>STRIPE_SECRET_KEY</code></td>
              <td>Cl&eacute; secr&egrave;te Stripe (sk_test_... ou sk_live_...)</td>
            </tr>
            <tr>
              <td><code>STRIPE_WEBHOOK_SECRET</code></td>
              <td>Secret du webhook (whsec_...)</td>
            </tr>
            <tr>
              <td><code>STRIPE_INVOICE_TEMPLATE_ID</code></td>
              <td>Template de rendu facture (optionnel)</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
