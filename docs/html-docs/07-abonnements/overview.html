<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abonnements | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <!-- Sidebar injectée par layout.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="main">
      <!-- Header injecté par layout.js -->
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <span>Abonnements</span>
        </div>

        <h1>Système d'Abonnements</h1>
        <p class="lead">
          FitMyCV.io utilise Stripe pour gérer les abonnements et paiements. Le système supporte deux modèles économiques configurables : abonnement avec crédits ou crédits uniquement.
        </p>

        <h2>Architecture</h2>

        <div class="diagram">
          <div class="diagram-title">Intégration Stripe</div>
          <div class="mermaid">
flowchart TB
    subgraph App["APPLICATION"]
        Plans["Plans en DB"]
        Sub["Subscription model"]
        Balance["CreditBalance"]
    end

    subgraph Stripe["STRIPE"]
        Products["Products"]
        Prices["Prices"]
        Customers["Customers"]
        Subscriptions["Subscriptions"]
        Checkout["Checkout Sessions"]
    end

    subgraph Sync["SYNCHRONISATION"]
        Webhooks["Webhooks"]
        Events["Events"]
    end

    App <--> Stripe
    Stripe --> Webhooks
    Webhooks --> App

    Plans --> Products
    Sub --> Subscriptions
    Checkout --> Balance
          </div>
        </div>

        <h2>Plans d'Abonnement</h2>

        <table>
          <thead>
            <tr>
              <th>Plan</th>
              <th>Prix</th>
              <th>Limites mensuelles</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Free</strong></td>
              <td>0€/mois</td>
              <td>3 générations CV, 1 export, 5 match scores</td>
            </tr>
            <tr>
              <td><strong>Pro</strong></td>
              <td>9.99€/mois</td>
              <td>20 générations CV, 10 exports, 50 match scores</td>
            </tr>
            <tr>
              <td><strong>Premium</strong></td>
              <td>19.99€/mois</td>
              <td>Illimité sur la plupart des features</td>
            </tr>
          </tbody>
        </table>

        <h2>Modèles de Données</h2>

        <h3>Subscription</h3>

        <pre><code>model Subscription {
  id                    Int       @id @default(autoincrement())
  userId                String    @unique
  stripeCustomerId      String?
  stripeSubscriptionId  String?   @unique
  stripePriceId         String?
  status                String    // active, canceled, past_due, etc.
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelAtPeriodEnd     Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user                  User      @relation(fields: [userId], references: [id])
  plan                  SubscriptionPlan? @relation(fields: [stripePriceId], references: [stripePriceId])
}</code></pre>

        <h3>SubscriptionPlan</h3>

        <pre><code>model SubscriptionPlan {
  id              Int       @id @default(autoincrement())
  name            String    // Free, Pro, Premium
  displayName     String
  description     String?
  priceMonthly    Decimal
  priceYearly     Decimal?
  stripePriceId   String?   @unique
  stripeProductId String?
  isActive        Boolean   @default(true)
  isDefault       Boolean   @default(false)
  sortOrder       Int       @default(0)
  createdAt       DateTime  @default(now())

  subscriptions   Subscription[]
  featureLimits   FeatureLimit[]
}</code></pre>

        <h3>FeatureLimit</h3>

        <pre><code>model FeatureLimit {
  id          Int       @id @default(autoincrement())
  planId      Int
  featureName String    // gpt_cv_generation, export_cv, etc.
  usageLimit  Int       // -1 = illimité
  isEnabled   Boolean   @default(true)

  plan        SubscriptionPlan @relation(fields: [planId], references: [id])

  @@unique([planId, featureName])
}</code></pre>

        <h2>Vérification des Limites</h2>

        <pre><code>// lib/subscription/featureUsage.js

export async function canUseFeature(userId, featureName) {
  // 1. Vérifier balance négative (chargeback)
  const balance = await getCreditBalance(userId);
  if (balance < 0) {
    return { canUse: false, reason: 'balance_negative' };
  }

  // 2. Mode crédits uniquement ?
  const subscriptionMode = await getSetting('subscription_mode_enabled');
  if (subscriptionMode !== 'true') {
    return checkCreditsOnly(userId, featureName);
  }

  // 3. Récupérer le plan de l'utilisateur
  const subscription = await prisma.subscription.findUnique({
    where: { userId },
    include: { plan: { include: { featureLimits: true } } }
  });

  const plan = subscription?.plan || await getDefaultPlan();
  const limit = plan.featureLimits.find(l => l.featureName === featureName);

  // 4. Feature désactivée ?
  if (!limit?.isEnabled) {
    return checkCreditsAvailable(userId, featureName);
  }

  // 5. Illimité ?
  if (limit.usageLimit === -1) {
    return { canUse: true, useCredit: false };
  }

  // 6. Vérifier compteur mensuel
  const counter = await getFeatureCounter(userId, featureName);
  if (counter.count < limit.usageLimit) {
    return { canUse: true, useCredit: false };
  }

  // 7. Limite atteinte → crédits ?
  return checkCreditsAvailable(userId, featureName);
}</code></pre>

        <h2>Flux Checkout</h2>

        <div class="diagram">
          <div class="diagram-title">Processus de souscription</div>
          <div class="mermaid">
sequenceDiagram
    participant U as Utilisateur
    participant App as Application
    participant Stripe as Stripe
    participant WH as Webhook

    U->>App: Clic "Souscrire Pro"
    App->>Stripe: Créer Checkout Session
    Stripe-->>App: Session URL
    App-->>U: Redirection Stripe

    U->>Stripe: Paiement
    Stripe->>WH: checkout.session.completed
    WH->>App: Mise à jour Subscription

    Stripe->>WH: invoice.payment_succeeded
    WH->>App: Confirmation paiement

    App-->>U: Redirection succès
          </div>
        </div>

        <h2>Webhooks Stripe</h2>

        <table>
          <thead>
            <tr>
              <th>Event</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>checkout.session.completed</code></td>
              <td>Créer/Mettre à jour Subscription</td>
            </tr>
            <tr>
              <td><code>customer.subscription.updated</code></td>
              <td>Sync status, période, plan</td>
            </tr>
            <tr>
              <td><code>customer.subscription.deleted</code></td>
              <td>Marquer comme canceled</td>
            </tr>
            <tr>
              <td><code>invoice.payment_succeeded</code></td>
              <td>Confirmer paiement, reset compteurs</td>
            </tr>
            <tr>
              <td><code>invoice.payment_failed</code></td>
              <td>Marquer past_due, notifier user</td>
            </tr>
          </tbody>
        </table>

        <h2>API Endpoints</h2>

        <table>
          <thead>
            <tr>
              <th>Endpoint</th>
              <th>Méthode</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/api/subscription</code></td>
              <td>GET</td>
              <td>Récupérer l'abonnement actuel</td>
            </tr>
            <tr>
              <td><code>/api/subscription/checkout</code></td>
              <td>POST</td>
              <td>Créer session Checkout</td>
            </tr>
            <tr>
              <td><code>/api/subscription/portal</code></td>
              <td>POST</td>
              <td>Accéder au Customer Portal</td>
            </tr>
            <tr>
              <td><code>/api/subscription/cancel</code></td>
              <td>POST</td>
              <td>Annuler à la fin de période</td>
            </tr>
            <tr>
              <td><code>/api/webhooks/stripe</code></td>
              <td>POST</td>
              <td>Recevoir webhooks Stripe</td>
            </tr>
          </tbody>
        </table>

        <h2>Fichiers Clés</h2>

        <table>
          <thead>
            <tr>
              <th>Fichier</th>
              <th>Rôle</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>lib/subscription/subscriptions.js</code></td>
              <td>Gestion abonnements Stripe</td>
            </tr>
            <tr>
              <td><code>lib/subscription/featureUsage.js</code></td>
              <td>Vérification limites & crédits</td>
            </tr>
            <tr>
              <td><code>lib/stripe/client.js</code></td>
              <td>Client Stripe configuré</td>
            </tr>
            <tr>
              <td><code>app/api/webhooks/stripe/route.js</code></td>
              <td>Handler webhooks</td>
            </tr>
          </tbody>
        </table>

        <h2>Prochaines Sections</h2>

        <ul>
          <li><a href="business-models.html">Modèles économiques</a> - Abonnement vs Crédits</li>
          <li><a href="plans-stripe.html">Plans Stripe</a> - Configuration détaillée</li>
          <li><a href="checkout-flow.html">Checkout</a> - Flux de paiement</li>
          <li><a href="webhooks.html">Webhooks</a> - Synchronisation events</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
