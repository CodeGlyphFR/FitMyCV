<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plans Stripe | FitMyCV.io</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=1.0.4">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: false });</script>
</head>
<body>
  <div class="layout">
    <div id="sidebar-container"></div>

    <main class="main">
      <div id="header-container"></div>

      <div class="content">
        <div class="breadcrumb">
          <a href="../index.html">Docs</a>
          <span>/</span>
          <a href="./overview.html">Abonnements</a>
          <span>/</span>
          <span>Plans Stripe</span>
        </div>

        <h1>Plans Stripe</h1>
        <p class="lead">
          Configuration des plans d'abonnement, synchronisation avec Stripe et syst&egrave;me de tiers.
        </p>

        <h2>Mod&egrave;le SubscriptionPlan</h2>

        <pre><code class="language-javascript">model SubscriptionPlan {
  id                    Int       @id @default(autoincrement())
  name                  String    @unique    // "Gratuit", "Pro", "Premium"
  description           String?
  isFree                Boolean   @default(false)
  tier                  Int       @default(0) // 0=Gratuit, 1=Pro, 2=Premium
  isPopular             Boolean   @default(false)
  priceMonthly          Float     @default(0)
  priceYearly           Float     @default(0)
  yearlyDiscountPercent Float     @default(0)
  priceCurrency         String    @default("EUR")
  stripeProductId       String?   @unique
  stripePriceIdMonthly  String?   @unique  // Stripe Price ID mensuel
  stripePriceIdYearly   String?   @unique  // Stripe Price ID annuel

  subscriptions         Subscription[]
  featureLimits         SubscriptionPlanFeatureLimit[]
}</code></pre>

        <h2>Syst&egrave;me de Tiers</h2>

        <p>Chaque plan a un <code>tier</code> num&eacute;rique utilis&eacute; pour d&eacute;terminer les upgrades/downgrades :</p>

        <pre><code class="language-javascript">// lib/subscription/planUtils.js

export function getPlanTier(plan) {
  if (typeof plan.tier === 'number') return plan.tier;

  // Fallback par prix
  if (plan.priceMonthly === 0 &amp;&amp; plan.priceYearly === 0) return 0; // Gratuit
  if (plan.priceMonthly > 20) return 2; // Premium
  return 1; // Pro
}

export function comparePlans(currentPlan, targetPlan) {
  const currentTier = getPlanTier(currentPlan);
  const targetTier = getPlanTier(targetPlan);

  if (targetTier > currentTier) return 'upgrade';
  if (targetTier < currentTier) return 'downgrade';
  return 'same';
}</code></pre>

        <h2>Mod&egrave;le CreditPack</h2>

        <pre><code class="language-javascript">model CreditPack {
  id              Int      @id @default(autoincrement())
  name            String
  description     String?
  creditAmount    Int      @unique   // Nombre de cr&eacute;dits
  price           Float              // Prix en euros
  priceCurrency   String   @default("EUR")
  isActive        Boolean  @default(true)
  stripeProductId String?  @unique
  stripePriceId   String?  @unique   // Prix unique (pas d'intervalle)
}</code></pre>

        <h2>Synchronisation Stripe</h2>

        <p>La synchronisation bidirectionnelle est g&eacute;r&eacute;e par <code>lib/subscription/stripeSync.js</code> :</p>

        <div class="diagram">
          <div class="diagram-title">Flux de synchronisation</div>
          <div class="mermaid">
flowchart LR
    subgraph DB["BASE DE DONNEES"]
        Plans["SubscriptionPlan"]
        Packs["CreditPack"]
    end

    subgraph Sync["syncStripeProductsInternal"]
        PlanSync["Pour chaque plan payant :<br/>1. Creer/recuperer Product<br/>2. Creer/verifier Price mensuel<br/>3. Creer/verifier Price annuel<br/>4. Archiver anciens prix"]
        PackSync["Pour chaque pack actif :<br/>1. Creer/recuperer Product<br/>2. Creer/verifier Price<br/>3. Definir default_price<br/>4. Archiver ancien prix"]
    end

    subgraph Stripe["STRIPE"]
        Products["Products"]
        Prices["Prices"]
    end

    Plans --> PlanSync
    Packs --> PackSync
    PlanSync --> Products
    PlanSync --> Prices
    PackSync --> Products
    PackSync --> Prices

    style Plans fill:#14b8a6,stroke:#0d9488,color:#fff
    style Packs fill:#14b8a6,stroke:#0d9488,color:#fff
    style PlanSync fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style PackSync fill:#8b5cf6,stroke:#7c3aed,color:#fff
    style Products fill:#6366f1,stroke:#4f46e5,color:#fff
    style Prices fill:#6366f1,stroke:#4f46e5,color:#fff
          </div>
        </div>

        <div class="callout callout-warning">
          <div class="callout-title">Plans gratuits exclus</div>
          <p>Les plans avec <code>isFree = true</code> sont <strong>syst&eacute;matiquement ignor&eacute;s</strong> par la synchronisation. Ils n'existent que localement en base de donn&eacute;es.</p>
        </div>

        <h3>Gestion des prix</h3>

        <ul>
          <li><strong>Plans</strong> : 2 prices par plan (monthly + yearly), devises en <code>priceCurrency</code> (d&eacute;faut EUR)</li>
          <li><strong>Packs</strong> : 1 price par pack (paiement unique)</li>
          <li>Si le montant change : ancien prix <strong>archiv&eacute;</strong> (d&eacute;sactiv&eacute;), nouveau prix cr&eacute;&eacute;</li>
          <li>Pour les packs, le nouveau prix est d&eacute;fini comme <code>default_price</code> avant d'archiver l'ancien</li>
        </ul>

        <h2>Feature Limits par Plan</h2>

        <pre><code class="language-javascript">model SubscriptionPlanFeatureLimit {
  id          String  @id @default(cuid())
  planId      Int
  featureName String  // "gpt_cv_generation", "export_cv", etc.
  isEnabled   Boolean @default(true)
  usageLimit  Int     @default(-1)  // -1 = illimit&eacute;

  plan        SubscriptionPlan @relation(...)

  @@unique([planId, featureName])
}</code></pre>

        <h3>Macro-Features</h3>

        <p>Les features sont regroup&eacute;es en <strong>macro-features</strong> dans <code>lib/subscription/macroFeatures.js</code> :</p>

        <table>
          <thead>
            <tr>
              <th>Macro-Feature</th>
              <th>Micro-Features</th>
              <th>IA</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>gpt_cv_generation</strong></td>
              <td>generate_cv_url, generate_cv_pdf, extract_job_offer_url, extract_job_offer_pdf, create_template_cv_url, create_template_cv_pdf</td>
              <td>Oui</td>
            </tr>
            <tr>
              <td><strong>import_pdf</strong></td>
              <td>import_pdf, first_import_pdf, import_cv</td>
              <td>Oui</td>
            </tr>
            <tr>
              <td><strong>translate_cv</strong></td>
              <td>translate_cv</td>
              <td>Oui</td>
            </tr>
            <tr>
              <td><strong>match_score</strong></td>
              <td>match_score</td>
              <td>Oui</td>
            </tr>
            <tr>
              <td><strong>optimize_cv</strong></td>
              <td>optimize_cv</td>
              <td>Oui</td>
            </tr>
            <tr>
              <td><strong>generate_from_job_title</strong></td>
              <td>generate_from_job_title</td>
              <td>Oui</td>
            </tr>
            <tr>
              <td><strong>export_cv</strong></td>
              <td>export_cv</td>
              <td>Non</td>
            </tr>
            <tr>
              <td><strong>edit_cv</strong></td>
              <td>edit_cv</td>
              <td>Non</td>
            </tr>
            <tr>
              <td><strong>create_cv_manual</strong></td>
              <td>create_cv_manual</td>
              <td>Non</td>
            </tr>
          </tbody>
        </table>

        <h2>Traduction des Noms de Plans</h2>

        <p><code>lib/subscription/planTranslations.js</code> traduit les noms de plans stock&eacute;s en fran&ccedil;ais :</p>

        <table>
          <thead>
            <tr>
              <th>Plan (DB)</th>
              <th>FR</th>
              <th>EN</th>
              <th>ES</th>
              <th>DE</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Gratuit</td>
              <td>Gratuit</td>
              <td>Free</td>
              <td>Gratuito</td>
              <td>Kostenlos</td>
            </tr>
            <tr>
              <td>Pro</td>
              <td>Pro</td>
              <td>Pro</td>
              <td>Pro</td>
              <td>Pro</td>
            </tr>
            <tr>
              <td>Premium</td>
              <td>Premium</td>
              <td>Premium</td>
              <td>Premium</td>
              <td>Premium</td>
            </tr>
          </tbody>
        </table>

        <!-- ==================== PLANUTILS COMPLET ==================== -->
        <h2>Utilitaires de Plans (<code>planUtils.js</code>)</h2>

        <p><strong>Fichier :</strong> <code>lib/subscription/planUtils.js</code> &mdash; 10 fonctions export&eacute;es utilis&eacute;es dans toute l'application.</p>

        <h3>Identification des Plans</h3>

        <pre><code class="language-javascript">// Détecte si un plan est gratuit (priorité au flag, fallback sur prix)
export function isFreePlan(plan) {
  if (!plan) return false;
  return plan.isFree ?? (plan.priceMonthly === 0 &amp;&amp; plan.priceYearly === 0);
}

// Obtient le tier numérique (0=Gratuit, 1=Pro, 2=Premium)
export function getPlanTier(plan) {
  if (!plan) return 0;
  if (typeof plan.tier === 'number') return plan.tier;
  // Fallback par prix
  if (plan.priceMonthly === 0 &amp;&amp; plan.priceYearly === 0) return 0;
  if (plan.priceMonthly > 20) return 2;
  return 1;
}

// Vérifie si populaire/recommandé
export function isPopularPlan(plan) {
  return plan?.isPopular ?? false;
}</code></pre>

        <h3>Comparaison de Plans</h3>

        <pre><code class="language-javascript">// Compare deux plans : upgrade, downgrade ou same
export function comparePlans(currentPlan, targetPlan) {
  if (!currentPlan || !targetPlan) return 'same';
  const currentTier = getPlanTier(currentPlan);
  const targetTier = getPlanTier(targetPlan);
  if (targetTier > currentTier) return 'upgrade';
  if (targetTier &lt; currentTier) return 'downgrade';
  return 'same';
}

// Raccourcis
export function isUpgrade(current, target) {
  return comparePlans(current, target) === 'upgrade';
}
export function isDowngrade(current, target) {
  return comparePlans(current, target) === 'downgrade';
}</code></pre>

        <h3>Table de Comparaison des Tiers</h3>

        <table>
          <thead>
            <tr>
              <th>Propri&eacute;t&eacute;</th>
              <th><span class="badge badge-success">Tier 0 &mdash; Gratuit</span></th>
              <th><span class="badge badge-primary">Tier 1 &mdash; Pro</span></th>
              <th><span class="badge badge-warning">Tier 2 &mdash; Premium</span></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>isFree</strong></td>
              <td><code>true</code></td>
              <td><code>false</code></td>
              <td><code>false</code></td>
            </tr>
            <tr>
              <td><strong>priceMonthly</strong></td>
              <td>0&euro;</td>
              <td>&le; 20&euro;</td>
              <td>&gt; 20&euro;</td>
            </tr>
            <tr>
              <td><strong>Stripe</strong></td>
              <td>Pas de sync</td>
              <td>Product + 2 Prices</td>
              <td>Product + 2 Prices</td>
            </tr>
            <tr>
              <td><strong>Couleur Tailwind</strong></td>
              <td><code>from-gray-500/20</code></td>
              <td><code>from-blue-500/20 to-cyan-500/20</code></td>
              <td><code>from-purple-500/20 to-pink-500/20</code></td>
            </tr>
            <tr>
              <td><strong>Features cost=0</strong></td>
              <td>Non autoris&eacute;</td>
              <td>Non autoris&eacute;</td>
              <td>Incluses gratuitement</td>
            </tr>
            <tr>
              <td><strong>Compteurs</strong></td>
              <td>Limites strictes</td>
              <td>Limites &eacute;tendues</td>
              <td>Illimit&eacute; (<code>-1</code>)</td>
            </tr>
          </tbody>
        </table>

        <h3>Fonctions d'Affichage</h3>

        <pre><code class="language-javascript">// Icône par tier
export function getPlanIcon(plan) {
  switch (getPlanTier(plan)) {
    case 2: return "&#128081;"; // Premium (couronne)
    case 1: return "&#9889;";  // Pro (éclair)
    default: return "&#127919;"; // Gratuit (cible)
  }
}

// Classes Tailwind gradient par tier
export function getPlanColorClass(plan) {
  switch (getPlanTier(plan)) {
    case 2: return "from-purple-500/20 to-pink-500/20 border-purple-500/50";
    case 1: return "from-blue-500/20 to-cyan-500/20 border-blue-500/50";
    default: return "from-gray-500/20 to-gray-600/20 border-gray-500/50";
  }
}

// Formatage du prix
export function formatPlanPrice(plan, period = 'monthly') {
  if (isFreePlan(plan)) return "Gratuit";
  const price = period === 'yearly' ? plan.priceYearly : plan.priceMonthly;
  const suffix = period === 'yearly' ? '/an' : '/mois';
  return `${price}&#8364;${suffix}`;
}

// Calcul du pourcentage d'économie annuelle
export function getYearlyDiscount(plan) {
  if (!plan?.priceYearly || !plan?.priceMonthly) return 0;
  const monthlyTotal = plan.priceMonthly * 12;
  return Math.round(((monthlyTotal - plan.priceYearly) / monthlyTotal) * 100);
  // Ex: 9.99*12=119.88, yearly=95.90 → (119.88-95.90)/119.88*100 = 20%
}</code></pre>

        <div class="callout callout-info">
          <div class="callout-title">Fallback robuste</div>
          <p>Toutes les fonctions g&egrave;rent <code>plan === null</code> avec des valeurs par d&eacute;faut s&ucirc;res (tier 0, prix &laquo; 0&euro; &raquo;, couleur grise). Cela &eacute;vite les crashes si l'abonnement n'est pas encore charg&eacute;.</p>
        </div>

        <!-- ==================== CHECKOUT IMPACT ==================== -->
        <h2>Impact sur le Checkout</h2>

        <div class="card-grid">
          <div class="card">
            <h4>Mode Abonnement</h4>
            <ul>
              <li>Grille des 3 plans avec toggle mensuel/annuel</li>
              <li>Boutons Upgrade/Downgrade via <code>comparePlans()</code></li>
              <li>Affichage discount annuel via <code>getYearlyDiscount()</code></li>
              <li>Checkout Stripe : mode <code>subscription</code></li>
              <li>Section cr&eacute;dits pour extension des limites</li>
            </ul>
          </div>
          <div class="card">
            <h4>Mode Cr&eacute;dits</h4>
            <ul>
              <li>Pas de grille de plans</li>
              <li>Balance de cr&eacute;dits + historique</li>
              <li>Packs de cr&eacute;dits (<code>CreditPack</code>)</li>
              <li>Checkout Stripe : mode <code>payment</code> (one-time)</li>
            </ul>
          </div>
        </div>

        <!-- ==================== VOIR AUSSI ==================== -->
        <h2>Voir aussi</h2>

        <ul>
          <li><a href="./business-models.html">Mod&egrave;les &Eacute;conomiques</a> &mdash; Toggle subscription_mode_enabled, canUseFeature()</li>
          <li><a href="./overview.html">Vue d'ensemble Abonnements</a></li>
        </ul>
      </div>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>

  <script src="../assets/js/layout.js?v=1.0.4"></script>
  <script src="../assets/js/main.js?v=1.0.4"></script>
</body>
</html>
