generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                @id @default(cuid())
  name                   String?
  email                  String?               @unique
  emailVerified          DateTime?
  passwordHash           String?
  image                  String?
  role                   String                @default("USER")
  resetToken             String?
  resetTokenExpiry       DateTime?
  stripeCustomerId       String?               @unique
  referralCode           String?               @unique
  referredBy             String?
  onboardingState        Json?                                  // État complet onboarding (UNIQUE source de vérité)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  accounts               Account[]
  backgroundTasks        BackgroundTask[]
  consentLogs            ConsentLog[]
  creditBalance          CreditBalance?
  creditTransactions     CreditTransaction[]
  cvs                    CvFile[]
  featureUsage           FeatureUsage[]
  featureCounters        FeatureUsageCounter[]
  feedbacks              Feedback[]
  jobOffers              JobOffer[]
  linkHistory            LinkHistory[]
  openaiCalls            OpenAICall[]
  openaiUsage            OpenAIUsage[]
  referredUsers          Referral?             @relation("Referred")
  referrals              Referral[]            @relation("Referrer")
  subscription           Subscription?
  telemetryEvents        TelemetryEvent[]
}

model Account {
  id                       String   @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  refresh_token_expires_in Int?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model CvFile {
  id                     String             @id @default(cuid())
  userId                 String
  filename               String
  content                Json?              // Contenu CV JSON (migré depuis filesystem)
  contentVersion         Int                @default(1) // Numéro de version courante
  sourceType             String?
  sourceValue            String?
  jobOfferId             String?            // Relation vers JobOffer (extraction structurée)
  createdBy              String?
  originalCreatedBy      String?
  isTranslated           Boolean            @default(false)
  language               String?            // Langue du CV (fr, en, es, de) - détectée à l'import
  matchScore             Int?
  matchScoreUpdatedAt    DateTime?
  matchScoreStatus       String?            @default("idle")
  scoreBreakdown         String?
  improvementSuggestions String?
  missingSkills          String?
  matchingSkills         String?
  optimiseStatus         String?            @default("idle")
  optimiseUpdatedAt      DateTime?
  createdWithCredit      Boolean            @default(false)
  creditUsedAt           DateTime?
  creditTransactionId    String?            @unique
  blocked                Boolean            @default(false)
  blockedAt              DateTime?
  blockedReason          String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditTransaction      CreditTransaction? @relation(fields: [creditTransactionId], references: [id])
  jobOffer               JobOffer?          @relation(fields: [jobOfferId], references: [id], onDelete: SetNull)
  versions               CvVersion[]        // Historique des versions (optimisation IA)

  @@unique([userId, filename])
  @@index([jobOfferId])
}

model CvVersion {
  id        String   @id @default(cuid())
  cvFileId  String
  version   Int      // Numéro de version (1, 2, 3...)
  content   Json     // Contenu JSON complet
  changelog String?  // "Optimisation IA", "Restauration depuis v2"
  createdAt DateTime @default(now())

  cvFile CvFile @relation(fields: [cvFileId], references: [id], onDelete: Cascade)

  @@unique([cvFileId, version])
  @@index([cvFileId, createdAt(sort: Desc)])
}

model JobOffer {
  id              String   @id @default(cuid())
  userId          String
  sourceType      String   // 'url' | 'pdf'
  sourceValue     String   // URL ou nom fichier PDF
  contentHash     String?  // Hash SHA256 du contenu PDF (null pour URLs)
  content         Json     // Extraction structurée JSON
  extractedAt     DateTime @default(now())
  extractionModel String   // Modèle IA utilisé pour l'extraction
  tokensUsed      Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cvFiles CvFile[] // CVs générés à partir de cette offre

  @@unique([userId, sourceValue])
  @@index([userId])
  @@index([sourceType])
  @@index([userId, contentHash])
}

model BackgroundTask {
  id                        String             @id
  title                     String
  successMessage            String?
  type                      String
  status                    String
  createdAt                 BigInt
  shouldUpdateCvList        Boolean            @default(false)
  result                    String?
  error                     String?
  payload                   String?
  deviceId                  String
  userId                    String?
  cvFile                    String?
  creditUsed                Boolean            @default(false)
  creditTransactionId       String?            @unique
  featureName               String?
  featureCounterPeriodStart DateTime?
  updatedAt                 DateTime           @default(now()) @updatedAt
  creditTransaction         CreditTransaction? @relation(fields: [creditTransactionId], references: [id])
  user                      User?              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([status])
  @@index([createdAt])
  @@index([cvFile, status])
}

model LinkHistory {
  id        String   @id @default(cuid())
  userId    String
  url       String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, url])
  @@index([userId, createdAt])
}

model Feedback {
  id            String   @id @default(cuid())
  userId        String
  rating        Int
  comment       String
  isBugReport   Boolean  @default(false)
  currentCvFile String?
  userAgent     String?
  pageUrl       String?
  createdAt     DateTime @default(now())
  status        String   @default("new")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([isBugReport])
  @@index([status])
}

model ConsentLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  preferences String
  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Setting {
  id          String   @id @default(cuid())
  settingName String   @unique
  value       String
  category    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([settingName])
}

model FeatureMapping {
  id               String   @id @default(cuid())
  featureKey       String   @unique
  displayName      String
  settingNames     Json     // Array of Setting.settingName values
  openAICallNames  Json     // Array of OpenAICall.featureName values
  planFeatureNames Json     // Array of SubscriptionPlanFeatureLimit.featureName values
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([featureKey])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expires])
}

model AutoSignInToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expires])
}

model EmailChangeRequest {
  id        String   @id @default(cuid())
  userId    String
  newEmail  String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expires])
}

model TelemetryEvent {
  id        String   @id @default(cuid())
  userId    String?
  type      String
  category  String
  metadata  String?
  deviceId  String?
  duration  Int?
  status    String?
  error     String?
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([category])
  @@index([deviceId])
  @@index([timestamp])
  @@index([userId, type])
  @@index([type, timestamp])
}

model FeatureUsage {
  id            String   @id @default(cuid())
  userId        String
  featureName   String
  usageCount    Int      @default(0)
  lastUsedAt    DateTime @default(now())
  totalDuration Int      @default(0)
  metadata      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureName])
  @@index([userId])
  @@index([featureName])
  @@index([lastUsedAt])
}

model OpenAIUsage {
  id               String   @id @default(cuid())
  userId           String
  featureName      String
  model            String
  date             DateTime
  promptTokens     Int      @default(0)
  cachedTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalTokens      Int      @default(0)
  estimatedCost    Float    @default(0)
  callsCount       Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureName, model, date])
  @@index([userId])
  @@index([featureName])
  @@index([model])
  @@index([date])
  @@index([userId, date])
  @@index([featureName, date])
}

model OpenAIPricing {
  id                   String   @id @default(cuid())
  modelName            String   @unique
  inputPricePerMToken  Float
  outputPricePerMToken Float
  cachePricePerMToken  Float    @default(0)
  description          String?
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([modelName])
  @@index([isActive])
}

model OpenAIAlert {
  id          String   @id @default(cuid())
  type        String
  threshold   Float
  enabled     Boolean  @default(true)
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([enabled])
}

model OpenAICall {
  id               String   @id @default(cuid())
  userId           String
  featureName      String
  model            String
  promptTokens     Int      @default(0)
  cachedTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalTokens      Int      @default(0)
  estimatedCost    Float    @default(0)
  duration         Int?
  metadata         String?
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([featureName])
  @@index([featureName, createdAt])
  @@index([userId, featureName])
  @@index([createdAt])
}

model SubscriptionPlan {
  id                    Int                            @id @default(autoincrement())
  name                  String                         @unique
  description           String?
  isFree                Boolean                        @default(false)
  tier                  Int                            @default(0)
  isPopular             Boolean                        @default(false)
  priceMonthly          Float                          @default(0)
  priceYearly           Float                          @default(0)
  yearlyDiscountPercent Float                          @default(0)
  priceCurrency         String                         @default("EUR")
  stripeProductId       String?                        @unique
  stripePriceIdMonthly  String?                        @unique
  stripePriceIdYearly   String?                        @unique
  createdAt             DateTime                       @default(now())
  updatedAt             DateTime                       @updatedAt
  subscriptions         Subscription[]
  featureLimits         SubscriptionPlanFeatureLimit[]

  @@index([name])
  @@index([tier])
}

model SubscriptionPlanFeatureLimit {
  id                    String           @id @default(cuid())
  planId                Int
  featureName           String
  isEnabled             Boolean          @default(true)
  usageLimit            Int              @default(-1)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, featureName])
  @@index([planId])
  @@index([featureName])
}

model CreditPack {
  id              Int      @id @default(autoincrement())
  name            String
  description     String?
  creditAmount    Int      @unique
  price           Float
  priceCurrency   String   @default("EUR")
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  stripePriceId   String?  @unique
  stripeProductId String?  @unique

  @@index([creditAmount])
  @@index([isActive])
}

model Subscription {
  id                   String           @id @default(cuid())
  userId               String           @unique
  stripeCustomerId     String           @unique
  stripeSubscriptionId String?          @unique
  stripePriceId        String?
  planId               Int
  status               String
  billingPeriod        String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean          @default(false)
  canceledAt           DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  plan                 SubscriptionPlan @relation(fields: [planId], references: [id])
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model CreditBalance {
  id             String   @id @default(cuid())
  userId         String   @unique
  balance        Int      @default(0)
  totalPurchased Int      @default(0)
  totalUsed      Int      @default(0)
  totalRefunded  Int      @default(0)
  totalGifted    Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CreditTransaction {
  id                    String          @id @default(cuid())
  userId                String
  amount                Int
  type                  String
  featureName           String?
  taskId                String?
  cvFileId              String?
  stripePaymentIntentId String?         @unique
  refunded              Boolean         @default(false)
  relatedTransactionId  String?
  metadata              String?
  createdAt             DateTime        @default(now())
  stripeInvoiceId       String?
  task                  BackgroundTask?
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  cvFile                CvFile?

  @@index([userId])
  @@index([type])
  @@index([featureName])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model FeatureUsageCounter {
  id          String   @id @default(cuid())
  userId      String
  featureName String
  count       Int      @default(0)
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureName]) // 1 compteur par feature par user (reset auto au changement de période)
  @@index([userId])
  @@index([featureName])
}

model StripeWebhookLog {
  id        String   @id @default(cuid())
  eventId   String   @unique
  eventType String
  payload   String
  processed Boolean  @default(false)
  error     String?
  createdAt DateTime @default(now())

  @@index([eventId])
  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
}

model Referral {
  id               String    @id @default(cuid())
  referrerId       String
  referredUserId   String    @unique
  referralCode     String
  status           String
  referrerReward   Int       @default(0)
  referredReward   Int       @default(0)
  rewardsGrantedAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  referredUser     User      @relation("Referred", fields: [referredUserId], references: [id], onDelete: Cascade)
  referrer         User      @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredUserId])
  @@index([referralCode])
  @@index([status])
}

model PromoCode {
  id             String    @id @default(cuid())
  code           String    @unique
  name           String
  type           String
  discountType   String?
  discountValue  Float?
  creditBonus    Int?
  applicableTo   String
  maxUses        Int?
  currentUses    Int       @default(0)
  validFrom      DateTime
  validUntil     DateTime?
  isActive       Boolean   @default(true)
  stripeCouponId String?   @unique
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([code])
  @@index([isActive])
  @@index([validFrom])
  @@index([validUntil])
}

model EmailTemplate {
  id          String     @id @default(cuid())
  name        String     @unique
  subject     String
  designJson  String
  htmlContent String
  variables   String
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  emailLogs   EmailLog[]

  @@index([name])
  @@index([isActive])
}

model EmailLog {
  id              String         @id @default(cuid())
  templateId      String?
  templateName    String
  recipientEmail  String
  recipientUserId String?
  subject         String
  status          String
  error           String?
  resendId        String?
  isTestEmail     Boolean        @default(false)
  createdAt       DateTime       @default(now())
  template        EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([templateId])
  @@index([templateName])
  @@index([recipientEmail])
  @@index([recipientUserId])
  @@index([status])
  @@index([createdAt])
}
