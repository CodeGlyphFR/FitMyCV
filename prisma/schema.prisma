generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                @id @default(cuid())
  name                     String?
  email                    String?               @unique
  emailVerified            DateTime?
  passwordHash             String?
  image                    String?
  role                     String                @default("USER")
  resetToken               String?
  resetTokenExpiry         DateTime?
  stripeCustomerId         String?               @unique
  onboardingState          Json?                                  // État complet onboarding (UNIQUE source de vérité)
  privacyPolicyAcceptedAt  DateTime?                              // Date d'acceptation de la politique de confidentialité
  lastLoginAt              DateTime?                              // Dernière connexion (pour détection comptes inactifs)
  tokenVersion             Int                   @default(0)      // Incrémenté au changement de mot de passe pour invalider les sessions/tokens
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt
  accounts               Account[]
  backgroundTasks        BackgroundTask[]
  consentLogs            ConsentLog[]
  creditBalance          CreditBalance?
  creditTransactions     CreditTransaction[]
  cvs                    CvFile[]
  cvGenerationTasks      CvGenerationTask[]
  featureUsage           FeatureUsage[]
  featureCounters        FeatureUsageCounter[]
  feedbacks              Feedback[]
  jobOffers              JobOffer[]
  linkHistory            LinkHistory[]
  openaiCalls            OpenAICall[]
  openaiUsage            OpenAIUsage[]
  subscription           Subscription?
  telemetryEvents        TelemetryEvent[]
  exportTemplates        ExportTemplate[]
}

model Account {
  id                       String   @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  refresh_token_expires_in Int?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}


model CvFile {
  id                     String             @id @default(cuid())
  userId                 String
  filename               String
  content                Json?              // Contenu CV JSON (migré depuis filesystem)
  contentVersion         Int                @default(1) // Numéro de version courante
  sourceType             String?
  sourceValue            String?
  jobOfferId             String?            // Relation vers JobOffer (extraction structurée)
  jobOfferSnapshot       Json?              // Snapshot de l'offre au moment de la génération (autonomie si offre supprimée)
  createdBy              String?
  originalCreatedBy      String?
  isTranslated           Boolean            @default(false)
  language               String?            // Langue du CV (fr, en, es, de) - détectée à l'import
  matchScore             Int?
  scoreBefore            Int?               // Score avant optimisation IA (conservé pour affichage)
  matchScoreUpdatedAt    DateTime?
  matchScoreStatus       String?            @default("idle")
  scoreBreakdown         String?
  improvementSuggestions String?
  missingSkills          String?
  matchingSkills         String?
  optimiseStatus         String?            @default("idle")
  optimiseUpdatedAt      DateTime?
  createdWithCredit      Boolean            @default(false)
  creditUsedAt           DateTime?
  creditTransactionId    String?            @unique
  blocked                Boolean            @default(false)
  blockedAt              DateTime?
  blockedReason          String?
  // Review state pour modifications IA
  pendingChanges         Json?              // Array des changements avec statut (pending/accepted/rejected)
  pendingSourceVersion   Int?               // Version à comparer pour les diffs
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditTransaction      CreditTransaction? @relation(fields: [creditTransactionId], references: [id])
  jobOffer               JobOffer?          @relation(fields: [jobOfferId], references: [id], onDelete: SetNull)
  versions               CvVersion[]        // Historique des versions (optimisation IA)

  @@unique([userId, filename])
  @@index([jobOfferId])
}

model CvVersion {
  id         String   @id @default(cuid())
  cvFileId   String
  version    Int      // Numéro de version (1, 2, 3...)
  content    Json     // Contenu JSON complet
  changelog  String?  // "Optimisation IA", "Restauration depuis v2"
  changeType String?  // 'optimization' | 'adaptation' | 'restore'
  sourceFile String?  // Pour adaptation: CV source de référence
  createdAt  DateTime @default(now())

  // Score data (copié depuis CvFile au moment de la création de version)
  matchScore             Int?
  scoreBreakdown         String?  @db.Text
  improvementSuggestions String?  @db.Text
  missingSkills          String?  @db.Text
  matchingSkills         String?  @db.Text

  cvFile CvFile @relation(fields: [cvFileId], references: [id], onDelete: Cascade)

  @@unique([cvFileId, version])
  @@index([cvFileId, createdAt(sort: Desc)])
}

model JobOffer {
  id              String   @id @default(cuid())
  userId          String
  sourceType      String   // 'url' | 'pdf'
  sourceValue     String   // URL ou nom fichier PDF
  contentHash     String?  // Hash SHA256 du contenu PDF (null pour URLs)
  content         Json     // Extraction structurée JSON
  extractedAt     DateTime @default(now())
  extractionModel String   // Modèle IA utilisé pour l'extraction
  tokensUsed      Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cvFiles CvFile[] // CVs générés à partir de cette offre

  @@unique([userId, sourceValue])
  @@index([userId])
  @@index([sourceType])
  @@index([userId, contentHash])
}

model BackgroundTask {
  id                        String             @id
  title                     String
  successMessage            String?
  type                      String
  status                    String
  createdAt                 BigInt
  shouldUpdateCvList        Boolean            @default(false)
  result                    String?
  error                     String?
  payload                   String?
  deviceId                  String
  userId                    String?
  cvFile                    String?
  creditUsed                Boolean            @default(false)
  creditTransactionId       String?            @unique
  featureName               String?
  featureCounterPeriodStart DateTime?
  updatedAt                 DateTime           @default(now()) @updatedAt
  creditTransaction         CreditTransaction? @relation(fields: [creditTransactionId], references: [id])
  user                      User?              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([status])
  @@index([createdAt])
  @@index([cvFile, status])
}

model LinkHistory {
  id        String   @id @default(cuid())
  userId    String
  url       String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, url])
  @@index([userId, createdAt])
}

model Feedback {
  id            String   @id @default(cuid())
  userId        String
  rating        Int
  comment       String
  isBugReport   Boolean  @default(false)
  currentCvFile String?
  userAgent     String?
  pageUrl       String?
  createdAt     DateTime @default(now())
  status        String   @default("new")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([isBugReport])
  @@index([status])
}

model ConsentLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  preferences String
  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Setting {
  id          String   @id @default(cuid())
  settingName String   @unique
  value       String
  category    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([settingName])
}


model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expires])
}

model AutoSignInToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expires])
}

model EmailChangeRequest {
  id        String   @id @default(cuid())
  userId    String
  newEmail  String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expires])
}

model TelemetryEvent {
  id        String   @id @default(cuid())
  userId    String?
  type      String
  category  String
  metadata  String?
  deviceId  String?
  duration  Int?
  status    String?
  error     String?
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([category])
  @@index([deviceId])
  @@index([timestamp])
  @@index([userId, type])
  @@index([type, timestamp])
}

model FeatureUsage {
  id            String   @id @default(cuid())
  userId        String
  featureName   String
  usageCount    Int      @default(0)
  lastUsedAt    DateTime @default(now())
  totalDuration Int      @default(0)
  metadata      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureName])
  @@index([userId])
  @@index([featureName])
  @@index([lastUsedAt])
}

model OpenAIUsage {
  id               String   @id @default(cuid())
  userId           String
  featureName      String
  model            String
  date             DateTime
  promptTokens     Int      @default(0)
  cachedTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalTokens      Int      @default(0)
  estimatedCost    Float    @default(0)
  callsCount       Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureName, model, date])
  @@index([userId])
  @@index([featureName])
  @@index([model])
  @@index([date])
  @@index([userId, date])
  @@index([featureName, date])
}

model OpenAIPricing {
  id                          String   @id @default(cuid())
  modelName                   String   @unique
  // Standard tier pricing (per million tokens)
  inputPricePerMToken         Float
  outputPricePerMToken        Float
  cachePricePerMToken         Float    @default(0)
  // Priority tier pricing (per million tokens) - ~70% more expensive
  inputPricePerMTokenPriority  Float?
  outputPricePerMTokenPriority Float?
  cachePricePerMTokenPriority  Float?
  description                 String?
  isActive                    Boolean  @default(true)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  @@index([modelName])
  @@index([isActive])
}

model OpenAIAlert {
  id          String   @id @default(cuid())
  type        String
  threshold   Float
  enabled     Boolean  @default(true)
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([enabled])
}

model OpenAICall {
  id               String   @id @default(cuid())
  userId           String
  featureName      String
  model            String
  promptTokens     Int      @default(0)
  cachedTokens     Int      @default(0)
  completionTokens Int      @default(0)
  totalTokens      Int      @default(0)
  estimatedCost    Float    @default(0)
  duration         Int?
  metadata         String?
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([featureName])
  @@index([featureName, createdAt])
  @@index([userId, featureName])
  @@index([createdAt])
}

model SubscriptionPlan {
  id                    Int                            @id @default(autoincrement())
  name                  String                         @unique
  description           String?
  isFree                Boolean                        @default(false)
  tier                  Int                            @default(0)
  isPopular             Boolean                        @default(false)
  priceMonthly          Float                          @default(0)
  priceYearly           Float                          @default(0)
  yearlyDiscountPercent Float                          @default(0)
  priceCurrency         String                         @default("EUR")
  stripeProductId       String?                        @unique
  stripePriceIdMonthly  String?                        @unique
  stripePriceIdYearly   String?                        @unique
  createdAt             DateTime                       @default(now())
  updatedAt             DateTime                       @updatedAt
  subscriptions         Subscription[]
  featureLimits         SubscriptionPlanFeatureLimit[]

  @@index([name])
  @@index([tier])
}

model SubscriptionPlanFeatureLimit {
  id                    String           @id @default(cuid())
  planId                Int
  featureName           String
  isEnabled             Boolean          @default(true)
  usageLimit            Int              @default(-1)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, featureName])
  @@index([planId])
  @@index([featureName])
}

model CreditPack {
  id              Int      @id @default(autoincrement())
  name            String
  description     String?
  creditAmount    Int      @unique
  price           Float
  priceCurrency   String   @default("EUR")
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  stripePriceId   String?  @unique
  stripeProductId String?  @unique

  @@index([creditAmount])
  @@index([isActive])
}

model Subscription {
  id                   String           @id @default(cuid())
  userId               String           @unique
  stripeCustomerId     String           @unique
  stripeSubscriptionId String?          @unique
  stripePriceId        String?
  planId               Int
  status               String
  billingPeriod        String
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean          @default(false)
  canceledAt           DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  plan                 SubscriptionPlan @relation(fields: [planId], references: [id])
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model CreditBalance {
  id                       String   @id @default(cuid())
  userId                   String   @unique
  balance                  Int      @default(0)
  totalPurchased           Int      @default(0)
  totalUsed                Int      @default(0)
  totalRefunded            Int      @default(0)
  totalGifted              Int      @default(0)
  balanceAfterLastPurchase Int      @default(0)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CreditTransaction {
  id                    String          @id @default(cuid())
  userId                String
  amount                Int
  type                  String
  featureName           String?
  taskId                String?
  cvFileId              String?
  stripePaymentIntentId String?         @unique
  refunded              Boolean         @default(false)
  relatedTransactionId  String?
  metadata              String?
  createdAt             DateTime        @default(now())
  stripeInvoiceId       String?
  task                  BackgroundTask?
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  cvFile                CvFile?

  @@index([userId])
  @@index([type])
  @@index([featureName])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model FeatureUsageCounter {
  id          String   @id @default(cuid())
  userId      String
  featureName String
  count       Int      @default(0)
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, featureName]) // 1 compteur par feature par user (reset auto au changement de période)
  @@index([userId])
  @@index([featureName])
}

model StripeWebhookLog {
  id        String   @id @default(cuid())
  eventId   String   @unique
  eventType String
  payload   String
  processed Boolean  @default(false)
  error     String?
  createdAt DateTime @default(now())

  @@index([eventId])
  @@index([eventType])
  @@index([processed])
  @@index([createdAt])
}



model EmailTrigger {
  id          String          @id @default(cuid())
  name        String          @unique  // email_verification, password_reset, etc.
  label       String                   // Nom affichable
  description String?
  variables   String                   // JSON array des variables disponibles
  category    String          @default("general")
  icon        String?
  isSystem    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  templates   EmailTemplate[]

  @@index([name])
  @@index([category])
}

model EmailTemplate {
  id          String        @id @default(cuid())
  name        String        // Nom du template (pas unique - plusieurs par trigger)
  triggerId   String?
  trigger     EmailTrigger? @relation(fields: [triggerId], references: [id], onDelete: SetNull)
  subject     String
  designJson  String        // JSON Maily/TipTap
  htmlContent String
  variables   String
  isActive    Boolean       @default(false)
  isDefault   Boolean       @default(false)  // Template par defaut global pour nouveaux templates
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  emailLogs   EmailLog[]

  @@index([triggerId])
  @@index([isActive])
  @@index([isDefault])
  @@index([name])
}

model EmailLog {
  id              String         @id @default(cuid())
  templateId      String?
  templateName    String
  recipientEmail  String
  recipientUserId String?
  subject         String
  status          String
  error           String?
  provider        String         @default("resend") // "smtp" ou "resend"
  providerId      String?        // ID du message (SMTP messageId ou Resend ID)
  isTestEmail     Boolean        @default(false)
  createdAt       DateTime       @default(now())
  template        EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([templateId])
  @@index([templateName])
  @@index([recipientEmail])
  @@index([recipientUserId])
  @@index([status])
  @@index([createdAt])
  @@index([provider])
}

// ============================================
// CV Generation Pipeline v2
// ============================================

model CvGenerationTask {
  id              String              @id @default(cuid())
  userId          String
  sourceCvFileId  String              // CV source utilisé pour la génération
  mode            String              @default("adapt") // 'adapt' | 'optimize'
  status          String              @default("pending") // pending | running | completed | failed
  totalOffers     Int                 @default(1)
  completedOffers Int                 @default(0)
  creditsDebited  Int                 @default(0)
  creditsRefunded Int                 @default(0)
  error           String?
  createdAt       DateTime            @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  updatedAt       DateTime            @updatedAt

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  offers          CvGenerationOffer[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([userId, status])
}

model CvGenerationOffer {
  id                  String                @id @default(cuid())
  taskId              String
  sourceUrl           String?               // URL source de l'offre (pour extraction async)
  jobOfferId          String?               // Offre d'emploi cible (null avant extraction)
  offerIndex          Int                   @default(0) // Position dans le batch (0, 1, 2...)
  status              String                @default("pending") // pending | extracting | running | completed | failed
  classificationResult Json?                // Résultat de la phase classification
  batchResults        Json?                 // Résultats des batches (experiences, projects, skills, etc.)
  generatedCvFileId   String?               // CV généré (null si échec)
  generatedCvFileName String?               // Nom du fichier CV généré
  retryCount          Int                   @default(0)
  error               String?
  creditsRefunded     Boolean               @default(false)
  createdAt           DateTime              @default(now())
  startedAt           DateTime?
  completedAt         DateTime?
  updatedAt           DateTime              @updatedAt

  task                CvGenerationTask      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  subtasks            CvGenerationSubtask[]

  @@index([taskId])
  @@index([status])
  @@index([taskId, offerIndex])
}

model CvGenerationSubtask {
  id               String            @id @default(cuid())
  offerId          String
  type             String            // classify | batch_experience | batch_project | batch_extras | batch_skills | batch_summary | recompose
  itemIndex        Int?              // Pour les batches: index de l'item (exp 0, exp 1, proj 0...)
  status           String            @default("pending") // pending | running | completed | failed
  input            Json?             // Données d'entrée pour debug
  output           Json?             // Résultat du traitement
  modifications    Json?             // Array des modifications {field, before, after, reason, action}
  modelUsed        String?           // Modèle IA effectivement utilisé
  promptTokens     Int               @default(0)
  cachedTokens     Int               @default(0)  // Tokens en cache (prompt caching)
  completionTokens Int               @default(0)
  estimatedCost    Float             @default(0)  // Coût estimé en USD
  durationMs       Int?              // Durée d'exécution en ms
  retryCount       Int               @default(0)
  error            String?
  createdAt        DateTime          @default(now())
  startedAt        DateTime?
  completedAt      DateTime?
  updatedAt        DateTime          @updatedAt

  offer            CvGenerationOffer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId])
  @@index([type])
  @@index([status])
  @@index([offerId, type])
}

// ============================================
// Export Templates (PDF export configurations)
// ============================================

model ExportTemplate {
  id          String   @id @default(cuid())
  userId      String
  name        String
  selections  Json     // Configuration macro des sections (enabled, options, subsections)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
}

// ============================================
// Data Migrations Tracking
// ============================================

model DataMigration {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  appliedAt DateTime @default(now()) @map("applied_at")

  @@map("_data_migrations")
}
