<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Pipeline V2 â€” Architecture ComplÃ¨te</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        h1 {
            color: #fff;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        .subtitle {
            color: #8892b0;
            text-align: center;
            margin-bottom: 30px;
            font-size: 0.95rem;
        }
        .diagram-container {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow-x: auto;
            margin-bottom: 30px;
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        .section-title {
            color: #64ffda;
            font-size: 1.2rem;
            margin: 30px 0 15px 0;
            padding-left: 10px;
            border-left: 3px solid #64ffda;
        }
        .section-title.phase05 { border-color: #9c27b0; color: #9c27b0; }
        .section-title.phase1 { border-color: #ff9800; color: #ff9800; }
        .section-title.phase2 { border-color: #4caf50; color: #4caf50; }
        .section-title.credits { border-color: #e91e63; color: #e91e63; }
        .section-title.cache { border-color: #00bcd4; color: #00bcd4; }
        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .legend-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .legend-icon {
            font-size: 1.5rem;
        }
        .legend-text {
            font-size: 0.9rem;
        }
        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        .stat {
            text-align: center;
            color: #fff;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #64ffda;
        }
        .stat-label {
            font-size: 0.85rem;
            color: #8892b0;
            margin-top: 5px;
        }
        .note {
            background: rgba(100, 255, 218, 0.1);
            border-left: 4px solid #64ffda;
            padding: 15px 20px;
            border-radius: 0 10px 10px 0;
            color: #ccd6f6;
            margin-bottom: 20px;
        }
        .note-title {
            color: #64ffda;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .warning {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
        }
        .warning .note-title {
            color: #ffc107;
        }
        .success {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4caf50;
        }
        .success .note-title {
            color: #4caf50;
        }
        .info {
            background: rgba(33, 150, 243, 0.1);
            border-left: 4px solid #2196f3;
        }
        .info .note-title {
            color: #2196f3;
        }
        .purple {
            background: rgba(156, 39, 176, 0.1);
            border-left: 4px solid #9c27b0;
        }
        .purple .note-title {
            color: #9c27b0;
        }
        .cyan {
            background: rgba(0, 188, 212, 0.1);
            border-left: 4px solid #00bcd4;
        }
        .cyan .note-title {
            color: #00bcd4;
        }
        .credits-note {
            background: rgba(233, 30, 99, 0.1);
            border-left: 4px solid #e91e63;
        }
        .credits-note .note-title {
            color: #e91e63;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            color: #ccd6f6;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th {
            background: rgba(100, 255, 218, 0.1);
            color: #64ffda;
        }
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
        }
        .timeline {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            color: #8892b0;
            overflow-x: auto;
            white-space: pre;
        }
        .timeline .complete { color: #4caf50; }
        .timeline .processing { color: #ffc107; }
        .timeline .header { color: #64ffda; font-weight: bold; }
        .timeline .phase05 { color: #9c27b0; }
        .timeline .phase1 { color: #ff9800; }
        .timeline .phase2 { color: #4caf50; }
        .timeline .error { color: #f44336; }
        .timeline .refund { color: #e91e63; }
        .timeline .cache { color: #00bcd4; }
    </style>
</head>
<body>
    <div class="container">
        <h1>CV Pipeline V2 â€” Architecture ComplÃ¨te</h1>
        <p class="subtitle">Classification â†’ Batches ParallÃ¨les â†’ Recompose â€” avec gestion des crÃ©dits et cache OpenAI</p>

        <!-- ========== STATISTIQUES ========== -->
        <div class="stats">
            <div class="stat">
                <div class="stat-value">3</div>
                <div class="stat-label">Phases principales</div>
            </div>
            <div class="stat">
                <div class="stat-value">6</div>
                <div class="stat-label">Appels IA par offre</div>
            </div>
            <div class="stat">
                <div class="stat-value">2</div>
                <div class="stat-label">Niveaux de cache</div>
            </div>
            <div class="stat">
                <div class="stat-value">3</div>
                <div class="stat-label">Retries max</div>
            </div>
        </div>

        <!-- ========== VUE D'ENSEMBLE ========== -->
        <h2 class="section-title">Vue d'ensemble â€” 3 Phases + Gestion CrÃ©dits</h2>

        <div class="diagram-container">
            <div class="mermaid">
flowchart TB
    subgraph INPUT["ğŸ“¥ ENTRÃ‰E"]
        TASK["CvGenerationTask crÃ©Ã©e<br/><small>sourceCvFileId + N offres</small>"]
        OFFERS[("JobOffer[]<br/><small>N offres Ã  traiter</small>")]
    end

    subgraph CREDITS_INIT["ğŸ’³ DÃ‰DUCTION CRÃ‰DITS"]
        CHECK_BALANCE{"Solde suffisant ?<br/>(N Ã— COST_PER_OFFER)"}
        DEDUCT["DÃ©duire N Ã— COST_PER_OFFER<br/>du compte utilisateur"]
        REJECT["âŒ Rejeter la demande<br/>Solde insuffisant"]

        TASK --> CHECK_BALANCE
        CHECK_BALANCE -->|"Oui"| DEDUCT
        CHECK_BALANCE -->|"Non"| REJECT
    end

    subgraph LOOP["ğŸ”„ BOUCLE PAR OFFRE (SÃ©quentiel)"]
        direction TB
        NEXT_OFFER["Offre suivante"]

        subgraph PHASE05["ğŸ·ï¸ PHASE 0.5 â€” CLASSIFICATION"]
            CLASSIFY["ğŸ¤– Classifier experiences + projects<br/><small>KEEP | REMOVE | MOVE_TO_PROJECTS</small>"]
        end

        subgraph PHASE1["âš¡ PHASE 1 â€” BATCHES PARALLÃˆLES"]
            direction TB

            subgraph WAVE1["Wave 1 (3 parallÃ¨les)"]
                B_EXP["ğŸ¤– Batch Experiences<br/><small>N appels parallÃ¨les</small>"]
                B_PROJ["ğŸ¤– Batch Projects<br/><small>M appels parallÃ¨les</small>"]
                B_EXTRA["ğŸ¤– Batch Extras<br/><small>1 appel</small>"]
            end

            subgraph WAVE2["Wave 2 (2 parallÃ¨les) â€” attend Wave 1"]
                B_SKILLS["ğŸ¤– Batch Skills<br/><small>utilise rÃ©sultats Wave 1</small>"]
                B_SUMMARY["ğŸ¤– Batch Summary<br/><small>utilise rÃ©sultats Wave 1</small>"]
            end

            WAVE1 --> WAVE2
        end

        subgraph PHASE2["ğŸ”„ PHASE 2 â€” RECOMPOSE"]
            LANG["ğŸ¤– Adapter Languages<br/><small>(si mentionnÃ©es dans offre)</small>"]
            ASSEMBLE["ğŸ“„ Assembler CV final"]
            DIFF["âš–ï¸ Calculer Diff"]
            SAVE["ğŸ’¾ CrÃ©er CvFile + CvVersion"]
        end

        NEXT_OFFER --> PHASE05 --> PHASE1
        PHASE1 --> LANG --> ASSEMBLE --> DIFF --> SAVE

        ERROR{{"Ã‰chec ?"}}
        RETRY["ğŸ”„ Retry<br/><small>1s â†’ 2s â†’ 4s</small>"]
        REFUND["ğŸ’³ Rembourser<br/>COST_PER_OFFER"]

        SAVE --> ERROR
        ERROR -->|"Non"| NEXT_OFFER
        ERROR -->|"Oui (< 3 retries)"| RETRY --> PHASE05
        ERROR -->|"Oui (3 retries)"| REFUND
    end

    DEDUCT --> LOOP

    subgraph OUTPUT["ğŸ“¤ SORTIES"]
        EMIT["ğŸ“¡ SSE Events<br/><small>offer_complete / offer_failed</small>"]
        UI["ğŸ–¥ï¸ Interface Utilisateur"]

        SAVE -->|"SuccÃ¨s"| EMIT --> UI
        REFUND -->|"Ã‰chec final"| EMIT
    end

    style INPUT fill:#e3f2fd,stroke:#1976d2
    style CREDITS_INIT fill:#fce4ec,stroke:#e91e63
    style LOOP fill:#f5f5f5,stroke:#9e9e9e
    style PHASE05 fill:#f3e5f5,stroke:#9c27b0
    style PHASE1 fill:#fff8e1,stroke:#ff9800
    style WAVE1 fill:#fff3e0,stroke:#f57c00
    style WAVE2 fill:#ffe0b2,stroke:#e65100
    style PHASE2 fill:#e8f5e9,stroke:#4caf50
    style OUTPUT fill:#e1f5fe,stroke:#0288d1
    style REFUND fill:#ffcdd2,stroke:#f44336
    style REJECT fill:#ffcdd2,stroke:#f44336
            </div>
        </div>

        <!-- ========== PHASE 0.5 CLASSIFICATION ========== -->
        <h2 class="section-title phase05">Phase 0.5 â€” Classification (DÃ©tail)</h2>

        <div class="diagram-container">
            <div class="mermaid">
flowchart TB
    subgraph INPUT["EntrÃ©es"]
        CV_EXP["CV: experiences[]<br/><small>Toutes les expÃ©riences</small>"]
        CV_PROJ["CV: projects[]<br/><small>Tous les projets</small>"]
        OFFER["JobOffer JSON<br/><small>Titre, compÃ©tences, etc.</small>"]
    end

    subgraph CLASSIFY["ğŸ¤– Classification IA"]
        direction TB
        CALL["Appel OpenAI<br/><small>model_cv_classify</small><br/><small>temp: 0.1 | max_tokens: 2000</small>"]

        subgraph RULES["RÃ¨gles de classification"]
            TEMPORAL["â±ï¸ FenÃªtre temporelle<br/><small>Junior: 3 ans<br/>ConfirmÃ©: 5 ans<br/>Senior: 7 ans<br/>Expert: 10 ans</small>"]
            DOMAIN["ğŸ¯ Alignement domaine<br/><small>Pertinence mÃ©tier</small>"]
            LEADERSHIP["ğŸ‘¥ Soft skills<br/><small>Leadership, gestion</small>"]
        end
    end

    INPUT --> CALL

    subgraph OUTPUT["Actions par Ã©lÃ©ment"]
        direction TB

        subgraph EXP_ACTIONS["Experiences"]
            KEEP_E["âœ… KEEP<br/><small>Garder et adapter</small>"]
            REMOVE_E["âŒ REMOVE<br/><small>Supprimer</small>"]
            MOVE["ğŸ”€ MOVE_TO_PROJECTS<br/><small>Side-project, freelance,<br/>expÃ©rience atypique</small>"]
        end

        subgraph PROJ_ACTIONS["Projects"]
            KEEP_P["âœ… KEEP<br/><small>Garder et adapter</small>"]
            REMOVE_P["âŒ REMOVE<br/><small>Supprimer</small>"]
        end
    end

    CALL --> OUTPUT

    subgraph DB["ğŸ’¾ Base de donnÃ©es"]
        SUBTASK["CvGenerationSubtask<br/><small>type: 'classify'</small><br/><small>output: {experiences[], projects[]}</small>"]
    end

    OUTPUT --> SUBTASK

    style INPUT fill:#e3f2fd,stroke:#1976d2
    style CLASSIFY fill:#f3e5f5,stroke:#9c27b0
    style RULES fill:#ede7f6,stroke:#7b1fa2
    style OUTPUT fill:#fff3e0,stroke:#f57c00
    style EXP_ACTIONS fill:#fff8e1,stroke:#ff9800
    style PROJ_ACTIONS fill:#fff8e1,stroke:#ff9800
    style DB fill:#e8f5e9,stroke:#4caf50
    style MOVE fill:#e1f5fe,stroke:#0288d1
            </div>
        </div>

        <div class="note purple">
            <div class="note-title">ğŸ·ï¸ MOVE_TO_PROJECTS â€” Cas d'usage</div>
            <p>Les expÃ©riences sont converties en projets lorsqu'elles sont :</p>
            <ul style="margin-left: 20px; margin-top: 8px;">
                <li><strong>Side-projects</strong> : Projets personnels rÃ©alisÃ©s en parallÃ¨le d'un emploi</li>
                <li><strong>Freelance</strong> : Missions courtes ou consulting</li>
                <li><strong>ExpÃ©riences atypiques</strong> : Stages, bÃ©nÃ©volat, projets acadÃ©miques</li>
            </ul>
            <p style="margin-top: 8px;">Le flag <code>_fromExperience: true</code> est ajoutÃ© pour traÃ§abilitÃ©.</p>
        </div>

        <!-- ========== PHASE 1 BATCHES ========== -->
        <h2 class="section-title phase1">Phase 1 â€” Batches ParallÃ¨les (DÃ©tail)</h2>

        <div class="diagram-container">
            <div class="mermaid">
flowchart TB
    subgraph INPUT_P1["EntrÃ©es Phase 1"]
        CLASSIFIED["RÃ©sultats Classification<br/><small>experiences KEEP/MOVE<br/>projects KEEP</small>"]
        OFFER["JobOffer JSON"]
        CV_ORIG["CV Original<br/><small>skills, extras</small>"]
    end

    subgraph CACHE_A["ğŸ”µ Cache A â€” Offre d'emploi"]
        CACHE_CONTENT_A["# OFFRE D'EMPLOI CIBLE<br/><small>jobTitle, skills, nice-to-have,<br/>soft_skills, methodologies</small><br/><small>+ JSON complet</small>"]
    end

    INPUT_P1 --> CACHE_A

    subgraph WAVE1["âš¡ Wave 1 â€” 3 Batches ParallÃ¨les"]
        direction LR

        subgraph B_EXP["Batch Experiences"]
            EXP_LOOP["Pour chaque exp KEEP:<br/>ğŸ¤– Appel IA parallÃ¨le"]
            EXP_OUT["â†’ title adaptÃ©<br/>â†’ responsibilities<br/>â†’ deliverables filtrÃ©s<br/>â†’ skills_used<br/>â†’ modifications[]"]
        end

        subgraph B_PROJ["Batch Projects"]
            PROJ_CONV["Convertir MOVE_TO_PROJECTS<br/>en format projet"]
            PROJ_LOOP["Pour chaque projet:<br/>ğŸ¤– Appel IA parallÃ¨le"]
            PROJ_OUT["â†’ summary adaptÃ©<br/>â†’ tech_stack rÃ©ordonnÃ©<br/>â†’ modifications[]"]
            PROJ_CONV --> PROJ_LOOP --> PROJ_OUT
        end

        subgraph B_EXTRA["Batch Extras"]
            EXTRA_CALL["ğŸ¤– 1 appel IA"]
            EXTRA_OUT["â†’ volunteer adaptÃ©<br/>â†’ hobbies filtrÃ©s<br/>â†’ availability<br/>â†’ modifications[]"]
        end

        EXP_LOOP --> EXP_OUT
        EXTRA_CALL --> EXTRA_OUT
    end

    CACHE_A --> WAVE1

    subgraph CACHE_B["ğŸŸ¢ Cache B â€” Offre + RÃ©sultats Wave 1"]
        CACHE_CONTENT_B["Cache A +<br/># EXPERIENCES ADAPTEES<br/><small>JSON experiences[]</small><br/># PROJETS ADAPTES<br/><small>JSON projects[]</small>"]
    end

    WAVE1 --> CACHE_B

    subgraph WAVE2["âš¡ Wave 2 â€” 2 Batches ParallÃ¨les (attend Wave 1)"]
        direction LR

        subgraph B_SKILLS["Batch Skills"]
            SKILLS_IN["Input:<br/><small>skills originaux<br/>+ experiences adaptÃ©es<br/>+ projects adaptÃ©s</small>"]
            SKILLS_RULES["RÃ¨gles STRICTES:<br/><small>hard_skills: add/remove OK<br/>soft_skills: add/remove OK<br/>âš ï¸ tools: JAMAIS ajouter<br/>methodologies: add/remove OK</small>"]
            SKILLS_OUT["â†’ skills adaptÃ©s<br/>â†’ modifications[]"]
            SKILLS_IN --> SKILLS_RULES --> SKILLS_OUT
        end

        subgraph B_SUMMARY["Batch Summary"]
            SUMMARY_IN["Input:<br/><small>summary original<br/>+ experiences adaptÃ©es<br/>+ projects adaptÃ©s<br/>+ extras adaptÃ©s</small>"]
            SUMMARY_RULES["RÃ¨gles:<br/><small>headline = jobTitle FORCÃ‰<br/>description: authentique<br/>years_experience: calculÃ©<br/>domains: max 5<br/>key_strengths: max 5</small>"]
            SUMMARY_OUT["â†’ summary adaptÃ©<br/>â†’ modifications[]"]
            SUMMARY_IN --> SUMMARY_RULES --> SUMMARY_OUT
        end
    end

    CACHE_B --> WAVE2

    subgraph OUTPUT_P1["Sorties Phase 1"]
        ALL_RESULTS["Tous les rÃ©sultats batch<br/>+ toutes les modifications<br/>tracÃ©es avec raisons"]
    end

    WAVE2 --> OUTPUT_P1

    style INPUT_P1 fill:#e3f2fd,stroke:#1976d2
    style CACHE_A fill:#e1f5fe,stroke:#0288d1
    style CACHE_B fill:#b2dfdb,stroke:#00897b
    style WAVE1 fill:#fff8e1,stroke:#ff9800
    style WAVE2 fill:#ffe0b2,stroke:#e65100
    style B_EXP fill:#fff3e0,stroke:#f57c00
    style B_PROJ fill:#fff3e0,stroke:#f57c00
    style B_EXTRA fill:#fff3e0,stroke:#f57c00
    style B_SKILLS fill:#ffcc80,stroke:#ef6c00
    style B_SUMMARY fill:#ffcc80,stroke:#ef6c00
    style OUTPUT_P1 fill:#e8f5e9,stroke:#4caf50
            </div>
        </div>

        <div class="note warning">
            <div class="note-title">âš ï¸ RÃ¨gle stricte : Tools</div>
            <p>Les <code>tools</code> ne peuvent <strong>JAMAIS</strong> Ãªtre ajoutÃ©s par l'IA. Seuls les outils prÃ©sents dans le CV original peuvent Ãªtre conservÃ©s ou supprimÃ©s. Une validation post-traitement filtre automatiquement tout outil ajoutÃ©.</p>
        </div>

        <div class="note cyan">
            <div class="note-title">ğŸ”µ Cache OpenAI â€” Optimisation des coÃ»ts</div>
            <p><strong>Cache A</strong> : PrÃ©fixe avec l'offre d'emploi uniquement. RÃ©utilisÃ© pour TOUS les appels de Wave 1 (experiences, projects, extras).</p>
            <p><strong>Cache B</strong> : Cache A + rÃ©sultats adaptÃ©s. UtilisÃ© par Wave 2 (skills, summary) qui ont besoin du contexte des sections dÃ©jÃ  adaptÃ©es.</p>
            <p style="margin-top: 8px;"><em>Le traitement sÃ©quentiel par offre (plutÃ´t que parallÃ¨le entre offres) maximise les hits de cache.</em></p>
        </div>

        <!-- ========== PHASE 2 RECOMPOSE ========== -->
        <h2 class="section-title phase2">Phase 2 â€” Recompose (DÃ©tail)</h2>

        <div class="diagram-container">
            <div class="mermaid">
flowchart TB
    subgraph INPUT_P2["EntrÃ©es Phase 2"]
        BATCH_EXP["Batch Experiences rÃ©sultats"]
        BATCH_PROJ["Batch Projects rÃ©sultats"]
        BATCH_SKILLS["Batch Skills rÃ©sultats"]
        BATCH_SUMMARY["Batch Summary rÃ©sultats"]
        BATCH_EXTRAS["Batch Extras rÃ©sultats"]
        CV_ORIG["CV Original<br/><small>header, education, languages</small>"]
        OFFER["JobOffer<br/><small>jobTitle, languages mentionnÃ©es</small>"]
    end

    subgraph LANG_CHECK["ğŸŒ Adaptation Languages"]
        DETECT{"Langues mentionnÃ©es<br/>dans l'offre ?"}
        MATCH{"Langue trouvÃ©e<br/>dans CV ?"}
        ADAPT_LANG["ğŸ¤– Adapter Languages<br/><small>Optimiser proficiency</small>"]
        KEEP_LANG["Garder languages<br/>originales"]

        DETECT -->|"Oui"| MATCH
        DETECT -->|"Non"| KEEP_LANG
        MATCH -->|"Oui"| ADAPT_LANG
        MATCH -->|"Non"| KEEP_LANG
    end

    INPUT_P2 --> LANG_CHECK

    subgraph ASSEMBLE["ğŸ“„ Assemblage CV Final"]
        direction TB
        BUILD["Construire CV complet"]

        HEADER["header.current_title = jobTitle"]
        SUMMARY["summary = batch_summary"]
        EXP["experience = batch_experiences"]
        PROJ["projects = batch_projects<br/><small>+ experiences converties</small>"]
        SKILLS["skills = batch_skills"]
        EXTRAS["extras = batch_extras"]
        EDU["education = original<br/><small>(inchangÃ©)</small>"]
        LANGS["languages = adaptÃ© ou original"]

        BUILD --> HEADER
        BUILD --> SUMMARY
        BUILD --> EXP
        BUILD --> PROJ
        BUILD --> SKILLS
        BUILD --> EXTRAS
        BUILD --> EDU
        BUILD --> LANGS
    end

    LANG_CHECK --> ASSEMBLE

    subgraph DIFF["âš–ï¸ Calcul Diff"]
        COMPUTE["computeCvDiff()<br/><small>CV original vs CV gÃ©nÃ©rÃ©</small>"]
        REVIEW["initializeReviewState()<br/><small>Ã‰tat initial pour review UI</small>"]
        COMPUTE --> REVIEW
    end

    ASSEMBLE --> DIFF

    subgraph SAVE["ğŸ’¾ Sauvegarde"]
        CVFILE["CrÃ©er CvFile<br/><small>sourceType: 'link'<br/>createdBy: 'generate-cv'<br/>jobOfferId: FK</small>"]
        VERSION["CrÃ©er CvVersion v0<br/><small>RÃ©fÃ©rence pour rollback</small>"]
        UPDATE_OFFER["Mettre Ã  jour JobOffer<br/><small>generatedCvFileId<br/>batchResults JSON</small>"]

        CVFILE --> VERSION --> UPDATE_OFFER
    end

    DIFF --> SAVE

    subgraph OUTPUT_P2["ğŸ“¤ Sortie"]
        EMIT["ğŸ“¡ Emit: offer_complete<br/><small>+ progression SSE</small>"]
    end

    SAVE --> OUTPUT_P2

    style INPUT_P2 fill:#e3f2fd,stroke:#1976d2
    style LANG_CHECK fill:#e1f5fe,stroke:#0288d1
    style ASSEMBLE fill:#e8f5e9,stroke:#4caf50
    style DIFF fill:#fff3e0,stroke:#f57c00
    style SAVE fill:#f3e5f5,stroke:#9c27b0
    style OUTPUT_P2 fill:#e1f5fe,stroke:#0288d1
    style EDU fill:#e0e0e0,stroke:#757575
            </div>
        </div>

        <div class="note success">
            <div class="note-title">ğŸ“„ Assemblage â€” Points clÃ©s</div>
            <ul style="margin-left: 20px;">
                <li><code>header.current_title</code> est <strong>TOUJOURS</strong> remplacÃ© par le <code>jobTitle</code> de l'offre</li>
                <li><code>education</code> reste <strong>inchangÃ©</strong> (pas d'adaptation IA)</li>
                <li>Les expÃ©riences converties en projets (<code>MOVE_TO_PROJECTS</code>) sont fusionnÃ©es dans <code>projects[]</code></li>
                <li>Toutes les modifications sont tracÃ©es avec <code>before/after/reason</code></li>
            </ul>
        </div>

        <!-- ========== SYSTÃˆME DE CRÃ‰DITS ========== -->
        <h2 class="section-title credits">SystÃ¨me de CrÃ©dits â€” Flux dÃ©taillÃ©</h2>

        <div class="diagram-container">
            <div class="mermaid">
flowchart TB
    subgraph START["DÃ©but de tÃ¢che"]
        USER_REQ["Utilisateur demande<br/>1 CV Ã— N offres"]
        CALC["Calcul: N Ã— COST_PER_OFFER"]
        USER_REQ --> CALC
    end

    subgraph CHECK["VÃ©rification solde"]
        GET_BALANCE["RÃ©cupÃ©rer solde utilisateur"]
        COMPARE{"solde >= N Ã— COST_PER_OFFER ?"}

        CALC --> GET_BALANCE --> COMPARE
    end

    subgraph INSUFFICIENT["Solde insuffisant"]
        REJECT["âŒ Rejeter la demande"]
        NOTIFY_REJECT["ğŸ“¡ Notifier: 'CrÃ©dits insuffisants'"]

        COMPARE -->|"Non"| REJECT --> NOTIFY_REJECT
    end

    subgraph DEDUCTION["DÃ©duction initiale"]
        DEDUCT["ğŸ’³ DÃ©duire N Ã— COST_PER_OFFER"]
        LOG_DEDUCT["ğŸ“ Log transaction:<br/>type: DEDUCTION<br/>amount: -N Ã— COST_PER_OFFER"]
        CREATE_TASK["CrÃ©er CvGenerationTask<br/>+ N CvGenerationOffer"]

        COMPARE -->|"Oui"| DEDUCT --> LOG_DEDUCT --> CREATE_TASK
    end

    subgraph PROCESSING["Traitement..."]
        WORK["Phase 0.5 â†’ 1 â†’ 2<br/><small>avec retry (1s, 2s, 4s)</small>"]
        CREATE_TASK --> WORK
    end

    subgraph SUCCESS["SuccÃ¨s (par offre)"]
        OK["âœ… CV gÃ©nÃ©rÃ©"]
        NO_REFUND["Pas de remboursement"]

        WORK -->|"Offre OK"| OK --> NO_REFUND
    end

    subgraph FAILURE["Ã‰chec (par offre, aprÃ¨s 3 retries)"]
        FAIL["âŒ Erreur dÃ©tectÃ©e"]
        REFUND["ğŸ’³ Rembourser COST_PER_OFFER<br/><small>grantCredits(userId, amount, 'refund')</small>"]
        LOG_REFUND["ğŸ“ Log transaction:<br/>type: REFUND<br/>amount: +COST_PER_OFFER"]
        UPDATE_SUB["CvGenerationOffer â†’ status: failed"]
        NOTIFY_FAIL["ğŸ“¡ Emit: offer_failed<br/><small>'Offre Ã©chouÃ©e, crÃ©dit remboursÃ©'</small>"]

        WORK -->|"Offre KO (3 retries)"| FAIL --> REFUND --> LOG_REFUND --> UPDATE_SUB --> NOTIFY_FAIL
    end

    subgraph FINAL["Ã‰tat final"]
        RESULT["CoÃ»t final =<br/>(N - Ã©checs) Ã— COST_PER_OFFER"]
    end

    NO_REFUND --> RESULT
    NOTIFY_FAIL --> RESULT

    style START fill:#e3f2fd,stroke:#1976d2
    style CHECK fill:#fff3e0,stroke:#f57c00
    style INSUFFICIENT fill:#ffcdd2,stroke:#f44336
    style DEDUCTION fill:#fce4ec,stroke:#e91e63
    style PROCESSING fill:#f3e5f5,stroke:#7b1fa2
    style SUCCESS fill:#e8f5e9,stroke:#4caf50
    style FAILURE fill:#ffcdd2,stroke:#f44336
    style FINAL fill:#e1f5fe,stroke:#0288d1
            </div>
        </div>

        <div class="note credits-note">
            <div class="note-title">ğŸ’³ Points de remboursement â€” Retry inclus</div>
            <table>
                <tr>
                    <th>Phase</th>
                    <th>Point d'Ã©chec</th>
                    <th>Retries</th>
                    <th>Action aprÃ¨s 3 Ã©checs</th>
                </tr>
                <tr>
                    <td>Phase 0.5</td>
                    <td>Classification IA Ã©choue</td>
                    <td>3 (1s, 2s, 4s)</td>
                    <td>Rembourser COST_PER_OFFER</td>
                </tr>
                <tr>
                    <td>Phase 1</td>
                    <td>Batch Experience/Project/Extras/Skills/Summary Ã©choue</td>
                    <td>3 (1s, 2s, 4s)</td>
                    <td>Rembourser COST_PER_OFFER</td>
                </tr>
                <tr>
                    <td>Phase 2</td>
                    <td>Adaptation Languages Ã©choue</td>
                    <td>3 (1s, 2s, 4s)</td>
                    <td>Rembourser COST_PER_OFFER</td>
                </tr>
                <tr>
                    <td>Phase 2</td>
                    <td>Sauvegarde Ã©choue</td>
                    <td>3 (1s, 2s, 4s)</td>
                    <td>Rembourser COST_PER_OFFER</td>
                </tr>
            </table>
        </div>

        <!-- ========== STRATÃ‰GIE DE CACHE ========== -->
        <h2 class="section-title cache">StratÃ©gie de Cache OpenAI</h2>

        <div class="diagram-container">
            <div class="mermaid">
flowchart LR
    subgraph OFFER1["Offre 1"]
        direction TB
        O1_CLASSIFY["Classification"]

        subgraph O1_WAVE1["Wave 1 â€” Cache A"]
            O1_EXP1["Exp 1"]
            O1_EXP2["Exp 2"]
            O1_PROJ["Proj 1"]
            O1_EXTRA["Extras"]
        end

        subgraph O1_WAVE2["Wave 2 â€” Cache B"]
            O1_SKILLS["Skills"]
            O1_SUMMARY["Summary"]
        end

        O1_CLASSIFY --> O1_WAVE1 --> O1_WAVE2
    end

    subgraph OFFER2["Offre 2"]
        direction TB
        O2_CLASSIFY["Classification"]

        subgraph O2_WAVE1["Wave 1 â€” Cache A"]
            O2_EXP1["Exp 1"]
            O2_EXP2["Exp 2"]
            O2_PROJ["Proj 1"]
            O2_EXTRA["Extras"]
        end

        subgraph O2_WAVE2["Wave 2 â€” Cache B"]
            O2_SKILLS["Skills"]
            O2_SUMMARY["Summary"]
        end

        O2_CLASSIFY --> O2_WAVE1 --> O2_WAVE2
    end

    OFFER1 -->|"SÃ©quentiel"| OFFER2

    style OFFER1 fill:#e3f2fd,stroke:#1976d2
    style OFFER2 fill:#e3f2fd,stroke:#1976d2
    style O1_WAVE1 fill:#e1f5fe,stroke:#0288d1
    style O1_WAVE2 fill:#b2dfdb,stroke:#00897b
    style O2_WAVE1 fill:#e1f5fe,stroke:#0288d1
    style O2_WAVE2 fill:#b2dfdb,stroke:#00897b
            </div>
        </div>

        <div class="note cyan">
            <div class="note-title">ğŸ”µ Pourquoi traitement sÃ©quentiel par offre ?</div>
            <p>Le traitement sÃ©quentiel (offre par offre) plutÃ´t que parallÃ¨le maximise l'efficacitÃ© du <strong>Prompt Caching</strong> d'OpenAI :</p>
            <ul style="margin-left: 20px; margin-top: 8px;">
                <li><strong>Cache A</strong> : Le prÃ©fixe avec l'offre est rÃ©utilisÃ© pour TOUTES les expÃ©riences/projets/extras de cette offre</li>
                <li><strong>Cache B</strong> : Le prÃ©fixe enrichi (offre + rÃ©sultats) est rÃ©utilisÃ© par Skills et Summary</li>
                <li><strong>RÃ©sultat</strong> : ~80% des tokens en cache hit au lieu de cache miss</li>
            </ul>
        </div>

        <!-- ========== TIMELINE ========== -->
        <h2 class="section-title">Timeline exemple (2 offres)</h2>

        <div class="timeline"><span class="header">CrÃ©dits: Solde initial = 10 | COST_PER_OFFER = 2 | Demande = 2 offres</span>

<span class="refund">ğŸ’³ DÃ‰DUCTION: -4 crÃ©dits (2 Ã— 2) â†’ Solde = 6</span>

<span class="phase05">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="phase05">â”‚ OFFRE 1 â€” PHASE 0.5 Classification                                                      â”‚</span>
<span class="phase05">â”‚                                                                                         â”‚</span>
<span class="phase05">â”‚ [ğŸ¤– Classify] â†’ exp1: KEEP, exp2: MOVE_TO_PROJECTS, exp3: REMOVE, proj1: KEEP          â”‚</span>
<span class="phase05">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="phase1">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="phase1">â”‚ OFFRE 1 â€” PHASE 1 Batches                                                               â”‚</span>
<span class="phase1">â”‚                                                                                         â”‚</span>
<span class="phase1">â”‚ <span class="cache">Cache A crÃ©Ã© (offre 1)</span>                                                                  â”‚</span>
<span class="phase1">â”‚                                                                                         â”‚</span>
<span class="phase1">â”‚ Wave 1 (parallÃ¨le):                                                                     â”‚</span>
<span class="phase1">â”‚   â”œâ”€ [ğŸ¤– Exp1]  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚</span>
<span class="phase1">â”‚   â”œâ”€ [ğŸ¤– Proj1] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                                                â”‚</span>
<span class="phase1">â”‚   â”œâ”€ [ğŸ¤– Proj (from exp2)] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚                                                â”‚</span>
<span class="phase1">â”‚   â””â”€ [ğŸ¤– Extras] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚â”‚                                                â”‚</span>
<span class="phase1">â”‚                                     â”‚â”‚â”‚â”‚                                                â”‚</span>
<span class="phase1">â”‚ <span class="cache">Cache B crÃ©Ã© (offre 1 + rÃ©sultats)</span> â†â”´â”´â”´â”˜                                                â”‚</span>
<span class="phase1">â”‚                                                                                         â”‚</span>
<span class="phase1">â”‚ Wave 2 (parallÃ¨le, attend Wave 1):                                                      â”‚</span>
<span class="phase1">â”‚   â”œâ”€ [ğŸ¤– Skills] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚</span>
<span class="phase1">â”‚   â””â”€ [ğŸ¤– Summary] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                                                    â”‚</span>
<span class="phase1">â”‚                                   â”‚â”‚                                                    â”‚</span>
<span class="phase1">â”‚                                   â†“â†“                                                    â”‚</span>
<span class="phase1">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="phase2">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="phase2">â”‚ OFFRE 1 â€” PHASE 2 Recompose                                                             â”‚</span>
<span class="phase2">â”‚                                                                                         â”‚</span>
<span class="phase2">â”‚ [Languages: non mentionnÃ©es] â†’ skip                                                     â”‚</span>
<span class="phase2">â”‚ [ğŸ“„ Assemble] â†’ [âš–ï¸ Diff] â†’ [ğŸ’¾ Save CvFile + CvVersion] â”€â”€â–º âœ… CV 1 PRÃŠT              â”‚</span>
<span class="phase2">â”‚                                                                                         â”‚</span>
<span class="phase2">â”‚ ğŸ“¡ SSE: offer_complete {offerId: 1}                                                     â”‚</span>
<span class="phase2">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="phase05">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="phase05">â”‚ OFFRE 2 â€” PHASE 0.5 Classification                                                      â”‚</span>
<span class="phase05">â”‚                                                                                         â”‚</span>
<span class="phase05">â”‚ [ğŸ¤– Classify] â†’ <span class="error">âŒ Ã‰CHEC</span> â†’ Retry 1 (1s) â†’ <span class="error">âŒ</span> â†’ Retry 2 (2s) â†’ <span class="error">âŒ</span> â†’ Retry 3 (4s) â†’ <span class="error">âŒ</span>   â”‚</span>
<span class="phase05">â”‚                                                                                         â”‚</span>
<span class="phase05">â”‚ <span class="refund">ğŸ’³ Remboursement: +2 crÃ©dits â†’ Solde = 8</span>                                              â”‚</span>
<span class="phase05">â”‚ ğŸ“¡ SSE: offer_failed {offerId: 2, reason: 'Classification failed after 3 retries'}     â”‚</span>
<span class="phase05">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>

<span class="header">â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>
<span class="header">BILAN FINAL</span>
<span class="header">â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</span>

  Offres demandÃ©es:       2
  CV gÃ©nÃ©rÃ©s:             1 (Offre 1)
  Offres Ã©chouÃ©es:        1 (Offre 2)

  CrÃ©dits dÃ©duits:        4 (2 Ã— COST_PER_OFFER)
  CrÃ©dits remboursÃ©s:     2 (1 Ã— COST_PER_OFFER)
  <span class="complete">CoÃ»t final:             2 crÃ©dits</span>
  <span class="complete">Solde final:            8 crÃ©dits</span></div>

        <!-- ========== STRUCTURES DB ========== -->
        <h2 class="section-title">Structures de donnÃ©es</h2>

        <div class="note info">
            <div class="note-title">ğŸ“Š Table: CvGenerationTask</div>
            <code>id</code> | <code>userId</code> | <code>sourceCvFileId</code> â†’ CvFile | <code>status</code> (pending | running | completed | failed) | <code>totalOffers</code> | <code>completedOffers</code> | <code>creditsDebited</code> | <code>creditsRefunded</code> | <code>createdAt</code> | <code>completedAt</code>
        </div>

        <div class="note">
            <div class="note-title">ğŸ“Š Table: CvGenerationOffer</div>
            <code>id</code> | <code>taskId</code> â†’ CvGenerationTask | <code>jobOfferId</code> â†’ JobOffer | <code>status</code> (pending | running | completed | failed) | <code>classificationResult</code> (JSON) | <code>batchResults</code> (JSON) | <code>generatedCvFileId</code> â†’ CvFile | <code>generatedCvFileName</code> | <code>error</code> | <code>refunded</code> (boolean)
        </div>

        <div class="note purple">
            <div class="note-title">ğŸ“Š Table: CvGenerationSubtask</div>
            <code>id</code> | <code>offerId</code> â†’ CvGenerationOffer | <code>type</code> (classify | batch_experience | batch_project | batch_skills | batch_summary | batch_extras | recompose) | <code>status</code> (running | completed | failed) | <code>input</code> (JSON) | <code>output</code> (JSON) | <code>modifications</code> (JSON) | <code>modelUsed</code> | <code>promptTokens</code> | <code>completionTokens</code> | <code>durationMs</code>
        </div>

        <div class="note credits-note">
            <div class="note-title">ğŸ“Š Table: CreditTransaction (existante)</div>
            <code>id</code> | <code>userId</code> | <code>type</code> (DEDUCTION | REFUND | PURCHASE | BONUS) | <code>amount</code> | <code>balanceAfter</code> | <code>reason</code> | <code>createdAt</code>
        </div>

        <!-- ========== FICHIERS CLÃ‰S ========== -->
        <h2 class="section-title">Fichiers clÃ©s du Pipeline V2</h2>

        <table>
            <tr>
                <th>Fichier</th>
                <th>RÃ´le</th>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/orchestrator.js</code></td>
                <td>Orchestration principale, sÃ©quenÃ§age des phases, retry, remboursements</td>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/phases/classify.js</code></td>
                <td>Phase 0.5 : Classification KEEP/REMOVE/MOVE_TO_PROJECTS</td>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/phases/batch-experiences.js</code></td>
                <td>Adaptation parallÃ¨le des expÃ©riences</td>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/phases/batch-projects.js</code></td>
                <td>Adaptation parallÃ¨le des projets + conversion MOVE_TO_PROJECTS</td>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/phases/batch-extras.js</code></td>
                <td>Adaptation des extras (volunteer, hobbies, etc.)</td>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/phases/batch-skills.js</code></td>
                <td>Adaptation des skills avec rÃ¨gles strictes (tools JAMAIS ajoutÃ©s)</td>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/phases/batch-summary.js</code></td>
                <td>GÃ©nÃ©ration du summary avec headline forcÃ© au jobTitle</td>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/phases/recompose.js</code></td>
                <td>Phase 2 : Assemblage final, adaptation languages, sauvegarde</td>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/utils/cacheContext.js</code></td>
                <td>GÃ©nÃ©ration des caches A et B pour optimisation OpenAI</td>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/prompts/*.md</code></td>
                <td>Templates de prompts systÃ¨me/utilisateur pour chaque phase</td>
            </tr>
            <tr>
                <td><code>lib/cv-pipeline-v2/schemas/*.json</code></td>
                <td>JSON Schemas pour Structured Outputs OpenAI</td>
            </tr>
        </table>

        <!-- ========== LÃ‰GENDE ========== -->
        <h2 class="section-title">LÃ©gende</h2>

        <div class="legend">
            <div class="legend-item">
                <span class="legend-icon">ğŸ’³</span>
                <span class="legend-text"><strong>CrÃ©dits</strong> â€” DÃ©duction/Remboursement de COST_PER_OFFER</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">ğŸ·ï¸</span>
                <span class="legend-text"><strong>Classification</strong> â€” Phase 0.5 (KEEP/REMOVE/MOVE)</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">ğŸ¤–</span>
                <span class="legend-text"><strong>IA</strong> â€” Appel API OpenAI</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">âš¡</span>
                <span class="legend-text"><strong>ParallÃ¨le</strong> â€” ExÃ©cution simultanÃ©e (Promise.all)</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">ğŸ”µ</span>
                <span class="legend-text"><strong>Cache A</strong> â€” PrÃ©fixe offre d'emploi</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">ğŸŸ¢</span>
                <span class="legend-text"><strong>Cache B</strong> â€” PrÃ©fixe offre + rÃ©sultats Wave 1</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">ğŸ”„</span>
                <span class="legend-text"><strong>Retry</strong> â€” 3 tentatives (1s, 2s, 4s backoff)</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">ğŸ“„</span>
                <span class="legend-text"><strong>Assemble</strong> â€” Construction CV final</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">âš–ï¸</span>
                <span class="legend-text"><strong>Diff</strong> â€” Comparaison CV original vs gÃ©nÃ©rÃ©</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">ğŸ“¡</span>
                <span class="legend-text"><strong>SSE</strong> â€” Server-Sent Events temps rÃ©el</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">âŒ</span>
                <span class="legend-text"><strong>Ã‰chec</strong> â€” AprÃ¨s 3 retries â†’ remboursement</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon">ğŸ”€</span>
                <span class="legend-text"><strong>MOVE_TO_PROJECTS</strong> â€” Conversion exp â†’ projet</span>
            </div>
        </div>

        <div class="note success">
            <div class="note-title">âœ… Principes clÃ©s du Pipeline V2</div>
            <ul style="margin-left: 20px;">
                <li><strong>L'utilisateur ne paie que pour les CV effectivement gÃ©nÃ©rÃ©s</strong> â€” Tout Ã©chec aprÃ¨s 3 retries dÃ©clenche un remboursement automatique</li>
                <li><strong>Traitement sÃ©quentiel par offre</strong> â€” Maximise le cache OpenAI (~80% de hits)</li>
                <li><strong>ParallÃ©lisation intra-offre</strong> â€” Wave 1 (3 batches) puis Wave 2 (2 batches)</li>
                <li><strong>TraÃ§abilitÃ© complÃ¨te</strong> â€” Chaque modification est enregistrÃ©e avec before/after/reason</li>
                <li><strong>RÃ©silience</strong> â€” 3 retries avec backoff exponentiel (1s, 2s, 4s)</li>
            </ul>
        </div>

    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#e3f2fd',
                primaryTextColor: '#1a1a2e',
                primaryBorderColor: '#1976d2',
                lineColor: '#5c6bc0',
                secondaryColor: '#fff8e1',
                tertiaryColor: '#f3e5f5',
                fontSize: '12px'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                rankSpacing: 50,
                nodeSpacing: 30
            }
        });
    </script>
</body>
</html>
